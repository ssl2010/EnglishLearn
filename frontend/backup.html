<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç³»ç»Ÿç®¡ç†</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <style>
    * { box-sizing: border-box; }
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;margin:0;background:#f6f7fb;color:#1a202c;line-height:1.6}
    .wrap{max-width:1400px;margin:0 auto;padding:32px 24px}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px;padding-bottom:20px;border-bottom:3px solid #e2e8f0}
    .header h1{margin:0;font-size:32px;font-weight:700;display:flex;align-items:center;gap:12px}
    .header h1 .emoji{font-size:36px}
    .tabs{display:flex;gap:8px;margin-bottom:24px;border-bottom:2px solid #e2e8f0}
    .tab{padding:12px 24px;background:transparent;border:0;cursor:pointer;font-size:15px;font-weight:500;color:#64748b;border-bottom:3px solid transparent;margin-bottom:-2px;transition:all 0.2s}
    .tab:hover{color:#0b5fff;background:#f1f5f9}
    .tab.active{color:#0b5fff;border-bottom-color:#0b5fff}
    .tab-content{display:none}
    .tab-content.active{display:block}

    .card{background:#fff;border-radius:16px;padding:24px;box-shadow:0 1px 3px rgba(0,0,0,.1);margin-bottom:24px}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid #f1f5f9}
    .card-title{font-size:20px;font-weight:700;color:#1a202c}
    .card-subtitle{font-size:14px;color:#64748b;margin-top:4px}

    .btn{border:0;border-radius:10px;padding:11px 20px;background:#0b5fff;color:#fff;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s}
    .btn:hover{background:#0847cc;transform:translateY(-1px)}
    .btn.secondary{background:#fff;color:#1a202c;border:1.5px solid #e2e8f0}
    .btn.secondary:hover{background:#f7fafc}
    .btn.danger{background:#dc2626}
    .btn.danger:hover{background:#b91c1c}
    .btn.success{background:#10b981}
    .btn.success:hover{background:#059669}
    .btn-small{padding:8px 14px;font-size:13px}

    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
    .stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border-radius:12px;padding:20px}
    .stat-card.green{background:linear-gradient(135deg,#10b981 0%,#059669 100%)}
    .stat-card.blue{background:linear-gradient(135deg,#0b5fff 0%,#0847cc 100%)}
    .stat-card.orange{background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%)}
    .stat-card.purple{background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%)}
    .stat-label{font-size:13px;opacity:0.9;margin-bottom:8px}
    .stat-value{font-size:32px;font-weight:700}
    .stat-unit{font-size:16px;font-weight:400;margin-left:4px}

    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{padding:14px 12px;text-align:left;border-bottom:1px solid#e2e8f0}
    th{background:#f8fafc;font-weight:600;font-size:13px;color:#64748b;text-transform:uppercase}
    tr:hover{background:#f8fafc}
    .actions{display:flex;gap:8px}

    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center}
    .modal.active{display:flex}
    .modal-content{background:#fff;border-radius:16px;padding:32px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .modal-title{font-size:20px;font-weight:700}
    .close-btn{cursor:pointer;font-size:28px;color:#718096;line-height:1}
    .close-btn:hover{color:#1a202c}

    .form-group{margin-bottom:16px}
    label{display:block;margin-bottom:8px;font-size:13px;font-weight:600;color:#334155}
    input[type="text"],input[type="time"],input[type="number"],textarea,select{width:100%;padding:11px 14px;border-radius:10px;border:1.5px solid #e2e8f0;font-size:14px;font-family:inherit}
    input[type="checkbox"]{margin-right:8px}
    textarea{min-height:80px}

    .checkbox-label{display:flex;align-items:center;padding:12px;background:#f8fafc;border-radius:8px;cursor:pointer;margin-bottom:8px}
    .checkbox-label:hover{background:#f1f5f9}
    .checkbox-label input{cursor:pointer}

    .alert{padding:16px;border-radius:10px;margin-bottom:16px}
    .alert.info{background:#eff6ff;border:1px solid #3b82f6;color:#1e40af}
    .alert.success{background:#d1fae5;border:1px solid #10b981;color:#065f46}
    .alert.warning{background:#fef3c7;border:1px solid #f59e0b;color:#92400e}
    .alert.danger{background:#fee2e2;border:1px solid #dc2626;color:#991b1b}

    .empty{text-align:center;padding:48px;color:#64748b}
    .loading{text-align:center;padding:32px;color:#64748b}
    .progress{margin-top:16px}
    .progress-bar{background:#e2e8f0;border-radius:8px;height:8px;overflow:hidden}
    .progress-fill{background:#0b5fff;height:100%;transition:width 0.3s}

    .info-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
    .info-item{padding:12px;background:#f8fafc;border-radius:8px}
    .info-label{font-size:12px;color:#64748b;margin-bottom:4px}
    .info-value{font-size:16px;font-weight:600;color:#1a202c}

    .help-text{font-size:13px;color:#64748b;margin-top:8px;line-height:1.5}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1><span class="emoji">âš™ï¸</span> ç³»ç»Ÿç®¡ç†</h1>
      <button class="btn secondary" onclick="refreshAll()">ğŸ”„ åˆ·æ–°</button>
    </div>

    <!-- æ ‡ç­¾é¡µ -->
    <div class="tabs">
      <button class="tab active" onclick="showTab('backup')">ğŸ“¦ å¤‡ä»½ç®¡ç†</button>
      <button class="tab" onclick="showTab('settings')">âš™ï¸ ç³»ç»Ÿè®¾ç½®</button>
      <button class="tab" onclick="showTab('system')">ğŸ’» ç³»ç»Ÿä¿¡æ¯</button>
    </div>

    <!-- å¤‡ä»½ç®¡ç†æ ‡ç­¾é¡µ -->
    <div id="backupTab" class="tab-content active">
      <!-- ç»Ÿè®¡å¡ç‰‡ -->
      <div class="stats">
        <div class="stat-card">
          <div class="stat-label">å¤‡ä»½æ€»æ•°</div>
          <div class="stat-value" id="statBackupCount">-</div>
        </div>
        <div class="stat-card green">
          <div class="stat-label">å¤‡ä»½å ç”¨ç©ºé—´</div>
          <div class="stat-value" id="statBackupSize">-</div>
        </div>
        <div class="stat-card blue">
          <div class="stat-label">ç£ç›˜å¯ç”¨ç©ºé—´</div>
          <div class="stat-value" id="statDiskFree">-</div>
        </div>
        <div class="stat-card orange">
          <div class="stat-label">ç£ç›˜ä½¿ç”¨ç‡</div>
          <div class="stat-value"><span id="statDiskUsage">-</span><span class="stat-unit">%</span></div>
        </div>
      </div>

      <!-- æ“ä½œæŒ‰é’® -->
      <div class="card">
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <button class="btn success" onclick="openCreateBackupModal()">+ åˆ›å»ºå¤‡ä»½</button>
          <button class="btn secondary" onclick="cleanupOldBackups()">ğŸ§¹ æ¸…ç†æ—§å¤‡ä»½</button>
        </div>
      </div>

      <!-- å¤‡ä»½åˆ—è¡¨ -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">å¤‡ä»½åˆ—è¡¨</div>
            <div class="card-subtitle">ç‚¹å‡»ä¸‹è½½å¤‡ä»½åˆ°æœ¬åœ°ä¿å­˜</div>
          </div>
        </div>
        <div id="backupList">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- ç³»ç»Ÿè®¾ç½®æ ‡ç­¾é¡µ -->
    <div id="settingsTab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">è‡ªåŠ¨å¤‡ä»½è®¾ç½®</div>
            <div class="card-subtitle">é…ç½®è‡ªåŠ¨å¤‡ä»½,æ— éœ€æ‰‹åŠ¨æ“ä½œ</div>
          </div>
          <button class="btn success" onclick="saveBackupConfig()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="autoBackupEnabled" checked>
            <span><strong>å¯ç”¨è‡ªåŠ¨å¤‡ä»½</strong> - ç³»ç»Ÿå°†æŒ‰ç…§è®¾å®šæ—¶é—´è‡ªåŠ¨åˆ›å»ºå¤‡ä»½</span>
          </label>
        </div>

        <div class="form-group">
          <label>è‡ªåŠ¨å¤‡ä»½æ—¶é—´</label>
          <input type="time" id="autoBackupTime" value="02:00" disabled style="background:#f1f5f9;cursor:not-allowed">
          <div class="help-text" style="margin-top:12px">
            <strong>å½“å‰å¤‡ä»½æ—¶é—´: æ¯å¤©å‡Œæ™¨ 02:00</strong><br>
            æ­¤æ—¶é—´ç”± systemd timer æ§åˆ¶ï¼Œæ— æ³•åœ¨ Web ç•Œé¢ä¿®æ”¹ã€‚å¦‚éœ€æ›´æ”¹ï¼Œè¯·åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š
            <pre style="background:#f8fafc;padding:8px 12px;border-radius:6px;margin:8px 0;font-size:12px;overflow-x:auto">sudo systemctl edit englishlearn-backup.timer</pre>
            åœ¨æ‰“å¼€çš„ç¼–è¾‘å™¨ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼ˆç¤ºä¾‹ï¼šæ”¹ä¸ºæ¯å¤© 03:30ï¼‰ï¼š
            <pre style="background:#f8fafc;padding:8px 12px;border-radius:6px;margin:8px 0;font-size:12px;overflow-x:auto">[Timer]
OnCalendar=*-*-* 03:30:00</pre>
            ä¿å­˜åæ‰§è¡Œï¼š<code style="background:#f8fafc;padding:2px 6px;border-radius:4px">sudo systemctl daemon-reload</code>
          </div>
        </div>

        <div class="form-group">
          <label>å¤‡ä»½ä¿ç•™å¤©æ•°</label>
          <input type="number" id="backupRetentionDays" value="30" min="1" max="365">
          <div class="help-text">è¶…è¿‡æ­¤å¤©æ•°çš„æ—§å¤‡ä»½å°†è¢«è‡ªåŠ¨æ¸…ç†,èŠ‚çœç£ç›˜ç©ºé—´</div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="autoCleanupEnabled" checked>
            <span><strong>è‡ªåŠ¨æ¸…ç†æ—§å¤‡ä»½</strong> - å®šæœŸåˆ é™¤è¿‡æœŸå¤‡ä»½,é‡Šæ”¾ç£ç›˜ç©ºé—´</span>
          </label>
        </div>

        <div class="alert warning">
          <strong>âš ï¸ é‡è¦æç¤º</strong>
          <p style="margin:8px 0 0 0">å»ºè®®å®šæœŸä¸‹è½½å¤‡ä»½åˆ°æœ¬åœ°æˆ–å…¶ä»–å­˜å‚¨è®¾å¤‡,é¿å…æœåŠ¡å™¨æ•…éšœå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚</p>
        </div>
      </div>

      <!-- ç³»ç»Ÿå‡çº§å¡ç‰‡ -->
      <div class="card" style="margin-top:24px">
        <div class="card-header">
          <div>
            <div class="card-title">ç³»ç»Ÿå‡çº§</div>
            <div class="card-subtitle">ä¸€é”®å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬</div>
          </div>
          <button class="btn" onclick="checkUpdate()" id="checkUpdateBtn">ğŸ” æ£€æŸ¥æ›´æ–°</button>
        </div>

        <!-- ç‰ˆæœ¬ä¿¡æ¯ -->
        <div id="versionInfo" class="alert info" style="display:none">
          <strong>ğŸ“Œ å½“å‰ç‰ˆæœ¬</strong>
          <p style="margin:8px 0 0 0">
            åˆ†æ”¯: <code id="currentBranch">-</code><br>
            æäº¤: <code id="currentCommit">-</code>
          </p>
        </div>

        <!-- æ›´æ–°å¯ç”¨æç¤º -->
        <div id="updateAvailable" class="alert success" style="display:none">
          <strong>ğŸ‰ å‘ç°æ–°ç‰ˆæœ¬!</strong>
          <p style="margin:8px 0 0 0">
            æ–°ç‰ˆæœ¬: <code id="remoteCommit">-</code><br>
            <span id="updateMessage">-</span>
          </p>
        </div>

        <!-- å·²æ˜¯æœ€æ–°æç¤º -->
        <div id="noUpdateAvailable" class="alert" style="display:none">
          <strong>âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬</strong>
          <p style="margin:8px 0 0 0">å½“å‰ç³»ç»Ÿå·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€å‡çº§ã€‚</p>
        </div>

        <!-- å‡çº§é€‰é¡¹ -->
        <div id="upgradeOptions" style="display:none;margin-top:16px">
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="autoBackupBeforeUpgrade" checked>
              <span><strong>å‡çº§å‰è‡ªåŠ¨å¤‡ä»½</strong> - å‡çº§å‰åˆ›å»ºç³»ç»Ÿå¤‡ä»½ï¼ˆå¼ºçƒˆæ¨èï¼‰</span>
            </label>
          </div>

          <button class="btn success" onclick="upgradeSystem()" id="upgradeBtn">
            â¬†ï¸ å¼€å§‹å‡çº§
          </button>
        </div>

        <!-- å‡çº§æ—¥å¿— -->
        <div id="upgradeLogContainer" style="display:none;margin-top:16px">
          <strong>å‡çº§æ—¥å¿—:</strong>
          <pre id="upgradeLog" style="background:#f8fafc;padding:12px;border-radius:8px;max-height:300px;overflow-y:auto;font-size:13px;margin-top:8px"></pre>
        </div>

        <div class="alert warning" style="margin-top:16px">
          <strong>âš ï¸ å‡çº§æ³¨æ„äº‹é¡¹</strong>
          <ul style="margin:8px 0 0 0;padding-left:20px">
            <li>å‡çº§è¿‡ç¨‹ä¸­æœåŠ¡ä¼šçŸ­æš‚é‡å¯ï¼ŒæœŸé—´æ— æ³•è®¿é—®</li>
            <li>å‡çº§å‰ä¼šè‡ªåŠ¨åˆ›å»ºå¤‡ä»½ï¼Œç¡®ä¿æ•°æ®å®‰å…¨</li>
            <li>å‡çº§ä»…é€‚ç”¨äºé€šè¿‡ Git éƒ¨ç½²çš„ç³»ç»Ÿ</li>
            <li>å¦‚æœä½¿ç”¨å¼€å‘ç¯å¢ƒï¼Œå‡çº§åéœ€æ‰‹åŠ¨é‡å¯æœåŠ¡</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- ç³»ç»Ÿä¿¡æ¯æ ‡ç­¾é¡µ -->
    <div id="systemTab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-title">ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ</div>
        </div>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">CPU ä½¿ç”¨ç‡</div>
            <div class="info-value" id="cpuUsage">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">å†…å­˜ä½¿ç”¨ç‡</div>
            <div class="info-value" id="memoryUsage">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">ç£ç›˜ä½¿ç”¨ç‡</div>
            <div class="info-value" id="diskUsagePercent">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">æ•°æ®æ€»å¤§å°</div>
            <div class="info-value" id="totalDataSize">-</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">ç³»ç»Ÿè¯¦ç»†ä¿¡æ¯</div>
        </div>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">æ“ä½œç³»ç»Ÿ</div>
            <div class="info-value" id="osInfo">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">ä¸»æœºå</div>
            <div class="info-value" id="hostname">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">Python ç‰ˆæœ¬</div>
            <div class="info-value" id="pythonVersion">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">CPU æ ¸å¿ƒæ•°</div>
            <div class="info-value" id="cpuCount">-</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">å­˜å‚¨è¯¦æƒ…</div>
        </div>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">æ•°æ®åº“å¤§å°</div>
            <div class="info-value" id="dbSize">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">åª’ä½“æ–‡ä»¶å¤§å°</div>
            <div class="info-value" id="mediaSize">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">å†…å­˜æ€»é‡</div>
            <div class="info-value" id="memoryTotal">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">ç£ç›˜æ€»é‡</div>
            <div class="info-value" id="diskTotal">-</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- åˆ›å»ºå¤‡ä»½æ¨¡æ€æ¡† -->
  <div id="createBackupModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">åˆ›å»ºå¤‡ä»½</h3>
        <span class="close-btn" onclick="closeCreateBackupModal()">Ã—</span>
      </div>

      <div class="alert info" style="margin-bottom:16px">
        <strong>ğŸ“¦ å¤‡ä»½å†…å®¹</strong>
        <p style="margin:8px 0 0 0">æ­¤å¤‡ä»½å°†åŒ…å«<strong>æ‰€æœ‰æ•°æ®</strong>:æ•°æ®åº“ã€å­¦ç”Ÿä¿¡æ¯ã€ç»ƒä¹ è®°å½•ã€åª’ä½“æ–‡ä»¶ç­‰ã€‚</p>
      </div>

      <div class="form-group">
        <label>å¤‡ä»½æè¿° (å¯é€‰)</label>
        <textarea id="backupDescription" placeholder="ä¾‹å¦‚ï¼š2026å¹´1æœˆæœˆåº¦å¤‡ä»½"></textarea>
        <div class="help-text">æ·»åŠ æè¿°æœ‰åŠ©äºæ—¥åè¯†åˆ«å¤‡ä»½</div>
      </div>

      <div style="display:flex;gap:12px;justify-content:flex-end">
        <button class="btn secondary" onclick="closeCreateBackupModal()">å–æ¶ˆ</button>
        <button class="btn success" onclick="createBackup()">åˆ›å»ºå¤‡ä»½</button>
      </div>

      <div id="createProgress" class="progress" style="display:none">
        <div class="progress-bar">
          <div class="progress-fill" id="createProgressFill" style="width:0%"></div>
        </div>
        <div style="text-align:center;margin-top:8px;font-size:13px;color:#64748b" id="createProgressText">æ­£åœ¨åˆ›å»ºå¤‡ä»½...</div>
      </div>
    </div>
  </div>

  <!-- æ¢å¤å¤‡ä»½æ¨¡æ€æ¡† -->
  <div id="restoreBackupModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">æ¢å¤ç³»ç»Ÿå¤‡ä»½</h3>
        <span class="close-btn" onclick="closeRestoreBackupModal()">Ã—</span>
      </div>

      <div class="alert danger">
        <strong>âš ï¸ é‡è¦è­¦å‘Š</strong>
        <p style="margin:8px 0 0 0"><strong>æ­¤æ“ä½œå°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®!</strong></p>
        <p style="margin:8px 0 0 0">å»ºè®®å…ˆåˆ›å»ºå½“å‰çŠ¶æ€çš„å¤‡ä»½,ä»¥é˜²æ¢å¤åéœ€è¦å›é€€ã€‚</p>
      </div>

      <div class="alert info" style="margin-top:12px">
        <strong>ğŸ“‹ æ¢å¤è¯´æ˜</strong>
        <p style="margin:8px 0 0 0">ç³»ç»Ÿå°†è‡ªåŠ¨æ¢å¤æ•°æ®åº“å’Œåª’ä½“æ–‡ä»¶,æ¢å¤åè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹æœ€æ–°æ•°æ®ã€‚</p>
      </div>

      <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px">
        <button class="btn secondary" onclick="closeRestoreBackupModal()">å–æ¶ˆ</button>
        <button class="btn danger" onclick="confirmRestore()">ç¡®è®¤æ¢å¤</button>
      </div>
    </div>
  </div>

  <script>
    let currentRestoreFilename = null;

    async function api(url, options = {}) {
      const res = await fetch(url, {
        headers: {'Content-Type': 'application/json'},
        ...options
      });
      if (!res.ok) {
        const error = await res.json().catch(() => ({detail: 'è¯·æ±‚å¤±è´¥'}));
        throw new Error(error.detail || 'è¯·æ±‚å¤±è´¥');
      }
      return res.json();
    }

    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      event.target.classList.add('active');
      document.getElementById(tab + 'Tab').classList.add('active');

      if (tab === 'system') {
        loadSystemInfo();
      } else if (tab === 'settings') {
        loadBackupConfig();
      }
    }

    async function loadStats() {
      try {
        const data = await api('/api/admin/backup/space');
        document.getElementById('statBackupCount').textContent = data.backup_count;
        document.getElementById('statBackupSize').textContent = data.backup_total_size_human;
        document.getElementById('statDiskFree').textContent = data.disk_free_human;
        document.getElementById('statDiskUsage').textContent = data.disk_usage_percent;
      } catch (e) {
        console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', e);
      }
    }

    async function loadBackupList() {
      try {
        const backups = await api('/api/admin/backup/list');
        const container = document.getElementById('backupList');

        if (backups.length === 0) {
          container.innerHTML = '<div class="empty">æš‚æ— å¤‡ä»½<br>ç‚¹å‡»"åˆ›å»ºå¤‡ä»½"æŒ‰é’®å¼€å§‹å¤‡ä»½</div>';
          return;
        }

        const table = `
          <table>
            <thead>
              <tr>
                <th>æ–‡ä»¶å</th>
                <th>å¤§å°</th>
                <th>åˆ›å»ºæ—¶é—´</th>
                <th>æè¿°</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${backups.map(b => `
                <tr>
                  <td style="font-family:monospace;font-size:13px">${b.filename}</td>
                  <td><strong>${b.size_human}</strong></td>
                  <td>${new Date(b.created_at).toLocaleString('zh-CN')}</td>
                  <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis">${b.description || '-'}</td>
                  <td>
                    <div class="actions">
                      <button class="btn btn-small" onclick="downloadBackup('${b.filename}')">â¬‡ï¸ ä¸‹è½½</button>
                      <button class="btn btn-small secondary" onclick="openRestoreBackupModal('${b.filename}')">ğŸ”„ æ¢å¤</button>
                      <button class="btn btn-small danger" onclick="deleteBackup('${b.filename}')">ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

        container.innerHTML = table;
      } catch (e) {
        console.error('åŠ è½½å¤‡ä»½åˆ—è¡¨å¤±è´¥:', e);
        const errorMsg = e.message === 'Not Found'
          ? 'å¤‡ä»½åŠŸèƒ½æœªå°±ç»ªï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ£€æŸ¥ç³»ç»Ÿé…ç½®'
          : e.message;
        document.getElementById('backupList').innerHTML = `<div class="empty" style="color:#dc2626">åŠ è½½å¤±è´¥: ${errorMsg}<br><br>è¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼Œæˆ–è”ç³»ç®¡ç†å‘˜</div>`;
      }
    }

    async function loadBackupConfig() {
      try {
        const config = await api('/api/admin/backup/config');
        document.getElementById('autoBackupEnabled').checked = config.auto_backup_enabled;
        document.getElementById('autoBackupTime').value = config.auto_backup_time;
        document.getElementById('backupRetentionDays').value = config.backup_retention_days;
        document.getElementById('autoCleanupEnabled').checked = config.auto_cleanup_enabled;
      } catch (e) {
        console.error('åŠ è½½é…ç½®å¤±è´¥:', e);
      }
    }

    async function saveBackupConfig() {
      try {
        const config = {
          auto_backup_enabled: document.getElementById('autoBackupEnabled').checked,
          auto_backup_time: document.getElementById('autoBackupTime').value,  // ä¿ç•™ä½†ä¸ä¼šç”Ÿæ•ˆ
          backup_retention_days: parseInt(document.getElementById('backupRetentionDays').value),
          auto_cleanup_enabled: document.getElementById('autoCleanupEnabled').checked
        };

        await api('/api/admin/backup/config', {
          method: 'POST',
          body: JSON.stringify(config)
        });

        alert('âœ… è®¾ç½®å·²ä¿å­˜!\n\næ³¨æ„ï¼šå¤‡ä»½æ—¶é—´ç”±ç³»ç»Ÿå®šæ—¶ä»»åŠ¡æ§åˆ¶ï¼Œå¦‚éœ€ä¿®æ”¹è¯·å‚è€ƒé¡µé¢è¯´æ˜ã€‚');
      } catch (e) {
        alert('âŒ ä¿å­˜å¤±è´¥: ' + e.message);
      }
    }

    async function loadSystemInfo() {
      try {
        const data = await api('/api/admin/backup/system-info');

        // èµ„æºä½¿ç”¨æƒ…å†µ
        document.getElementById('cpuUsage').textContent = `${data.cpu.usage_percent}%`;
        document.getElementById('memoryUsage').textContent = `${data.memory.usage_percent}%`;
        document.getElementById('diskUsagePercent').textContent = `${data.disk.usage_percent}%`;
        document.getElementById('totalDataSize').textContent = data.data.total_data_size_human;

        // ç³»ç»Ÿä¿¡æ¯
        document.getElementById('osInfo').textContent = `${data.system.os} ${data.system.os_version}`;
        document.getElementById('hostname').textContent = data.system.hostname;
        document.getElementById('pythonVersion').textContent = data.system.python_version;
        document.getElementById('cpuCount').textContent = `${data.cpu.count} æ ¸`;

        // å­˜å‚¨è¯¦æƒ…
        document.getElementById('dbSize').textContent = data.data.database_size_human;
        document.getElementById('mediaSize').textContent = data.data.media_size_human;
        document.getElementById('memoryTotal').textContent = data.memory.total_human;
        document.getElementById('diskTotal').textContent = data.disk.total_human;
      } catch (e) {
        console.error('åŠ è½½ç³»ç»Ÿä¿¡æ¯å¤±è´¥:', e);
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        const errorMsg = e.message === 'Not Found'
          ? 'ç³»ç»Ÿä¿¡æ¯åŠŸèƒ½æœªå°±ç»ªï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ£€æŸ¥ç³»ç»Ÿé…ç½®'
          : e.message;
        document.getElementById('cpuUsage').textContent = '-';
        document.getElementById('memoryUsage').textContent = '-';
        document.getElementById('diskUsagePercent').textContent = '-';
        document.getElementById('totalDataSize').textContent = 'åŠ è½½å¤±è´¥';
        alert(`æ— æ³•åŠ è½½ç³»ç»Ÿä¿¡æ¯:\n${errorMsg}\n\nè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼Œæˆ–è”ç³»ç®¡ç†å‘˜`);
      }
    }

    function openCreateBackupModal() {
      document.getElementById('createBackupModal').classList.add('active');
    }

    function closeCreateBackupModal() {
      document.getElementById('createBackupModal').classList.remove('active');
      document.getElementById('createProgress').style.display = 'none';
      document.getElementById('backupDescription').value = '';
    }

    async function createBackup() {
      const description = document.getElementById('backupDescription').value.trim();

      const progress = document.getElementById('createProgress');
      const progressFill = document.getElementById('createProgressFill');
      const progressText = document.getElementById('createProgressText');

      progress.style.display = 'block';
      progressFill.style.width = '30%';
      progressText.textContent = 'æ­£åœ¨åˆ›å»ºå¤‡ä»½...';

      try {
        const data = await api('/api/admin/backup/create', {
          method: 'POST',
          body: JSON.stringify({
            description: description || null
          })
        });

        progressFill.style.width = '100%';
        progressText.textContent = `âœ… å¤‡ä»½åˆ›å»ºæˆåŠŸ! (${data.size_human})`;
        progressText.style.color = '#10b981';

        setTimeout(() => {
          closeCreateBackupModal();
          refreshAll();
        }, 1500);

      } catch (e) {
        progressText.textContent = `âŒ åˆ›å»ºå¤±è´¥: ${e.message}`;
        progressText.style.color = '#dc2626';
      }
    }

    function openRestoreBackupModal(filename) {
      currentRestoreFilename = filename;
      document.getElementById('restoreBackupModal').classList.add('active');
    }

    function closeRestoreBackupModal() {
      document.getElementById('restoreBackupModal').classList.remove('active');
      currentRestoreFilename = null;
    }

    async function confirmRestore() {
      if (!currentRestoreFilename) return;

      if (!confirm(`âš ï¸ è­¦å‘Š: æ­¤æ“ä½œå°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®!\n\nç¡®è®¤è¦ä»ä»¥ä¸‹å¤‡ä»½æ¢å¤å—?\n\n${currentRestoreFilename}\n\nå»ºè®®å…ˆä¸‹è½½å½“å‰çŠ¶æ€çš„å¤‡ä»½å†ç»§ç»­!`)) {
        return;
      }

      try {
        await api('/api/admin/backup/restore', {
          method: 'POST',
          body: JSON.stringify({
            filename: currentRestoreFilename
          })
        });

        alert('âœ… ç³»ç»Ÿæ¢å¤æˆåŠŸ!\n\nè¯·åˆ·æ–°é¡µé¢ä»¥æŸ¥çœ‹æ¢å¤åçš„æ•°æ®ã€‚');
        closeRestoreBackupModal();
        setTimeout(() => window.location.reload(), 1000);

      } catch (e) {
        alert(`âŒ æ¢å¤å¤±è´¥: ${e.message}`);
      }
    }

    function downloadBackup(filename) {
      window.location.href = `/api/admin/backup/download/${filename}`;
    }

    async function deleteBackup(filename) {
      if (!confirm(`ç¡®è®¤è¦åˆ é™¤å¤‡ä»½å—?\n\n${filename}\n\næ­¤æ“ä½œæ— æ³•æ’¤é”€!`)) {
        return;
      }

      try {
        await api(`/api/admin/backup/delete/${filename}`, {method: 'DELETE'});
        alert('âœ… åˆ é™¤æˆåŠŸ');
        refreshAll();
      } catch (e) {
        alert(`âŒ åˆ é™¤å¤±è´¥: ${e.message}`);
      }
    }

    async function cleanupOldBackups() {
      if (!confirm('ç¡®è®¤æ¸…ç† 30 å¤©å‰çš„æ—§å¤‡ä»½å—?\n\næ­¤æ“ä½œæ— æ³•æ’¤é”€!')) {
        return;
      }

      try {
        const data = await api('/api/admin/backup/cleanup?keep_days=30', {method: 'POST'});
        alert(`âœ… æ¸…ç†å®Œæˆ!\n\nåˆ é™¤ ${data.deleted_count} ä¸ªå¤‡ä»½æ–‡ä»¶\né‡Šæ”¾ç©ºé—´ ${data.freed_space_human}`);
        refreshAll();
      } catch (e) {
        alert(`âŒ æ¸…ç†å¤±è´¥: ${e.message}`);
      }
    }

    // ============ ç³»ç»Ÿå‡çº§åŠŸèƒ½ ============

    async function checkUpdate() {
      const btn = document.getElementById('checkUpdateBtn');
      btn.disabled = true;
      btn.textContent = 'ğŸ” æ£€æŸ¥ä¸­...';

      try {
        const status = await api('/api/admin/backup/git-status');

        if (!status.is_git_repo) {
          alert('âš ï¸ å½“å‰ä¸æ˜¯ Git ä»“åº“\n\næ— æ³•ä½¿ç”¨è‡ªåŠ¨å‡çº§åŠŸèƒ½ã€‚\nå¦‚éœ€å‡çº§ï¼Œè¯·æ‰‹åŠ¨éƒ¨ç½²æˆ–é‡æ–°å®‰è£…ã€‚');
          return;
        }

        // æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
        document.getElementById('versionInfo').style.display = 'block';
        document.getElementById('currentBranch').textContent = status.current_branch;
        document.getElementById('currentCommit').textContent = status.current_commit;
        document.getElementById('remoteCommit').textContent = status.remote_commit;
        document.getElementById('updateMessage').textContent = status.message;

        // å¦‚æœ fetch å¤±è´¥ï¼Œæ˜¾ç¤ºè­¦å‘Š
        if (status.fetch_failed) {
          alert(`âš ï¸ æ— æ³•è·å–è¿œç¨‹ä»“åº“æœ€æ–°çŠ¶æ€\n\né”™è¯¯: ${status.fetch_error || 'ç½‘ç»œè¿æ¥å¤±è´¥'}\n\næ˜¾ç¤ºçš„ç‰ˆæœ¬ä¿¡æ¯å¯èƒ½ä¸æ˜¯æœ€æ–°çš„ã€‚\nè¯·æ£€æŸ¥æœåŠ¡å™¨ç½‘ç»œè¿æ¥ï¼Œæˆ–åœ¨æœåŠ¡å™¨ä¸Šæ‰‹åŠ¨æ‰§è¡Œ:\nsudo git -C /opt/EnglishLearn fetch origin main`);
        }

        if (status.update_available) {
          // æœ‰æ–°ç‰ˆæœ¬
          document.getElementById('updateAvailable').style.display = 'block';
          document.getElementById('noUpdateAvailable').style.display = 'none';
          document.getElementById('upgradeOptions').style.display = 'block';
        } else {
          // å·²æ˜¯æœ€æ–°ï¼ˆä½†å¦‚æœ fetch å¤±è´¥ï¼Œå¯èƒ½ä¸å‡†ç¡®ï¼‰
          document.getElementById('updateAvailable').style.display = 'none';
          document.getElementById('noUpdateAvailable').style.display = 'block';
          document.getElementById('noUpdateAvailable').innerHTML = status.fetch_failed
            ? '<strong>âš ï¸ æ— æ³•ç¡®è®¤ç‰ˆæœ¬çŠ¶æ€</strong><p style="margin:8px 0 0 0">æ— æ³•è¿æ¥è¿œç¨‹ä»“åº“ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚</p>'
            : '<strong>âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬</strong><p style="margin:8px 0 0 0">å½“å‰ç³»ç»Ÿå·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€å‡çº§ã€‚</p>';
          document.getElementById('upgradeOptions').style.display = 'none';
        }

      } catch (e) {
        alert(`âŒ æ£€æŸ¥æ›´æ–°å¤±è´¥:\n${e.message}\n\nè¯·ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸`);
      } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ” æ£€æŸ¥æ›´æ–°';
      }
    }

    async function upgradeSystem() {
      if (!confirm('âš ï¸ ç¡®è®¤å‡çº§ç³»ç»Ÿå—?\n\nå‡çº§è¿‡ç¨‹ä¸­æœåŠ¡ä¼šçŸ­æš‚é‡å¯ï¼ŒæœŸé—´æ— æ³•è®¿é—®ã€‚\nå‡çº§å‰ä¼šè‡ªåŠ¨åˆ›å»ºå¤‡ä»½ï¼Œç¡®ä¿æ•°æ®å®‰å…¨ã€‚')) {
        return;
      }

      const btn = document.getElementById('upgradeBtn');
      const logContainer = document.getElementById('upgradeLogContainer');
      const logElement = document.getElementById('upgradeLog');

      btn.disabled = true;
      btn.textContent = 'â¬†ï¸ å‡çº§ä¸­...';
      logContainer.style.display = 'block';
      logElement.textContent = 'æ­£åœ¨å‡†å¤‡å‡çº§...\n';

      try {
        const autoBackup = document.getElementById('autoBackupBeforeUpgrade').checked;

        const data = await api('/api/admin/backup/upgrade', {
          method: 'POST',
          body: JSON.stringify({
            auto_backup: autoBackup,
            skip_pip: false
          })
        });

        // æ˜¾ç¤ºå‡çº§æ—¥å¿—
        logElement.textContent = data.log.join('\n');

        if (data.success) {
          alert(`ğŸ‰ å‡çº§æˆåŠŸ!\n\n${data.message}\n\n${data.note || ''}\n\né¡µé¢å°†åœ¨ 3 ç§’ååˆ·æ–°...`);
          setTimeout(() => {
            window.location.reload();
          }, 3000);
        }

      } catch (e) {
        logElement.textContent += `\n\nâŒ å‡çº§å¤±è´¥: ${e.message}`;
        alert(`âŒ å‡çº§å¤±è´¥:\n${e.message}\n\nè¯·æŸ¥çœ‹å‡çº§æ—¥å¿—äº†è§£è¯¦æƒ…`);
      } finally {
        btn.disabled = false;
        btn.textContent = 'â¬†ï¸ å¼€å§‹å‡çº§';
      }
    }

    async function refreshAll() {
      await Promise.all([loadStats(), loadBackupList()]);
    }

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
    window.addEventListener('DOMContentLoaded', () => {
      try {
        if (window.self !== window.top) {
          window.parent.postMessage({type: 'appPage', page: 'backup.html'}, '*');
        }
      } catch (e) {}

      refreshAll();
      loadBackupConfig();
    });
  </script>
</body>
</html>
