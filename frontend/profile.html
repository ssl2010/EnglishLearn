<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å­¦ç”Ÿç®¡ç†</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --primary:#0f172a;
      --primary-soft:#f1f5f9;
      --danger:#dc2626;
      --shadow:0 8px 24px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1280px;margin:0 auto;padding:28px 24px 40px}
    .page-header{display:flex;justify-content:space-between;align-items:flex-end;gap:16px;margin-bottom:12px}
    .page-header h1{margin:0;font-size:24px}
    .toolbar{display:flex;align-items:center;gap:10px}
    .btn{border:1px solid var(--line);background:#fff;color:var(--text);padding:9px 14px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.ghost{background:var(--primary-soft);border-color:transparent}
    .btn.danger{color:#fff;background:var(--danger);border-color:var(--danger)}
    .btn.small{padding:6px 10px;font-size:12px;border-radius:8px}
    .panel{background:var(--card);border-radius:16px;border:1px solid #e9edf4;box-shadow:var(--shadow);padding:18px}
    .panel + .panel{margin-top:16px}
    .panel-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .panel-header h2{margin:0;font-size:16px}
    .subtext{color:var(--muted);font-size:12px}
    .status{font-size:12px;min-height:16px;margin-top:8px}
    .status.error{color:var(--danger)}
    .status.success{color:#059669}
    .form-grid{display:grid;grid-template-columns:2fr 1fr 1fr;gap:12px;align-items:end}
    label{display:block;margin-bottom:6px;font-size:12px;color:#334155}
    input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);font-size:14px}
    .form-actions{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid #edf1f7;font-size:13px;text-align:left}
    th{color:#475569;font-weight:600;font-size:12px}
    tr.active{background:var(--primary-soft)}
    .tag{display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;background:var(--primary-soft);font-size:12px;color:#1e293b}
    .avatar{display:inline-flex;align-items:center;gap:6px}
    .avatar-img{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid var(--line);background:#fff}
    .actions{display:flex;gap:6px}
    .empty{padding:16px;border:1px dashed var(--line);border-radius:12px;color:var(--muted);font-size:13px;text-align:center}
    .editor-row td{background:#fbfcfe}
    .editor{padding:16px;border:1px solid var(--line);border-radius:14px;background:#fff;box-shadow:0 6px 16px rgba(15,23,42,.05)}
    .editor-header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;padding-bottom:12px;border-bottom:1px solid var(--line);margin-bottom:12px}
    .editor-title{font-size:14px;font-weight:700}
    .editor-meta{font-size:12px;color:var(--muted);margin-top:2px}
    .editor-layout{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
    .editor-section{border:1px solid var(--line);border-radius:12px;padding:12px;background:#f8fafc}
    .editor-section-title{font-size:12px;font-weight:700;color:#1e293b;margin-bottom:10px}
    .editor-fields{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .editor-field{display:flex;flex-direction:column;gap:6px}
    .editor-field.full{grid-column:1 / -1}
    .editor-section .avatar-picker + .editor-field{margin-top:10px}
    .editor-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:12px;flex-wrap:wrap}
    .editor .avatar-picker{gap:6px}
    .editor .avatar-option{min-width:96px;padding:6px 8px;border-radius:10px;font-size:12px}
    .editor .avatar-thumb{width:24px;height:24px;font-size:14px}
    .upload-note{font-size:12px;color:var(--muted);margin-top:6px}
    .avatar-picker{display:flex;flex-wrap:wrap;gap:8px}
    .avatar-option{border:1px solid var(--line);background:#fff;border-radius:12px;padding:6px 10px;display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:var(--text);min-width:110px}
    .avatar-option.active{border-color:var(--primary);box-shadow:0 0 0 2px rgba(15,23,42,.08)}
    .avatar-thumb{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#fff;border:1px solid var(--line);font-size:16px;overflow:hidden}
    .avatar-thumb img{width:100%;height:100%;object-fit:cover}
    .hidden{display:none}
    body.embedded .page-header{display:none}
    @media (max-width: 900px){
      .form-grid{grid-template-columns:1fr}
      .editor-layout{grid-template-columns:1fr}
      .editor-fields{grid-template-columns:1fr}
      .page-header{flex-direction:column;align-items:flex-start}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="page-header">
      <div>
        <h1>å­¦ç”Ÿç®¡ç†</h1>
      </div>
    </div>

    <div id="pageStatus" class="status"></div>

    <section id="createPanel" class="panel hidden">
      <div class="panel-header">
        <div>
          <h2>æ–°å»ºå­¦ç”Ÿ</h2>
          <div class="subtext">å¡«å†™åŸºæœ¬ä¿¡æ¯åä¿å­˜</div>
        </div>
        <button id="closeCreateBtn" class="btn ghost">æ”¶èµ·</button>
      </div>
      <div class="form-grid">
        <div>
          <label>å§“å</label>
          <input id="createNameInput" placeholder="è¯·è¾“å…¥å§“å" />
        </div>
        <div>
          <label>å¹´çº§</label>
          <select id="createGradeSelect"></select>
        </div>
        <div>
          <label>å¤´åƒ</label>
          <div id="createAvatarPicker" class="avatar-picker"></div>
          <input type="hidden" id="createAvatarValue" value="rabbit" />
        </div>
      </div>
      <div style="margin-top:12px">
        <label>è‡ªå®šä¹‰å¤´åƒï¼ˆå¯é€‰ï¼‰</label>
        <input id="createAvatarFile" type="file" accept="image/*" />
        <div class="upload-note">æ”¯æŒ jpg/png/webpï¼Œä¸Šä¼ åä¼šè¦†ç›–é»˜è®¤å¤´åƒã€‚</div>
      </div>
      <div class="form-actions">
        <button id="createSaveBtn" class="btn primary">ä¿å­˜</button>
        <button id="createResetBtn" class="btn">æ¸…ç©º</button>
      </div>
      <div id="createStatus" class="status"></div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <div>
          <h2>å­¦ç”Ÿåˆ—è¡¨</h2>
          <div class="subtext">å…± <span id="studentCount">0</span> åå­¦ç”Ÿ</div>
        </div>
      </div>
      <div id="emptyState" class="empty hidden">æš‚æ— å­¦ç”Ÿï¼Œè¯·å…ˆæ·»åŠ å­¦ç”Ÿã€‚</div>
      <table>
        <thead>
          <tr>
            <th style="width:90px">ç³»ç»Ÿç¼–å·</th>
            <th>å§“å</th>
            <th style="width:140px">å¹´çº§</th>
            <th style="width:140px">å¤´åƒ</th>
            <th style="width:120px">æ›´æ–°æ—¶é—´</th>
            <th style="width:140px">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="studentTableBody"></tbody>
      </table>
    </section>
  </div>

  <script>
    const AVATARS = [
      {id: 'rabbit', name: 'å…”å­', emoji: 'ğŸ°'},
      {id: 'fox', name: 'ç‹ç‹¸', emoji: 'ğŸ¦Š'},
      {id: 'lion', name: 'ç‹®å­', emoji: 'ğŸ¦'},
      {id: 'tiger', name: 'è€è™', emoji: 'ğŸ¯'},
      {id: 'panda', name: 'ç†ŠçŒ«', emoji: 'ğŸ¼'},
      {id: 'koala', name: 'è€ƒæ‹‰', emoji: 'ğŸ¨'},
      {id: 'dog', name: 'å°ç‹—', emoji: 'ğŸ¶'},
      {id: 'cat', name: 'å°çŒ«', emoji: 'ğŸ±'}
    ];

    const GRADES = [
      {code: '', label: 'æœªè®¾ç½®'},
      {code: 'K1', label: 'å¹¼å„¿å›­ å°ç­'},
      {code: 'K2', label: 'å¹¼å„¿å›­ ä¸­ç­'},
      {code: 'K3', label: 'å¹¼å„¿å›­ å¤§ç­'},
      {code: 'G1', label: 'å°å­¦ ä¸€å¹´çº§'},
      {code: 'G2', label: 'å°å­¦ äºŒå¹´çº§'},
      {code: 'G3', label: 'å°å­¦ ä¸‰å¹´çº§'},
      {code: 'G4', label: 'å°å­¦ å››å¹´çº§'},
      {code: 'G5', label: 'å°å­¦ äº”å¹´çº§'},
      {code: 'G6', label: 'å°å­¦ å…­å¹´çº§'},
      {code: 'G7', label: 'åˆä¸­ åˆä¸€'},
      {code: 'G8', label: 'åˆä¸­ åˆäºŒ'},
      {code: 'G9', label: 'åˆä¸­ åˆä¸‰'},
      {code: 'G10', label: 'é«˜ä¸­ é«˜ä¸€'},
      {code: 'G11', label: 'é«˜ä¸­ é«˜äºŒ'},
      {code: 'G12', label: 'é«˜ä¸­ é«˜ä¸‰'}
    ];

    const AVATAR_MAP = Object.fromEntries(AVATARS.map(a => [a.id, a]));
    const GRADE_MAP = Object.fromEntries(GRADES.map(g => [g.code, g.label]));

    const state = {
      students: [],
      activeId: null
    };

    try{
      if(window.self !== window.top){
        document.body.classList.add('embedded');
      }
    }catch(e){}

    function apiJSON(path, opts){
      return fetch(path, Object.assign({headers:{'Content-Type':'application/json'}}, opts || {}))
        .then(async res => {
          if(!res.ok){
            const data = await res.json().catch(() => ({}));
            throw new Error(data.detail || 'è¯·æ±‚å¤±è´¥');
          }
          return res.json();
        });
    }

    function formatDate(value){
      if(!value) return '-';
      const text = String(value);
      return text.split('T')[0] || text;
    }

    function setStatus(text, type){
      const el = document.getElementById('pageStatus');
      el.textContent = text || '';
      el.className = 'status' + (type ? ' ' + type : '');
    }

    function setCreateStatus(text, type){
      const el = document.getElementById('createStatus');
      el.textContent = text || '';
      el.className = 'status' + (type ? ' ' + type : '');
    }

    function isCustomAvatar(value){
      return value && !AVATAR_MAP[value];
    }

    function getAvatarUrl(value){
      if(!value) return '';
      if(value.startsWith('http') || value.startsWith('/media/')){
        return value;
      }
      return `/media/${value}`;
    }

    function setAvatarSelection(container, value){
      container.dataset.value = value;
      container.querySelectorAll('.avatar-option').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.value === value);
      });
      const target = container.dataset.targetInput;
      if(target){
        const input = document.getElementById(target);
        if(input){
          input.value = value;
        }
      }
    }

    function getAvatarSelection(container){
      return container.dataset.value || 'rabbit';
    }

    function updateCustomPreview(container, previewUrl){
      const customBtn = container.querySelector('[data-role=\"custom\"]');
      if(!customBtn) return;
      const thumb = customBtn.querySelector('.avatar-thumb');
      thumb.innerHTML = '';
      if(previewUrl){
        const img = document.createElement('img');
        img.src = previewUrl;
        thumb.appendChild(img);
      }else{
        thumb.textContent = 'ğŸ–¼ï¸';
      }
      if(container.dataset.previewUrl){
        URL.revokeObjectURL(container.dataset.previewUrl);
      }
      if(previewUrl && previewUrl.startsWith('blob:')){
        container.dataset.previewUrl = previewUrl;
      }else{
        container.dataset.previewUrl = '';
      }
    }

    function buildAvatarOption({value, label, emoji, imgUrl, isCustom}, container){
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'avatar-option';
      btn.dataset.value = value;
      if(isCustom){
        btn.dataset.role = 'custom';
      }
      const thumb = document.createElement('span');
      thumb.className = 'avatar-thumb';
      if(imgUrl){
        const img = document.createElement('img');
        img.src = imgUrl;
        thumb.appendChild(img);
      }else{
        thumb.textContent = emoji || 'ğŸ–¼ï¸';
      }
      const text = document.createElement('span');
      text.textContent = label;
      btn.appendChild(thumb);
      btn.appendChild(text);
      btn.addEventListener('click', () => {
        setAvatarSelection(container, value);
      });
      return btn;
    }

    function renderAvatarPicker(container, value, targetInputId){
      const currentValue = value || 'rabbit';
      if(container.dataset.previewUrl){
        URL.revokeObjectURL(container.dataset.previewUrl);
        container.dataset.previewUrl = '';
      }
      container.innerHTML = '';
      if(targetInputId){
        container.dataset.targetInput = targetInputId;
      }
      AVATARS.forEach(avatar => {
        const btn = buildAvatarOption({
          value: avatar.id,
          label: avatar.name,
          emoji: avatar.emoji
        }, container);
        container.appendChild(btn);
      });
      const customValue = isCustomAvatar(currentValue) ? currentValue : '__custom__';
      const customUrl = isCustomAvatar(currentValue) ? getAvatarUrl(currentValue) : '';
      const customBtn = buildAvatarOption({
        value: customValue,
        label: 'è‡ªå®šä¹‰',
        emoji: 'ğŸ–¼ï¸',
        imgUrl: customUrl,
        isCustom: true
      }, container);
      container.appendChild(customBtn);
      setAvatarSelection(container, isCustomAvatar(currentValue) ? customValue : currentValue);
    }

    function buildSelect(options, value){
      const select = document.createElement('select');
      options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.code || opt.id || '';
        option.textContent = opt.label || `${opt.emoji || ''} ${opt.name || ''}`.trim();
        select.appendChild(option);
      });
      select.value = value || '';
      return select;
    }

    async function uploadAvatar(studentId, file){
      const form = new FormData();
      form.append('file', file);
      const res = await fetch(`/api/students/${studentId}/avatar`, {method: 'POST', body: form});
      if(!res.ok){
        const data = await res.json().catch(() => ({}));
        throw new Error(data.detail || 'å¤´åƒä¸Šä¼ å¤±è´¥');
      }
      return res.json();
    }

    function renderCreateSelects(){
      const gradeSelect = document.getElementById('createGradeSelect');
      gradeSelect.innerHTML = '';
      GRADES.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g.code;
        opt.textContent = g.label;
        gradeSelect.appendChild(opt);
      });
      renderAvatarPicker(document.getElementById('createAvatarPicker'), 'rabbit', 'createAvatarValue');
    }

    function openCreatePanel(){
      document.getElementById('createPanel').classList.remove('hidden');
      setCreateStatus('');
    }

    function closeCreatePanel(){
      document.getElementById('createPanel').classList.add('hidden');
      setCreateStatus('');
    }

    function getCfg(){
      const raw = localStorage.getItem('el_cfg');
      return raw ? JSON.parse(raw) : {};
    }

    function updateCfg(student){
      if(!student) return;
      const cfg = getCfg();
      if(cfg.student_id === student.id){
        cfg.student_name = student.name;
        cfg.grade_code = student.grade || '';
        localStorage.setItem('el_cfg', JSON.stringify(cfg));
      }
    }

    function clearCfgIfDeleted(studentId){
      const cfg = getCfg();
      if(cfg.student_id === studentId){
        localStorage.removeItem('el_cfg');
      }
    }

    function toggleEditor(studentId){
      state.activeId = state.activeId === studentId ? null : studentId;
      renderTable();
      setStatus('');
    }

    function renderTable(){
      const body = document.getElementById('studentTableBody');
      const empty = document.getElementById('emptyState');
      body.innerHTML = '';
      document.getElementById('studentCount').textContent = String(state.students.length);
      if(state.students.length === 0){
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');
      state.students.forEach(student => {
        const tr = document.createElement('tr');
        if(student.id === state.activeId){
          tr.classList.add('active');
        }
        tr.addEventListener('click', () => toggleEditor(student.id));

        const idTd = document.createElement('td');
        idTd.textContent = String(student.id);

        const nameTd = document.createElement('td');
        nameTd.textContent = student.name || '-';

        const gradeTd = document.createElement('td');
        const gradeLabel = GRADE_MAP[student.grade || ''] || student.grade || 'æœªè®¾ç½®';
        const gradeTag = document.createElement('span');
        gradeTag.className = 'tag';
        gradeTag.textContent = gradeLabel;
        gradeTd.appendChild(gradeTag);

      const avatarTd = document.createElement('td');
      const avatarValue = student.avatar || 'rabbit';
      if(isCustomAvatar(avatarValue)){
        const img = document.createElement('img');
        img.className = 'avatar-img';
        img.src = getAvatarUrl(avatarValue);
        img.alt = 'è‡ªå®šä¹‰å¤´åƒ';
        avatarTd.appendChild(img);
      }else{
        const avatar = AVATAR_MAP[avatarValue] || AVATAR_MAP.rabbit;
        const avatarWrap = document.createElement('span');
        avatarWrap.className = 'avatar';
        avatarWrap.textContent = avatar ? `${avatar.emoji} ${avatar.name}` : '-';
        avatarTd.appendChild(avatarWrap);
      }

        const updatedTd = document.createElement('td');
        updatedTd.textContent = formatDate(student.updated_at || student.created_at);

        const actionsTd = document.createElement('td');
        const actions = document.createElement('div');
        actions.className = 'actions';

        const editBtn = document.createElement('button');
        editBtn.className = 'btn small ghost';
        editBtn.textContent = student.id === state.activeId ? 'æ”¶èµ·' : 'ç¼–è¾‘';
        editBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleEditor(student.id);
        });

        const delBtn = document.createElement('button');
        delBtn.className = 'btn small danger';
        delBtn.textContent = 'åˆ é™¤';
        delBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteStudent(student.id);
        });

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);
        actionsTd.appendChild(actions);

        tr.appendChild(idTd);
        tr.appendChild(nameTd);
        tr.appendChild(gradeTd);
        tr.appendChild(avatarTd);
        tr.appendChild(updatedTd);
        tr.appendChild(actionsTd);
        body.appendChild(tr);

        if(student.id === state.activeId){
          body.appendChild(buildEditorRow(student));
        }
      });
    }

    function buildEditorRow(student){
      const tr = document.createElement('tr');
      tr.className = 'editor-row';
      const td = document.createElement('td');
      td.colSpan = 6;

      const wrapper = document.createElement('div');
      wrapper.className = 'editor';

      const header = document.createElement('div');
      header.className = 'editor-header';
      const headerMain = document.createElement('div');
      const headerTitle = document.createElement('div');
      headerTitle.className = 'editor-title';
      headerTitle.textContent = 'ç¼–è¾‘å­¦ç”Ÿä¿¡æ¯';
      const headerMeta = document.createElement('div');
      headerMeta.className = 'editor-meta';
      headerMeta.textContent = `å­¦ç”ŸID #${student.id} Â· æœ€è¿‘æ›´æ–° ${formatDate(student.updated_at || student.created_at)}`;
      headerMain.appendChild(headerTitle);
      headerMain.appendChild(headerMeta);
      header.appendChild(headerMain);

      const layout = document.createElement('div');
      layout.className = 'editor-layout';

      const infoSection = document.createElement('div');
      infoSection.className = 'editor-section';
      const infoTitle = document.createElement('div');
      infoTitle.className = 'editor-section-title';
      infoTitle.textContent = 'åŸºæœ¬ä¿¡æ¯';
      const infoFields = document.createElement('div');
      infoFields.className = 'editor-fields';

      const nameWrap = document.createElement('div');
      nameWrap.className = 'editor-field';
      const nameLabel = document.createElement('label');
      nameLabel.textContent = 'å§“å';
      const nameInput = document.createElement('input');
      nameInput.value = student.name || '';
      nameWrap.appendChild(nameLabel);
      nameWrap.appendChild(nameInput);

      const gradeWrap = document.createElement('div');
      gradeWrap.className = 'editor-field';
      const gradeLabel = document.createElement('label');
      gradeLabel.textContent = 'å¹´çº§';
      const gradeSelect = buildSelect(GRADES, student.grade || '');
      gradeWrap.appendChild(gradeLabel);
      gradeWrap.appendChild(gradeSelect);

      infoFields.appendChild(nameWrap);
      infoFields.appendChild(gradeWrap);
      infoSection.appendChild(infoTitle);
      infoSection.appendChild(infoFields);

      const avatarSection = document.createElement('div');
      avatarSection.className = 'editor-section';
      const avatarTitle = document.createElement('div');
      avatarTitle.className = 'editor-section-title';
      avatarTitle.textContent = 'å¤´åƒè®¾ç½®';
      const avatarPicker = document.createElement('div');
      avatarPicker.className = 'avatar-picker';
      renderAvatarPicker(avatarPicker, student.avatar || 'rabbit');

      const uploadWrap = document.createElement('div');
      uploadWrap.className = 'editor-field full';
      const uploadLabel = document.createElement('label');
      uploadLabel.textContent = 'è‡ªå®šä¹‰å¤´åƒï¼ˆå¯é€‰ï¼‰';
      const avatarFile = document.createElement('input');
      avatarFile.type = 'file';
      avatarFile.accept = 'image/*';
      const uploadNote = document.createElement('div');
      uploadNote.className = 'upload-note';
      uploadNote.textContent = 'æ”¯æŒ jpg/png/webpï¼Œä¸Šä¼ åä¼šè¦†ç›–é»˜è®¤å¤´åƒã€‚';
      uploadWrap.appendChild(uploadLabel);
      uploadWrap.appendChild(avatarFile);
      uploadWrap.appendChild(uploadNote);
      avatarFile.addEventListener('change', () => {
        if(avatarFile.files && avatarFile.files[0]){
          const url = URL.createObjectURL(avatarFile.files[0]);
          updateCustomPreview(avatarPicker, url);
          setAvatarSelection(avatarPicker, '__custom__');
        }
      });

      avatarSection.appendChild(avatarTitle);
      avatarSection.appendChild(avatarPicker);
      avatarSection.appendChild(uploadWrap);

      layout.appendChild(infoSection);
      layout.appendChild(avatarSection);

      const actions = document.createElement('div');
      actions.className = 'editor-actions';

      const saveBtn = document.createElement('button');
      saveBtn.className = 'btn primary';
      saveBtn.textContent = 'ä¿å­˜';
      saveBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const name = nameInput.value.trim();
        const grade = gradeSelect.value;
        let avatar = getAvatarSelection(avatarPicker);
        if(!name){
          setStatus('è¯·è¾“å…¥å§“å', 'error');
          return;
        }
        if(avatar === '__custom__' && !(avatarFile.files && avatarFile.files[0])){
          setStatus('è¯·ä¸Šä¼ è‡ªå®šä¹‰å¤´åƒ', 'error');
          return;
        }
        try{
          setStatus('');
          if(avatarFile.files && avatarFile.files[0]){
            const uploadRes = await uploadAvatar(student.id, avatarFile.files[0]);
            avatar = uploadRes.avatar;
          }
          const res = await apiJSON(`/api/students/${student.id}`, {
            method: 'PUT',
            body: JSON.stringify({name, grade, avatar})
          });
          updateCfg(res);
          setStatus('å­¦ç”Ÿä¿¡æ¯å·²æ›´æ–°', 'success');
          await loadStudents();
        }catch(err){
          setStatus(err.message, 'error');
        }
      });

      const resetBtn = document.createElement('button');
      resetBtn.className = 'btn ghost';
      resetBtn.textContent = 'é‡ç½®';
      resetBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        nameInput.value = student.name || '';
        gradeSelect.value = student.grade || '';
        renderAvatarPicker(avatarPicker, student.avatar || 'rabbit');
        avatarFile.value = '';
      });

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn ghost';
      cancelBtn.textContent = 'æ”¶èµ·';
      cancelBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        state.activeId = null;
        renderTable();
      });

      actions.appendChild(saveBtn);
      actions.appendChild(resetBtn);
      actions.appendChild(cancelBtn);

      wrapper.appendChild(header);
      wrapper.appendChild(layout);
      wrapper.appendChild(actions);
      td.appendChild(wrapper);
      tr.appendChild(td);
      return tr;
    }

    async function loadStudents(){
      const res = await apiJSON('/api/students');
      state.students = res.students || [];
      if(state.activeId && !state.students.some(s => s.id === state.activeId)){
        state.activeId = null;
      }
      renderTable();
    }

    async function deleteStudent(studentId){
      const student = state.students.find(s => s.id === studentId);
      if(!student) return;
      if(!window.confirm(`ç¡®è®¤åˆ é™¤å­¦ç”Ÿâ€œ${student.name}â€ï¼Ÿåˆ é™¤åå°†åŒæ­¥ç§»é™¤ç›¸å…³ç»ƒä¹ è®°å½•ã€‚`)){
        return;
      }
      try{
        setStatus('');
        await apiJSON(`/api/students/${studentId}`, {method: 'DELETE'});
        clearCfgIfDeleted(studentId);
        if(state.activeId === studentId){
          state.activeId = null;
        }
        setStatus('å­¦ç”Ÿå·²åˆ é™¤', 'success');
        await loadStudents();
      }catch(e){
        setStatus(e.message, 'error');
      }
    }

    window.addEventListener('message', (event) => {
      if(event.source !== window.parent){
        return;
      }
      if(window.location.origin !== 'null' && event.origin !== window.location.origin){
        return;
      }
      if(event.data && event.data.type === 'openCreateStudent'){
        openCreatePanel();
        setStatus('');
        window.scrollTo({top: 0, behavior: 'smooth'});
      }
    });

    document.getElementById('closeCreateBtn').addEventListener('click', () => {
      closeCreatePanel();
    });

    document.getElementById('createAvatarFile').addEventListener('change', (e) => {
      const picker = document.getElementById('createAvatarPicker');
      const file = e.target.files && e.target.files[0];
      if(file){
        const url = URL.createObjectURL(file);
        updateCustomPreview(picker, url);
        setAvatarSelection(picker, '__custom__');
      }
    });

    document.getElementById('createResetBtn').addEventListener('click', () => {
      document.getElementById('createNameInput').value = '';
      document.getElementById('createGradeSelect').value = '';
      renderAvatarPicker(document.getElementById('createAvatarPicker'), 'rabbit', 'createAvatarValue');
      document.getElementById('createAvatarFile').value = '';
      setCreateStatus('');
    });

    document.getElementById('createSaveBtn').addEventListener('click', async () => {
      const name = document.getElementById('createNameInput').value.trim();
      const grade = document.getElementById('createGradeSelect').value;
      const avatarPicker = document.getElementById('createAvatarPicker');
      let avatar = getAvatarSelection(avatarPicker);
      const avatarFile = document.getElementById('createAvatarFile').files[0];
      if(!name){
        setCreateStatus('è¯·è¾“å…¥å§“å', 'error');
        return;
      }
      if(avatar === '__custom__' && !avatarFile){
        setCreateStatus('è¯·ä¸Šä¼ è‡ªå®šä¹‰å¤´åƒ', 'error');
        return;
      }
      try{
        setCreateStatus('');
        const res = await apiJSON('/api/students', {
          method: 'POST',
          body: JSON.stringify({name, grade, avatar: avatar === '__custom__' ? 'rabbit' : avatar})
        });
        if(avatarFile){
          await uploadAvatar(res.student_id, avatarFile);
        }
        setCreateStatus('å­¦ç”Ÿåˆ›å»ºæˆåŠŸ', 'success');
        document.getElementById('createNameInput').value = '';
        document.getElementById('createGradeSelect').value = '';
        renderAvatarPicker(document.getElementById('createAvatarPicker'), 'rabbit', 'createAvatarValue');
        document.getElementById('createAvatarFile').value = '';
        state.activeId = res.student_id || null;
        await loadStudents();
      }catch(e){
        setCreateStatus(e.message, 'error');
      }
    });

    renderCreateSelects();
    loadStudents();
  </script>
</body>
</html>
