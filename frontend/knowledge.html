<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å­¦ä¹ åº“ç®¡ç†</title>
  <style>
    * { box-sizing: border-box; }
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;margin:0;background:#f6f7fb;color:#1a202c;line-height:1.5}
    .wrap{max-width:1200px;margin:0 auto;padding:32px 24px}
    .card{background:#fff;border-radius:16px;padding:32px;box-shadow:0 1px 3px rgba(0,0,0,.1),0 1px 2px rgba(0,0,0,.06);margin-bottom:24px}
    a{color:#0b5fff;text-decoration:none;transition:color 0.2s}
    a:hover{color:#0847cc}

    button{border:0;border-radius:10px;padding:11px 20px;background:#1a202c;color:#fff;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s;line-height:1.5}
    button:hover{background:#2d3748;transform:translateY(-1px);box-shadow:0 4px 6px rgba(0,0,0,.1)}
    button:active{transform:translateY(0)}
    button.secondary{background:#fff;color:#1a202c;border:1.5px solid #e2e8f0}
    button.secondary:hover{background:#f7fafc;border-color:#cbd5e0}
    button.danger{background:#dc2626;color:#fff}
    button.danger:hover{background:#b91c1c}
    button.small{padding:6px 12px;font-size:13px}

    .muted{color:#718096;font-size:13px}

    .badge{
      display:inline-block;
      padding:3px 10px;
      border-radius:12px;
      font-size:11px;
      font-weight:600;
      letter-spacing:0.02em;
    }
    .badge.system{background:#dbeafe;color:#1e40af}
    .badge.custom{background:#fef3c7;color:#92400e}
    .badge.word{background:#dcfce7;color:#166534}
    .badge.phrase{background:#fef3c7;color:#92400e}
    .badge.sentence{background:#dbeafe;color:#1e40af}

    .mastery-table{width:100%;border-collapse:collapse;margin-top:10px}
    .mastery-table th,.mastery-table td{padding:8px;text-align:left;border-bottom:1px solid #eee}
    .mastery-table th{background:#f8f9fa;font-weight:500;font-size:12px;color:#4a5568}
    .mastery-table td{font-size:13px}
    .tabs{display:flex;gap:4px;margin-bottom:12px;border-bottom:2px solid #e5e7eb;overflow-x:auto;flex-wrap:wrap}
    .tab{padding:8px 14px;cursor:pointer;border:none;background:none;color:#6b7280;font-size:12px;font-weight:600;border-bottom:2px solid transparent;margin-bottom:-2px;white-space:nowrap;transition:all 0.2s}
    .tab:hover{color:#1a202c;background:#f7fafc}
    .tab.active{color:#0b5fff;border-bottom-color:#0b5fff}

    /* Page Header */
    .page-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:8px;
      flex-wrap:wrap;
      gap:16px;
    }
    .page-header h2{
      margin:0;
      font-size:28px;
      font-weight:700;
      color:#1a202c;
    }

    /* Section Headers */
    .section-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:24px;
    }
    .section-header h3{
      margin:0;
      font-size:20px;
      font-weight:700;
      color:#1a202c;
    }

    /* Learning Base Item */
    .learning-base-item{
      border:1.5px solid #e2e8f0;
      border-radius:12px;
      padding:24px;
      margin-bottom:20px;
      transition:all 0.2s;
    }
    .learning-base-item:hover{
      border-color:#cbd5e0;
      box-shadow:0 4px 6px rgba(0,0,0,.05);
    }

    .base-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:16px;
      gap:16px;
    }
    .base-title{
      font-weight:600;
      font-size:16px;
      color:#1a202c;
      margin-bottom:4px;
    }
    .base-meta{
      color:#718096;
      font-size:12px;
    }

    /* Progress Stats */
    .progress-stats{
      display:flex;
      gap:16px;
      padding:16px;
      background:#f7fafc;
      border-radius:10px;
      margin-bottom:16px;
      flex-wrap:wrap;
    }
    .stat-item{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .stat-label{
      font-size:12px;
      color:#718096;
      font-weight:500;
    }
    .stat-value{
      font-size:20px;
      font-weight:700;
      color:#1a202c;
    }
    .stat-value.accent{
      color:#0b5fff;
    }

    /* Unit Navigation */
    .unit-nav{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .unit-card{
      flex:1;
      min-width:100px;
      max-width:140px;
      padding:12px;
      border:1.5px solid #e2e8f0;
      border-radius:10px;
      cursor:pointer;
      transition:all 0.2s;
      text-align:center;
      background:#fff;
      position:relative;
    }
    .unit-card:hover{
      border-color:#0b5fff;
      background:#eff6ff;
    }
    .unit-card.completed{
      border-color:#10b981;
      background:#d1fae5;
    }
    .unit-card.current{
      border-color:#0b5fff;
      background:#eff6ff;
      box-shadow:0 0 0 3px rgba(11,95,255,0.1);
    }
    .unit-card.disabled{
      opacity:0.5;
      cursor:not-allowed;
    }
    .unit-card.disabled:hover{
      border-color:#e2e8f0;
      background:#fff;
    }
    .unit-name{
      font-weight:600;
      font-size:13px;
      color:#1a202c;
      margin-bottom:4px;
    }
    .unit-status{
      font-size:11px;
      color:#718096;
    }
    .unit-card.completed .unit-status{
      color:#059669;
    }
    .unit-card.current .unit-status{
      color:#0b5fff;
    }
    .unit-icon{
      font-size:18px;
      margin-bottom:4px;
    }

    /* Available Bases */
    .base-list{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));
      gap:12px;
    }
    .available-base{
      padding:16px;
      background:#fff;
      border:1.5px solid #e2e8f0;
      border-radius:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      transition:all 0.2s;
    }
    .available-base:hover{
      border-color:#cbd5e0;
      box-shadow:0 2px 4px rgba(0,0,0,.05);
    }
    .available-base-name{
      font-size:14px;
      font-weight:500;
      color:#1a202c;
      flex:1;
    }

    /* Empty State */
    .empty-state{
      text-align:center;
      padding:48px 24px;
      color:#718096;
    }

    /* Button Groups */
    .btn-group{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="page-header">
      <div>
        <h2>å­¦ä¹ åº“ç®¡ç†</h2>
        <div id="cfgInfo" class="muted" style="margin-top:8px"></div>
      </div>
      <div style="display:flex;gap:12px">
        <a href="/library.html" style="padding:11px 20px;background:#fff;color:#1a202c;border:1.5px solid #e2e8f0;border-radius:10px;text-decoration:none;font-size:14px;font-weight:500">èµ„æ–™åº“ç»´æŠ¤</a>
        <a href="/" style="padding:11px 20px;background:#fff;color:#1a202c;border:1.5px solid #e2e8f0;border-radius:10px;text-decoration:none;font-size:14px;font-weight:500">â† è¿”å›å¼•å¯¼é¡µ</a>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="section-header">
      <h3 id="learningLibraryTitle">æˆ‘çš„å­¦ä¹ åº“</h3>
    </div>
    <div class="muted" style="margin-bottom:20px">å½“å‰æ­£åœ¨å­¦ä¹ çš„èµ„æ–™åº“ã€‚ç‚¹å‡»å•å…ƒå¡ç‰‡å³å¯æ›´æ–°å­¦ä¹ è¿›åº¦ã€‚</div>
    <div id="myLearningBases"></div>
  </div>

  <div class="card">
    <div class="section-header">
      <h3>æ·»åŠ èµ„æ–™åº“åˆ°å­¦ä¹ åº“</h3>
    </div>

    <h4 style="margin:0 0 12px;font-size:15px;font-weight:600">ç³»ç»Ÿè¯¾æœ¬èµ„æ–™åº“</h4>
    <div id="systemBases" class="muted">åŠ è½½ä¸­...</div>

    <h4 style="margin:32px 0 12px;font-size:15px;font-weight:600">æˆ‘çš„è‡ªå®šä¹‰èµ„æ–™åº“</h4>
    <div id="customBases" class="muted">åŠ è½½ä¸­...</div>

    <div class="muted" style="margin-top:20px;padding:12px;background:#f7fafc;border-radius:8px">
      ğŸ’¡ æç¤ºï¼šå¦‚éœ€åˆ›å»ºæ–°èµ„æ–™åº“æˆ–ç®¡ç†çŸ¥è¯†ç‚¹ï¼Œè¯·è®¿é—® <a href="/library.html">èµ„æ–™åº“ç»´æŠ¤</a> é¡µé¢
    </div>
  </div>
</div>

<!-- Cover Image Modal -->
<div id="coverModal" onclick="hideCoverImage()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:9999;justify-content:center;align-items:center;cursor:pointer">
  <img id="coverModalImg" src="" alt="å°é¢å¤§å›¾" style="max-width:90vw;max-height:90vh;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.5)" />
</div>

<script src="unit_tabs_shared.js"></script>
<script>
function getCfg(){
  const raw = localStorage.getItem('el_cfg');
  return raw ? JSON.parse(raw) : {};
}

async function apiJSON(path, opts){
  const res = await fetch(path, Object.assign({headers:{'Content-Type':'application/json'}}, opts||{}));
  if(!res.ok){
    let errorMsg;
    try{
      const text = await res.text();
      try{
        const errorData = JSON.parse(text);
        errorMsg = errorData.detail || errorData.message || JSON.stringify(errorData);
      }catch(e){
        errorMsg = text;
      }
    }catch(e){
      errorMsg = 'Request failed';
    }
    throw new Error(errorMsg);
  }
  return res.json();
}

async function loadAll(){
  const cfg = getCfg();
  document.getElementById('cfgInfo').innerHTML =
    `å¹´çº§: ${cfg.grade_code||'-'} | ID: #${cfg.student_id||'-'}`;
  const titleEl = document.getElementById('learningLibraryTitle');
  if(titleEl){
    const displayName = cfg.student_name || 'å­¦ç”Ÿ';
    titleEl.textContent = `${displayName}çš„å­¦ä¹ åº“`;
  }

  if(!cfg.student_id){
    document.getElementById('myLearningBases').innerHTML = '<div class="empty-state">è¯·å…ˆåœ¨å¼•å¯¼é¡µå®Œæˆåˆå§‹åŒ–</div>';
    return;
  }

  await loadLearningLibrary(cfg.student_id);
  await loadAvailableBases(cfg.student_id);
}

async function loadLearningLibrary(studentId){
  try{
    const res = await apiJSON(`/api/students/${studentId}/learning-bases`);
    const lb = res.learning_bases || [];

    if(lb.length === 0){
      document.getElementById('myLearningBases').innerHTML = '<div class="empty-state">å­¦ä¹ åº“ä¸ºç©º<br><span class="muted">è¯·ä»ä¸‹æ–¹æ·»åŠ èµ„æ–™åº“å¼€å§‹å­¦ä¹ </span></div>';
      return;
    }

    // Load items, units, and mastery stats for each base
    const basesWithData = await Promise.all(lb.map(async (b) => {
      try{
        // Fetch unit metadata (already sorted by unit_index from backend)
        const unitsRes = await apiJSON(`/api/knowledge-bases/${b.base_id}/units`);
        const unitsMeta = unitsRes.units || [];

        // Use unit_code from metadata in the order provided by backend (sorted by unit_index)
        const units = unitsMeta.map(u => u.unit_code);

        // Create mapping: unit_code -> unit_name
        const unitNames = {};
        unitsMeta.forEach(u => {
          unitNames[u.unit_code] = u.unit_name;
        });

        // Fetch mastery statistics
        const statsRes = await apiJSON(`/api/students/${studentId}/bases/${b.base_id}/mastery-stats`);
        const masteryStats = statsRes.stats || [];
        const unitMasteryStats = statsRes.unit_stats || [];
        const masteryThreshold = statsRes.mastery_threshold || 2;

        return {...b, units, unitNames, masteryStats, unitMasteryStats, masteryThreshold};
      }catch(e){
        return {...b, units: [], unitNames: {}, masteryStats: [], unitMasteryStats: [], masteryThreshold: 2};
      }
    }));

    window.currentStudentId = studentId;
    window._basesById = {};
    basesWithData.forEach(b => {
      window._basesById[b.id] = b;
    });
    const html = basesWithData.map(b => renderLearningBase(b, studentId)).join('');
    document.getElementById('myLearningBases').innerHTML = html;
    basesWithData.forEach(b => renderMasterySection(b));
  }catch(e){
    document.getElementById('myLearningBases').innerHTML = `<div class="empty-state" style="color:#dc2626">åŠ è½½å¤±è´¥: ${e.message}</div>`;
  }
}

const masteryState = {};
const typeLabels = {WORD: 'å•è¯', PHRASE: 'çŸ­è¯­', SENTENCE: 'å¥å­'};
const diffLabels = {write: 'ä¼šå†™', recognize: 'ä¼šè®¤', read: 'ä¼šè®¤'};
const typeOrder = ['WORD', 'PHRASE', 'SENTENCE'];
const typeOrderIndex = {WORD: 0, PHRASE: 1, SENTENCE: 2};
const diffOrderIndex = {write: 0, read: 1, recognize: 1};

function ensureMasteryState(baseId){
  if(!masteryState[baseId]){
    masteryState[baseId] = {unit: '__ALL__', expanded: false, cache: {}};
  }
  return masteryState[baseId];
}

function getUnitLabel(base, unit){
  if(!unit || unit === '__ALL__' || unit === 'all'){
    return 'å…¨éƒ¨';
  }
  const unitName = base.unitNames && base.unitNames[unit] ? base.unitNames[unit] : '';
  return unitName ? `${unit} - ${unitName}` : unit;
}

function buildMasteryRows(stats){
  const groupedByType = {};
  stats.forEach(stat => {
    const type = stat.item_type || 'UNKNOWN';
    if(!groupedByType[type]) groupedByType[type] = [];
    groupedByType[type].push(stat);
  });

  return typeOrder.map(type => {
    if(!groupedByType[type]) return '';
    return groupedByType[type].map(stat => {
      const typeLabel = typeLabels[stat.item_type] || stat.item_type;
      const diffLabel = stat.difficulty_tag ? diffLabels[stat.difficulty_tag] || stat.difficulty_tag : 'ä¸åˆ†è¦æ±‚';
      const masteryRate = stat.total > 0 ? Math.round((stat.mastered / stat.total) * 100) : 0;
      return `
        <tr>
          <td style="padding:8px;border-bottom:1px solid #f3f4f6">
            <span style="font-weight:600;color:#1a202c">${typeLabel}</span>
            ${stat.difficulty_tag ? `<span style="margin-left:6px;font-size:11px;padding:2px 8px;border-radius:6px;background:${stat.difficulty_tag === 'write' ? '#fee2e2' : '#dbeafe'};color:${stat.difficulty_tag === 'write' ? '#991b1b' : '#1e40af'}">${diffLabel}</span>` : `<span style="margin-left:6px;font-size:11px;color:#9ca3af">${diffLabel}</span>`}
          </td>
          <td style="padding:8px;border-bottom:1px solid #f3f4f6;text-align:center;font-weight:600;color:#1a202c">${stat.total}</td>
          <td style="padding:8px;border-bottom:1px solid #f3f4f6;text-align:center;font-weight:600;color:#10b981">${stat.mastered}</td>
          <td style="padding:8px;border-bottom:1px solid #f3f4f6;text-align:center;font-weight:600;color:#f59e0b">${stat.learning}</td>
          <td style="padding:8px;border-bottom:1px solid #f3f4f6;text-align:center;font-weight:600;color:#6b7280">${stat.not_started}</td>
          <td style="padding:8px;border-bottom:1px solid #f3f4f6;text-align:center">
            <div style="display:flex;align-items:center;gap:6px;justify-content:center">
              <div style="flex:1;background:#e5e7eb;height:6px;border-radius:3px;overflow:hidden;max-width:100px">
                <div style="width:${masteryRate}%;background:#10b981;height:100%"></div>
              </div>
              <span style="font-size:12px;font-weight:600;color:#1a202c;min-width:36px">${masteryRate}%</span>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }).join('');
}

function buildMasteryTable(stats){
  const rows = buildMasteryRows(stats);
  if(!rows){
    return '<div class="muted" style="padding:8px 0">æš‚æ— ç»Ÿè®¡æ•°æ®</div>';
  }
  return `
    <div style="overflow-x:auto">
      <table style="width:100%;border-collapse:collapse;background:#fff;border:1px solid #e5e7eb;border-radius:8px;font-size:13px">
        <thead>
          <tr style="background:#f9fafb;border-bottom:2px solid #e5e7eb">
            <th style="padding:10px 8px;text-align:left;font-weight:600;color:#4a5568;font-size:12px">ç±»å‹/è¦æ±‚</th>
            <th style="padding:10px 8px;text-align:center;font-weight:600;color:#4a5568;font-size:12px">æ€»æ•°</th>
            <th style="padding:10px 8px;text-align:center;font-weight:600;color:#4a5568;font-size:12px">å·²æŒæ¡</th>
            <th style="padding:10px 8px;text-align:center;font-weight:600;color:#4a5568;font-size:12px">å­¦ä¹ ä¸­</th>
            <th style="padding:10px 8px;text-align:center;font-weight:600;color:#4a5568;font-size:12px">æœªå¼€å§‹</th>
            <th style="padding:10px 8px;text-align:center;font-weight:600;color:#4a5568;font-size:12px">æŒæ¡ç‡</th>
          </tr>
        </thead>
        <tbody>
          ${rows}
        </tbody>
      </table>
    </div>
  `;
}

function getStatsForUnit(base, unit){
  if(!unit || unit === '__ALL__' || unit === 'all'){
    return base.masteryStats || [];
  }
  return (base.unitMasteryStats || []).filter(stat => stat.unit === unit);
}

function buildMasteryUnitCounts(base){
  const counts = {};
  let allTotal = 0;
  (base.masteryStats || []).forEach(stat => {
    allTotal += Number(stat.total) || 0;
  });
  counts.__ALL__ = allTotal;
  (base.unitMasteryStats || []).forEach(stat => {
    if(!stat.unit) return;
    counts[stat.unit] = (counts[stat.unit] || 0) + (Number(stat.total) || 0);
  });
  return counts;
}

function renderMasteryUnitTabs(base, state){
  if(!window.ELUnitTabs || !window.ELUnitTabs.render) return;
  const containerId = `masteryUnitTabs-${base.id}`;
  const counts = buildMasteryUnitCounts(base);
  window.ELUnitTabs.render(containerId, {
    units: base.units || [],
    unitNames: base.unitNames || {},
    counts,
    currentUnit: state.unit,
    onChange: (unit) => {
      const nextUnit = unit || '__ALL__';
      const nextState = ensureMasteryState(base.id);
      nextState.unit = nextUnit;
      renderMasterySection(base);
    },
    includeAll: true,
    allValue: '__ALL__',
    allLabel: 'å…¨éƒ¨'
  });
}

function renderMasterySection(base){
  const wrap = document.getElementById(`masteryWrap-${base.id}`);
  if(!wrap) return;
  const state = ensureMasteryState(base.id);
  const unitLabel = getUnitLabel(base, state.unit);
  const stats = getStatsForUnit(base, state.unit);

  const detailHtml = state.expanded ? `
    <div style="margin-top:12px">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:8px">
        <span style="font-size:12px;color:#4a5568">æŸ¥çœ‹å•å…ƒ</span>
      </div>
      <div id="masteryUnitTabs-${base.id}" class="tabs"></div>
      <div id="masteryDetail-${base.id}" class="mastery-detail" style="border:1px solid #e5e7eb;border-radius:8px;padding:10px;background:#fff">
        <div class="muted">åŠ è½½ä¸­...</div>
      </div>
    </div>
  ` : '';

  wrap.innerHTML = `
    <div style="margin-bottom:20px">
      <div style="font-size:13px;font-weight:600;color:#4a5568;margin-bottom:12px;display:flex;align-items:center;gap:10px;justify-content:space-between">
        <div style="display:flex;align-items:center;gap:8px">
          <span>æŒæ¡æƒ…å†µï¼ˆ${unitLabel}ï¼‰</span>
          <span style="font-size:11px;font-weight:500;color:#718096;background:#f7fafc;padding:3px 8px;border-radius:6px">è¿ç»­æ­£ç¡® ${base.masteryThreshold}+ æ¬¡ä¸ºæŒæ¡</span>
        </div>
        <button class="small mastery-detail-toggle" data-base-id="${base.id}" style="padding:6px 12px">${state.expanded ? 'æ”¶èµ·è¯¦æƒ…' : 'è¯¦æƒ…'}</button>
      </div>
      ${buildMasteryTable(stats)}
      ${detailHtml}
    </div>
  `;

  if(state.expanded){
    renderMasteryUnitTabs(base, state);
    loadMasteryDetail(base, state.unit);
  }
}

async function loadMasteryDetail(base, unit){
  const state = ensureMasteryState(base.id);
  const cacheKey = unit || '__ALL__';
  const target = document.getElementById(`masteryDetail-${base.id}`);
  if(!target) return;
  if(state.cache[cacheKey]){
    target.innerHTML = state.cache[cacheKey];
    return;
  }
  const studentId = window.currentStudentId;
  if(!studentId){
    target.innerHTML = '<div class="muted">ç¼ºå°‘å­¦ç”Ÿä¿¡æ¯</div>';
    return;
  }
  try{
    const url = new URL(`/api/students/${studentId}/bases/${base.base_id}/items`, window.location.origin);
    if(unit && unit !== '__ALL__'){
      url.searchParams.set('unit', unit);
    }
    const res = await apiJSON(url.pathname + url.search);
    const items = res.items || [];
    const detailHtml = buildMasteryDetailTable(base, items);
    state.cache[cacheKey] = detailHtml;
    target.innerHTML = detailHtml;
  }catch(e){
    target.innerHTML = `<div class="muted">åŠ è½½å¤±è´¥ï¼š${e.message}</div>`;
  }
}

function buildMasteryDetailTable(base, items){
  if(!items.length){
    return '<div class="muted">æš‚æ— çŸ¥è¯†ç‚¹</div>';
  }
  const sorted = items
    .map((it, idx) => ({it, idx}))
    .sort((a, b) => {
      const typeA = typeOrderIndex[a.it.item_type] ?? 99;
      const typeB = typeOrderIndex[b.it.item_type] ?? 99;
      if(typeA !== typeB) return typeA - typeB;
      const diffA = diffOrderIndex[a.it.difficulty_tag] ?? 2;
      const diffB = diffOrderIndex[b.it.difficulty_tag] ?? 2;
      if(diffA !== diffB) return diffA - diffB;
      return a.idx - b.idx;
    })
    .map(entry => entry.it);

  const typeMap = {WORD: 'word', PHRASE: 'phrase', SENTENCE: 'sentence'};
  const masteryLabel = {
    mastered: {color: '#10b981'},
    learning: {color: '#ef4444'},
    not_started: {color: '#6b7280'}
  };
  const rows = sorted.map(it => {
    const unitLabel = getUnitLabel(base, it.unit);
    const mastery = masteryLabel[it.mastery_status] || masteryLabel.not_started;
    const practiceText = `${it.correct_attempts || 0}/${it.total_attempts || 0}`;
    return `
      <tr>
        <td><span class="badge ${typeMap[it.item_type] || 'word'}">${typeLabels[it.item_type] || it.item_type}</span></td>
        <td>${unitLabel}</td>
        <td>${it.zh_text || '-'}</td>
        <td>${it.en_text || '-'}</td>
        <td><span style="font-weight:600;color:${mastery.color}">${practiceText}</span></td>
      </tr>
    `;
  }).join('');

  return `
    <table class="mastery-table">
      <thead>
        <tr>
          <th style="width:80px">ç±»å‹</th>
          <th style="width:140px">å•å…ƒ</th>
          <th>ä¸­æ–‡æç¤º</th>
          <th>è‹±æ–‡åŸæ–‡</th>
          <th style="width:120px">æŒæ¡æƒ…å†µ</th>
        </tr>
      </thead>
      <tbody>
        ${rows}
      </tbody>
    </table>
  `;
}

document.addEventListener('click', (e) => {
  const btn = e.target.closest && e.target.closest('.mastery-detail-toggle');
  if(!btn) return;
  const baseId = btn.getAttribute('data-base-id');
  const base = window._basesById ? window._basesById[baseId] : null;
  if(!base) return;
  const state = ensureMasteryState(baseId);
  if(state.expanded){
    state.expanded = false;
    state.unit = '__ALL__';
  }else{
    state.expanded = true;
  }
  renderMasterySection(base);
});

function renderLearningBase(base, studentId){
  const displayName = base.custom_name || base.base_name;
  const typeTag = base.base_is_system ? 'system' : 'custom';
  const typeLabel = base.base_is_system ? 'ç³»ç»Ÿ' : 'è‡ªå®šä¹‰';

  // Build metadata string
  const metaParts = [];
  if(base.base_education_stage) metaParts.push(base.base_education_stage);
  if(base.base_grade) metaParts.push(base.base_grade);
  if(base.base_term) metaParts.push(base.base_term);
  if(base.base_version) metaParts.push(base.base_version);
  if(base.base_publisher) metaParts.push(base.base_publisher);
  const metaStr = metaParts.length > 0 ? metaParts.join(' Â· ') : '';

  // Small cover image (no zoom - user preference)
  const coverHtml = base.base_cover_image
    ? `<img src="${base.base_cover_image}" alt="å°é¢" style="width:60px;height:80px;object-fit:cover;border-radius:6px;margin-right:16px;border:1px solid #e2e8f0" />`
    : '';

  // Calculate progress
  const totalUnits = base.units.length;
  const hasUnits = totalUnits > 0;
  let currentIndex = -1;
  let progressPercent = 0;

  if(hasUnits && base.current_unit){
    if(base.current_unit === '__ALL__'){
      currentIndex = base.units.length;
      progressPercent = 100;
    }else{
      currentIndex = base.units.indexOf(base.current_unit);
      if(currentIndex >= 0){
        progressPercent = Math.round(((currentIndex + 1) / totalUnits) * 100);
      }
    }
  }

  const masteryHtml = `<div id="masteryWrap-${base.id}"></div>`;

  // Render unit progress (simplified)
  let statsHtml = '';
  if(hasUnits){
    const completedUnits = currentIndex >= 0 ? currentIndex : 0;
    statsHtml = `
      <div class="progress-stats" style="margin-bottom:16px">
        <div class="stat-item">
          <div class="stat-label">æ€»å•å…ƒæ•°</div>
          <div class="stat-value">${totalUnits}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">å½“å‰å­¦ä¹ </div>
          <div class="stat-value accent">${base.current_unit === '__ALL__' ? 'å…¨éƒ¨' : (base.current_unit || 'æœªè®¾ç½®')}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">å­¦ä¹ è¿›åº¦</div>
          <div class="stat-value accent">${progressPercent}%</div>
        </div>
      </div>
    `;
  }

  // Render unit navigation
  let unitsHtml = '';
  if(hasUnits){
    let unitCards = base.units.map((unit, idx) => {
      let cardClass = 'unit-card';
      let statusText = 'æœªå¼€å§‹';
      let icon = 'â—‹';

      if(base.current_unit === unit){
        cardClass += ' current';
        statusText = 'è¿›è¡Œä¸­';
        icon = 'â–¶';
      }else if(base.current_unit === '__ALL__' || (currentIndex >= 0 && idx < currentIndex)){
        cardClass += ' completed';
        statusText = 'å·²å®Œæˆ';
        icon = 'âœ“';
      }

      return `
        <div class="${cardClass}" onclick="updateUnitProgress(${base.id}, '${unit}', ${studentId})">
          <div class="unit-icon">${icon}</div>
          <div class="unit-name">${unit}${base.unitNames && base.unitNames[unit] ? ' - ' + base.unitNames[unit] : ''}</div>
          <div class="unit-status">${statusText}</div>
        </div>
      `;
    }).join('');

    // Add "å…¨éƒ¨å®Œæˆ" card
    const allCompleteClass = base.current_unit === '__ALL__' ? 'unit-card current' : 'unit-card';
    const allCompleteIcon = base.current_unit === '__ALL__' ? 'âœ“' : 'â—‹';
    const allCompleteStatus = base.current_unit === '__ALL__' ? 'å·²å®Œæˆ' : 'æ ‡è®°å®Œæˆ';

    unitCards += `
      <div class="${allCompleteClass}" onclick="updateUnitProgress(${base.id}, '__ALL__', ${studentId})">
        <div class="unit-icon">${allCompleteIcon}</div>
        <div class="unit-name">å…¨éƒ¨å®Œæˆ</div>
        <div class="unit-status">${allCompleteStatus}</div>
      </div>
    `;

    unitsHtml = `
      <div>
        <div style="font-size:13px;font-weight:600;color:#4a5568;margin-bottom:12px">å•å…ƒè¿›åº¦</div>
        <div class="unit-nav">${unitCards}</div>
      </div>
    `;
  }else{
    unitsHtml = '<div class="muted" style="padding:12px;background:#f7fafc;border-radius:8px">è¯¥èµ„æ–™åº“æ²¡æœ‰è®¾ç½®å•å…ƒ</div>';
  }

  return `
    <div class="learning-base-item">
      <div class="base-header">
        ${coverHtml}
        <div style="flex:1">
          <div class="base-title">
            ${displayName}
            <span class="badge ${typeTag}">${typeLabel}</span>
          </div>
          <div class="base-meta">#${base.base_id} ${base.is_active ? 'Â· å·²å¯ç”¨' : 'Â· å·²ç¦ç”¨'}</div>
          ${metaStr ? `<div class="base-meta" style="margin-top:4px">${metaStr}</div>` : ''}
        </div>
        <button class="danger small" onclick="removeLearningBase(${base.id}, ${studentId})">ç§»é™¤</button>
      </div>

      ${masteryHtml}
      ${statsHtml}
      ${unitsHtml}
    </div>
  `;
}

async function loadAvailableBases(studentId){
  try{
    const lbRes = await apiJSON(`/api/students/${studentId}/learning-bases`);
    const addedBaseIds = new Set((lbRes.learning_bases || []).map(b => b.base_id));

    // Load system bases
    const sysRes = await apiJSON(`/api/knowledge-bases?is_system=true`);
    const sysBases = (sysRes.bases || []).filter(b => !addedBaseIds.has(b.id));

    if(sysBases.length === 0){
      document.getElementById('systemBases').innerHTML = '<div class="empty-state" style="padding:24px">æ‰€æœ‰ç³»ç»Ÿè¯¾æœ¬å·²æ·»åŠ åˆ°å­¦ä¹ åº“</div>';
    }else{
      const html = sysBases.map(b => renderAvailableBase(b, studentId)).join('');
      document.getElementById('systemBases').innerHTML = html;
    }

    // Load custom bases
    const custRes = await apiJSON(`/api/knowledge-bases?is_system=false`);
    const custBases = (custRes.bases || []).filter(b => !addedBaseIds.has(b.id));

    if(custBases.length === 0){
      document.getElementById('customBases').innerHTML = '<div class="empty-state" style="padding:24px">æ²¡æœ‰å¯æ·»åŠ çš„è‡ªå®šä¹‰èµ„æ–™åº“</div>';
    }else{
      const html = custBases.map(b => renderAvailableBase(b, studentId)).join('');
      document.getElementById('customBases').innerHTML = html;
    }
  }catch(e){
    document.getElementById('systemBases').innerHTML = `<div class="empty-state" style="color:#dc2626">${e.message}</div>`;
  }
}

function renderAvailableBase(base, studentId){
  // Build metadata tags
  const metaTags = [];
  if(base.education_stage && base.grade){
    metaTags.push(`${base.education_stage} ${base.grade}`);
  }else if(base.education_stage){
    metaTags.push(base.education_stage);
  }else if(base.grade){
    metaTags.push(base.grade);
  }
  if(base.term) metaTags.push(base.term);
  if(base.version) metaTags.push(base.version);
  if(base.publisher) metaTags.push(base.publisher);
  if(base.editor) metaTags.push(`ä¸»ç¼–: ${base.editor}`);

  const metaHtml = metaTags.length > 0
    ? `<div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px">
        ${metaTags.map(tag => `<span style="font-size:11px;color:#6b7280;background:#f3f4f6;padding:3px 8px;border-radius:6px;font-weight:500">${tag}</span>`).join('')}
      </div>`
    : '';

  // Cover image - clickable to enlarge
  const coverHtml = base.cover_image
    ? `<img src="${base.cover_image}" alt="å°é¢" onclick="showCoverImage('${base.cover_image}')" style="width:80px;height:106px;object-fit:cover;border-radius:8px;cursor:pointer;border:2px solid #e2e8f0;transition:all 0.2s" onmouseover="this.style.borderColor='#0b5fff'" onmouseout="this.style.borderColor='#e2e8f0'" />`
    : `<div style="width:80px;height:106px;background:#f0f0f0;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:11px;text-align:center;border:2px dashed #e2e8f0;flex-shrink:0">æš‚æ— <br/>å°é¢</div>`;

  const typeTag = base.is_system ? 'system' : 'custom';
  const typeLabel = base.is_system ? 'ç³»ç»Ÿ' : 'è‡ªå®šä¹‰';

  return `
    <div style="border:1.5px solid #e2e8f0;border-radius:12px;padding:20px;background:#fff;transition:all 0.2s;margin-bottom:12px" onmouseover="this.style.borderColor='#cbd5e0';this.style.boxShadow='0 4px 8px rgba(0,0,0,.08)'" onmouseout="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
      <div style="display:flex;gap:16px;align-items:flex-start">
        ${coverHtml}
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
            <span style="font-weight:600;font-size:15px;color:#1a202c">${base.name}</span>
            <span class="badge ${typeTag}">${typeLabel}</span>
          </div>
          ${base.description ? `<div style="color:#718096;font-size:13px;line-height:1.5;margin-bottom:8px">${base.description}</div>` : ''}
          ${metaHtml}
        </div>
        <button class="small" onclick="addToLibrary(${base.id}, ${studentId})" style="flex-shrink:0">æ·»åŠ </button>
      </div>
    </div>
  `;
}

async function addToLibrary(baseId, studentId){
  try{
    await apiJSON(`/api/students/${studentId}/learning-bases`, {
      method: 'POST',
      body: JSON.stringify({base_id: baseId, current_unit: null})
    });
    await loadAll();
  }catch(e){
    alert('æ·»åŠ å¤±è´¥ï¼š' + e.message);
  }
}

async function removeLearningBase(lbId, studentId){
  if(!confirm('ç¡®å®šè¦ä»å­¦ä¹ åº“ä¸­ç§»é™¤è¿™ä¸ªèµ„æ–™åº“å—ï¼Ÿ')) return;
  try{
    await apiJSON(`/api/students/${studentId}/learning-bases/${lbId}`, {method: 'DELETE'});
    await loadAll();
  }catch(e){
    alert('ç§»é™¤å¤±è´¥ï¼š' + e.message);
  }
}

async function updateUnitProgress(lbId, unit, studentId){
  try{
    await apiJSON(`/api/students/${studentId}/learning-bases/${lbId}`, {
      method: 'PUT',
      body: JSON.stringify({current_unit: unit})
    });
    await loadAll();
  }catch(e){
    alert('æ›´æ–°å¤±è´¥ï¼š' + e.message);
  }
}

// Cover image zoom modal
function showCoverImage(url){
  const modal = document.getElementById('coverModal');
  const img = document.getElementById('coverModalImg');
  img.src = url;
  modal.style.display = 'flex';
}

function hideCoverImage(){
  const modal = document.getElementById('coverModal');
  modal.style.display = 'none';
}

window.addEventListener('DOMContentLoaded', loadAll);
</script>
</body>
</html>
