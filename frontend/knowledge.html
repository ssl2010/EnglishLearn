<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>知识库管理</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;margin:0;background:#f6f7fb;color:#111}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    .card{background:#fff;border-radius:14px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.06);margin-bottom:14px}
    a{color:#0b5fff;text-decoration:none}
    textarea{width:100%;min-height:220px;font-family:ui-monospace,Menlo,Consolas,monospace}
    button{border:0;border-radius:10px;padding:10px 14px;background:#111;color:#fff;cursor:pointer}
    button.secondary{background:#fff;color:#111;border:1px solid #ddd}
    input,select{padding:8px;border-radius:10px;border:1px solid #ddd}
    .muted{color:#666;font-size:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .row > *{flex:1;min-width:240px}
    code{background:#f0f1f5;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2 style="margin:0 0 6px 0">学习库管理</h2>
    <div class="muted">管理学生的学习资料库，包括选择系统课本、创建自定义资料库、设置学习进度等。</div>
    <div style="margin-top:10px"><a href="/">← 返回引导页</a></div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">当前学生信息</h3>
    <div id="cfgInfo" class="muted"></div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">我的学习库</h3>
    <div class="muted" style="margin-bottom:10px">这些是学生当前正在学习的资料库。可以设置每个资料库的学习进度。</div>
    <div id="myLearningBases"></div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">添加资料库到学习库</h3>
    <div class="row" style="margin-bottom:10px">
      <div>
        <h4 style="margin:0 0 8px;font-size:13px">系统课本资料库</h4>
        <div id="systemBases" class="muted">加载中...</div>
      </div>
      <div>
        <h4 style="margin:0 0 8px;font-size:13px">我的自定义资料库</h4>
        <div id="customBases" class="muted">加载中...</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">从文件导入（创建新资料库）</h3>
    <div class="muted">
      支持 JSON 文件：可同时创建资料库并导入全部知识点。建议使用 <code>EL_KB_V1</code> 格式。
    </div>
    <div class="row" style="margin-top:10px">
      <div>
        <label class="muted">mode</label>
        <select id="fileMode">
          <option value="skip">skip（冲突跳过）</option>
          <option value="update">update（允许更新）</option>
        </select>
      </div>
      <div>
        <label class="muted">选择文件</label>
        <input id="kbFile" type="file" accept=".json,application/json" />
      </div>
      <div style="display:flex;gap:10px;align-items:end">
        <button id="importFileBtn">导入文件</button>
        <button class="secondary" id="downloadSpecBtn">查看文件格式说明</button>
      </div>
    </div>
    <div id="fileMsg" class="muted" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">粘贴导入（JSON 数组，给高级用户）</h3>
    <div class="muted">每条元素示例：{"type":"WORD","en_text":"swim","zh_hint":"游泳","unit_code":"Unit 1","difficulty_tag":"write"}</div>
    <div class="row" style="margin-top:10px">
      <div style="flex:0.5;min-width:160px">
        <label class="muted">导入到资料库</label>
        <select id="baseForImport"></select>
      </div>
      <div style="flex:0.5;min-width:160px">
        <label class="muted">mode</label>
        <select id="mode">
          <option value="skip">skip（冲突跳过）</option>
          <option value="update">update（允许更新）</option>
        </select>
      </div>
      <div style="flex:1;min-width:260px;display:flex;gap:10px;align-items:end">
        <button class="secondary" id="sampleBtn">填入样例</button>
        <button id="importBtn">导入</button>
      </div>
    </div>
    <textarea id="payload" placeholder="在这里粘贴 JSON 数组"></textarea>
    <div id="msg" class="muted" style="margin-top:8px"></div>
  </div>
</div>

<script>
function getCfg(){
  const raw = localStorage.getItem('el_cfg');
  return raw ? JSON.parse(raw) : {};
}
function setCfg(cfg){ localStorage.setItem('el_cfg', JSON.stringify(cfg||{})); }

async function apiJSON(path, opts){
  const res = await fetch(path, Object.assign({headers:{'Content-Type':'application/json'}}, opts||{}));
  if(!res.ok){
    let errorMsg;
    try{
      const errorData = await res.json();
      errorMsg = errorData.detail || errorData.message || JSON.stringify(errorData);
    }catch(e){
      errorMsg = await res.text();
    }
    throw new Error(errorMsg);
  }
  return res.json();
}

async function loadAll(){
  const cfg = getCfg();
  document.getElementById('cfgInfo').innerText =
    `学生: ${cfg.student_name||'-'} | 年级: ${cfg.grade_code||'-'} | ID: ${cfg.student_id||'-'}`;

  if(!cfg.student_id){
    document.getElementById('myLearningBases').innerHTML = '<div class="muted">请先在引导页完成初始化</div>';
    return;
  }

  // Load learning library
  await loadLearningLibrary(cfg.student_id);

  // Load all bases (for adding to library)
  await loadAvailableBases(cfg.student_id);

  // Load bases for import dropdown
  await loadBasesForImport();
}

async function loadLearningLibrary(studentId){
  try{
    const res = await apiJSON(`/api/students/${studentId}/learning-bases`);
    const lb = res.learning_bases || [];
    if(lb.length === 0){
      document.getElementById('myLearningBases').innerHTML = '<div class="muted">学习库为空。请从下方添加资料库。</div>';
      return;
    }

    // Load units for each base
    const basesWithUnits = await Promise.all(lb.map(async (b) => {
      try{
        const itemsRes = await apiJSON(`/api/knowledge-bases/${b.base_id}/items`);
        const items = itemsRes.items || [];
        // Extract unique units
        const units = [...new Set(items.map(item => item.unit).filter(u => u && u !== '__ALL__'))].sort();
        return {...b, units};
      }catch(e){
        return {...b, units: []};
      }
    }));

    const html = basesWithUnits.map(b => {
      const displayName = b.custom_name || b.base_name;
      const typeTag = b.base_is_system ? '[系统]' : '[自定义]';
      const activeStatus = b.is_active ? '启用' : '禁用';

      // Generate unit options
      let unitOptions = '<option value="">未设置</option>';
      unitOptions += '<option value="__ALL__"' + (b.current_unit === '__ALL__' ? ' selected' : '') + '>全部/不分单元</option>';
      b.units.forEach(unit => {
        unitOptions += `<option value="${unit}"${b.current_unit === unit ? ' selected' : ''}>${unit}</option>`;
      });

      return `
        <div style="padding:12px;background:#f8f9fa;border-radius:8px;margin-bottom:10px">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
            <div>
              <span style="font-weight:500">${displayName}</span>
              <span class="muted" style="font-size:11px">${typeTag} #${b.base_id}</span>
            </div>
            <button class="secondary" onclick="removeLearningBase(${b.id}, ${studentId})" style="padding:4px 10px;font-size:12px">移除</button>
          </div>
          <div class="muted" style="font-size:12px">
            当前进度: ${b.current_unit || '未设置'} | 状态: ${activeStatus}
          </div>
          <div style="margin-top:8px;display:flex;gap:6px">
            <select id="progress_${b.id}" style="flex:1;padding:6px;font-size:12px;border:1px solid #ddd;border-radius:6px">
              ${unitOptions}
            </select>
            <button onclick="updateProgress(${b.id}, ${studentId})" style="padding:6px 12px;font-size:12px">更新进度</button>
          </div>
        </div>
      `;
    }).join('');
    document.getElementById('myLearningBases').innerHTML = html;
  }catch(e){
    document.getElementById('myLearningBases').innerHTML = `<div class="muted" style="color:#d00">加载失败: ${e.message}</div>`;
  }
}

async function loadAvailableBases(studentId){
  try{
    // Load learning library to know which bases are already added
    const lbRes = await apiJSON(`/api/students/${studentId}/learning-bases`);
    const addedBaseIds = new Set((lbRes.learning_bases || []).map(b => b.base_id));

    // Load system bases
    const sysRes = await apiJSON(`/api/knowledge-bases?is_system=true`);
    const sysBases = (sysRes.bases || []).filter(b => !addedBaseIds.has(b.id));
    if(sysBases.length === 0){
      document.getElementById('systemBases').innerHTML = '<div class="muted">所有系统课本已添加到学习库</div>';
    }else{
      const html = sysBases.map(b => `
        <div style="padding:8px;background:#fff;border:1px solid #ddd;border-radius:6px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center">
          <span style="font-size:13px">${b.name}</span>
          <button onclick="addToLibrary(${b.id}, ${studentId})" style="padding:4px 10px;font-size:12px">添加</button>
        </div>
      `).join('');
      document.getElementById('systemBases').innerHTML = html;
    }

    // Load custom bases
    const custRes = await apiJSON(`/api/knowledge-bases?is_system=false`);
    const custBases = (custRes.bases || []).filter(b => !addedBaseIds.has(b.id));
    if(custBases.length === 0){
      document.getElementById('customBases').innerHTML = '<div class="muted">没有自定义资料库（可通过导入文件创建）</div>';
    }else{
      const html = custBases.map(b => `
        <div style="padding:8px;background:#fff;border:1px solid #ddd;border-radius:6px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center">
          <span style="font-size:13px">${b.name}</span>
          <button onclick="addToLibrary(${b.id}, ${studentId})" style="padding:4px 10px;font-size:12px">添加</button>
        </div>
      `).join('');
      document.getElementById('customBases').innerHTML = html;
    }
  }catch(e){
    document.getElementById('systemBases').innerHTML = `<div class="muted" style="color:#d00">${e.message}</div>`;
  }
}

async function loadBasesForImport(){
  try{
    const res = await apiJSON(`/api/knowledge-bases`);
    const bases = res.bases || [];
    const sel = document.getElementById('baseForImport');
    sel.innerHTML = bases.map(b => {
      const typeTag = b.is_system ? '[系统]' : '[自定义]';
      return `<option value="${b.id}">${typeTag} ${b.name}</option>`;
    }).join('');
    if(bases.length === 0){
      sel.innerHTML = '<option value="">（暂无资料库）</option>';
    }
  }catch(e){
    // ignore
  }
}

async function addToLibrary(baseId, studentId){
  try{
    await apiJSON(`/api/students/${studentId}/learning-bases`, {
      method: 'POST',
      body: JSON.stringify({base_id: baseId, current_unit: '__ALL__'})
    });
    await loadAll();
  }catch(e){
    alert('添加失败：' + e.message);
  }
}

async function removeLearningBase(lbId, studentId){
  if(!confirm('确定要从学习库中移除这个资料库吗？')) return;
  try{
    await apiJSON(`/api/students/${studentId}/learning-bases/${lbId}`, {method: 'DELETE'});
    await loadAll();
  }catch(e){
    alert('移除失败：' + e.message);
  }
}

async function updateProgress(lbId, studentId){
  const val = document.getElementById(`progress_${lbId}`).value;
  try{
    await apiJSON(`/api/students/${studentId}/learning-bases/${lbId}`, {
      method: 'PUT',
      body: JSON.stringify({current_unit: val || null})
    });
    await loadAll();
  }catch(e){
    alert('更新失败：' + e.message);
  }
}

function loadSample(){
  const sample = [
    {type:'WORD',en_text:'swim',zh_hint:'游泳',unit_code:'Unit 1',difficulty_tag:'write'},
    {type:'PHRASE',en_text:'play football',zh_hint:'踢足球',unit_code:'Unit 1',difficulty_tag:'write'},
    {type:'SENTENCE',en_text:'What can you do?',zh_hint:'你会做什么？',unit_code:'Unit 1',difficulty_tag:'write'}
  ];
  document.getElementById('payload').value = JSON.stringify(sample, null, 2);
}

async function doImportPaste(){
  const cfg = getCfg();
  const baseId = parseInt(document.getElementById('baseForImport').value, 10);
  if(!baseId){
    alert('请选择一个资料库');
    return;
  }

  let items;
  try{ items = JSON.parse(document.getElementById('payload').value||'[]'); }
  catch(e){ alert('JSON 解析失败'); return; }

  const mode = document.getElementById('mode').value;
  const r = await apiJSON('/api/knowledge-items/import',{
    method:'POST',
    body: JSON.stringify({base_id: baseId, mode, items})
  });
  document.getElementById('msg').innerText = `导入完成：${JSON.stringify(r)}`;
}

async function doImportFile(){
  const cfg = getCfg();
  if(!cfg.student_id){
    alert('请先在引导页完成初始化（创建 student_id）');
    location.href = '/';
    return;
  }
  const f = document.getElementById('kbFile').files[0];
  if(!f){ alert('请选择一个 JSON 文件'); return; }

  const mode = document.getElementById('fileMode').value;
  const msg = document.getElementById('fileMsg');
  msg.innerText = '上传中...';

  const form = new FormData();
  form.append('file', f);
  const res = await fetch(`/api/knowledge-bases/import-file?mode=${encodeURIComponent(mode)}`, {method:'POST', body: form});
  const txt = await res.text();
  if(!res.ok){
    msg.innerText = '导入失败：' + txt;
    return;
  }
  const data = JSON.parse(txt);
  msg.innerText = `导入成功：${JSON.stringify(data)}。资料库已创建，可在上方"添加资料库到学习库"中找到它。`;
  await loadAll();
}

function showSpec(){
  alert(
`文件格式（EL_KB_V1）示例：
{
  "schema_version": "EL_KB_V1",
  "base": {
    "name": "四年级上英语（Unit1-6）",
    "grade_code": "G4"
  },
  "items": [
    {"type":"WORD","unit_code":"Unit 1","en_text":"star","zh_hint":"明星","difficulty_tag":"write"},
    {"type":"PHRASE","unit_code":"Unit 1","en_text":"play football","zh_hint":"踢足球","difficulty_tag":"write"}
  ]
}

说明：
- 提交到 /api/knowledge-bases/import-file （multipart/form-data）。
- 若 payload 中包含 base，则会创建新资料库并导入 items；响应会返回 base_id。
- 新创建的资料库会显示在"我的自定义资料库"列表中，可手动添加到学习库。`
  );
}

window.addEventListener('DOMContentLoaded', ()=>{
  loadAll();
  document.getElementById('sampleBtn').addEventListener('click', loadSample);
  document.getElementById('importBtn').addEventListener('click', doImportPaste);
  document.getElementById('importFileBtn').addEventListener('click', doImportFile);
  document.getElementById('downloadSpecBtn').addEventListener('click', showSpec);
});
</script>
</body>
</html>
