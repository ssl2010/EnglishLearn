<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>英语学习系统 · 引导页</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;margin:0;background:#f6f7fb;color:#111}
    .wrap{max-width:1280px;margin:0 auto;padding:24px}
    .card{background:#fff;border-radius:14px;padding:18px;margin-bottom:16px}
    h1{margin:0 0 8px}
    h2{margin:0 0 10px;font-size:16px}
    .muted{color:#666;font-size:12px}
    label{font-size:12px;color:#444;display:block;margin:10px 0 6px}
    input,select,button{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;font-size:16px;box-sizing:border-box;-webkit-appearance:none;appearance:none}
    button{cursor:pointer;border:none;background:#111;color:#fff}
    button.secondary{background:#fff;color:#111;border:1px solid #ddd}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start}
    .row > *{flex:1 1 0;min-width:0}
    @media (min-width: 640px) {
      .row > * {
        min-width:200px;
      }
    }
    .btns a{display:inline-block;padding:10px 12px;border-radius:10px;background:#111;color:#fff;text-decoration:none;margin-right:10px;margin-top:8px}
    .btns a.secondary{background:#fff;color:#111;border:1px solid #ddd}
    .kpi{font-size:13px;color:#333}
  </style>
</head>
<body>
  <script>
    if(window.top === window){
      fetch('/api/auth/me').then(res => {
        if(res.ok){
          window.location.replace('/app.html');
        }else{
          window.location.replace('/login.html');
        }
      }).catch(() => {
        window.location.replace('/login.html');
      });
    }
  </script>
  <div class="wrap">
    <div class="card">
      <h1>英语学习系统</h1>
      <div class="muted">第一阶段：单设备 / 单孩子 / 无账户体系。通过本地初始化固化 <code>student_id</code> / <code>base_id</code>，从这里进入各子功能。</div>
    </div>

    <div id="initCard" class="card" style="display:none">
      <h2>首次初始化（只做一次）</h2>
      <div class="row">
        <div>
          <label>孩子昵称</label>
          <input id="studentName" placeholder="如：糯米" />
        </div>
        <div>
          <label>年级</label>
          <select id="gradeCode">
            <optgroup label="幼儿园">
              <option value="K1">小班</option>
              <option value="K2">中班</option>
              <option value="K3">大班</option>
            </optgroup>
            <optgroup label="小学">
              <option value="G1">一年级</option>
              <option value="G2">二年级</option>
              <option value="G3">三年级</option>
              <option value="G4" selected>四年级</option>
              <option value="G5">五年级</option>
              <option value="G6">六年级</option>
            </optgroup>
            <optgroup label="初中">
              <option value="G7">初一</option>
              <option value="G8">初二</option>
              <option value="G9">初三</option>
            </optgroup>
            <optgroup label="高中">
              <option value="G10">高一</option>
              <option value="G11">高二</option>
              <option value="G12">高三</option>
            </optgroup>
          </select>
        </div>
      </div>
      <div style="margin-top:12px">
        <button id="bootstrapBtn">完成初始化</button>
      </div>
      <div id="initMsg" class="muted" style="margin-top:10px"></div>
      <div class="muted" style="margin-top:6px">说明：不做账号体系，初始化信息仅保存在本机浏览器。</div>
    </div>

    <div id="mainCard" class="card" style="display:none">
      <h2>系统概览</h2>
      <div class="kpi" id="kpi">加载中...</div>

      <div style="margin-top:16px">
        <h3 style="margin:0 0 8px 0;font-size:14px">我的学习库</h3>
        <div class="muted" style="margin-bottom:10px">学习库包含学生正在学习的资料库及其进度。生成默写单时会从学习库中的资料库选题。</div>
        <div id="learningBases" style="margin-bottom:12px"></div>
        <div style="display:flex;gap:10px">
          <button class="secondary" id="refreshBtn" style="flex:1">刷新</button>
          <a href="knowledge.html" style="flex:1;text-align:center;padding:10px;border-radius:10px;background:#111;color:#fff;text-decoration:none;display:block">管理学习库</a>
        </div>
      </div>

      <div style="margin-top:16px">
        <h3 style="margin:0 0 8px 0;font-size:14px">系统参数</h3>
        <div class="row">
          <div>
            <label>掌握阈值（连续正确次数）</label>
            <input id="mastery" type="number" min="1" max="10" value="2" />
          </div>
          <div>
            <label>每周目标练习天数</label>
            <input id="weekly" type="number" min="1" max="7" value="4" />
          </div>
        </div>
        <button id="saveSettingsBtn" style="margin-top:10px">保存系统参数</button>
        <div id="setMsg" class="muted" style="margin-top:8px"></div>
      </div>

      <div class="btns" style="margin-top:16px">
        <a href="generate.html">生成默写单</a>
        <a href="submit.html">提交 / 批改</a>
        <a href="practice.html">练习单管理</a>
        <a href="dashboard.html">家长看板</a>
        <a href="profile.html" class="secondary">学生信息</a>
        <a href="library.html" class="secondary">资料库维护</a>
      </div>

      <div style="margin-top:12px">
        <button class="secondary" id="resetBtn">重置本机配置（慎用）</button>
      </div>
    </div>
  </div>

<script>
function getCfg(){
  const raw = localStorage.getItem('el_cfg');
  return raw ? JSON.parse(raw) : null;
}
function setCfg(cfg){ localStorage.setItem('el_cfg', JSON.stringify(cfg)); }
function clearCfg(){ localStorage.removeItem('el_cfg'); }

async function api(path, opts){
  const res = await fetch(path, Object.assign({headers:{'Content-Type':'application/json'}}, opts||{}));
  if(!res.ok){
    let errorMsg;
    try{
      const errorData = await res.json();
      errorMsg = errorData.detail || errorData.message || JSON.stringify(errorData);
    }catch(e){
      errorMsg = await res.text();
    }
    throw new Error(errorMsg);
  }
  return res.json();
}

async function refreshUI(){
  const cfg = getCfg();
  const initCard = document.getElementById('initCard');
  const mainCard = document.getElementById('mainCard');
  if(!cfg){
    initCard.style.display='block';
    mainCard.style.display='none';
    return;
  }
  initCard.style.display='none';
  mainCard.style.display='block';
  await loadOverview();
}

async function bootstrap(){
  const out = document.getElementById('initMsg');
  out.textContent = '初始化中...';
  const student_name = (document.getElementById('studentName').value||'孩子').trim();
  const grade_code = document.getElementById('gradeCode').value;
  try{
    const r = await api('/api/bootstrap', {method:'POST', body: JSON.stringify({student_name, grade_code})});
    setCfg({student_id:r.student_id, base_id:r.base_id||null, grade_code, student_name});
    out.textContent = '初始化完成。请在下方选择资料库后开始使用。';
    await refreshUI();
  }catch(e){
    out.textContent = '初始化失败：' + e.message;
  }
}

async function loadOverview(){
  const cfg = getCfg();
  if(!cfg) return;

  // Load learning library (new API)
  const learningBasesDiv = document.getElementById('learningBases');
  try{
    const lb = await api(`/api/students/${cfg.student_id}/learning-bases?is_active=true`);
    if(lb.learning_bases && lb.learning_bases.length > 0){
      learningBasesDiv.innerHTML = lb.learning_bases.map(b => {
        const displayName = b.custom_name || b.base_name;
        const typeTag = b.base_is_system ? '<span style="color:#666;font-size:11px">[系统]</span>' : '<span style="color:#0b5fff;font-size:11px">[自定义]</span>';
        const progress = b.current_unit || '未设置';
        return `<div style="padding:10px;background:#f8f9fa;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
          <div>
            <span style="font-weight:500">${displayName}</span> ${typeTag}
            <div class="muted">进度: ${progress}</div>
          </div>
          <div class="muted" style="font-size:11px">#${b.base_id}</div>
        </div>`;
      }).join('');
    }else{
      learningBasesDiv.innerHTML = '<div class="muted" style="padding:10px;background:#f8f9fa;border-radius:8px">学习库为空。请在"管理学习库"中添加资料库。</div>';
    }
  }catch(e){
    learningBasesDiv.innerHTML = `<div class="muted" style="color:#d00">加载学习库失败: ${e.message}</div>`;
  }

  // Helper function to get grade with stage
  function getGradeWithStage(gradeCode){
    const gradeMap = {
      'K1': '幼儿园 小班', 'K2': '幼儿园 中班', 'K3': '幼儿园 大班',
      'G1': '小学 一年级', 'G2': '小学 二年级', 'G3': '小学 三年级',
      'G4': '小学 四年级', 'G5': '小学 五年级', 'G6': '小学 六年级',
      'G7': '初中 初一', 'G8': '初中 初二', 'G9': '初中 初三',
      'G10': '高中 高一', 'G11': '高中 高二', 'G12': '高中 高三'
    };
    return gradeMap[gradeCode] || gradeCode;
  }

  // status
  const gradeDisplay = getGradeWithStage(cfg.grade_code);
  let statusTxt = `学生：${cfg.student_name}（${gradeDisplay}）`;
  try{
    const lb = await api(`/api/students/${cfg.student_id}/learning-bases?is_active=true`);
    const activeCount = (lb.learning_bases || []).length;
    statusTxt += ` | 学习库资料库数量：${activeCount}`;
  }catch(e){
    // ignore
  }
  document.getElementById('kpi').textContent = statusTxt;

  // settings
  try{
    const s = await api('/api/settings');
    document.getElementById('mastery').value = s.mastery_threshold;
    document.getElementById('weekly').value = s.weekly_target_days;
  }catch(e){
    // ignore
  }
}

async function saveSettings(){
  const msg = document.getElementById('setMsg');
  msg.textContent='保存中...';
  try{
    const mastery_threshold = parseInt(document.getElementById('mastery').value||'2',10);
    const weekly_target_days = parseInt(document.getElementById('weekly').value||'4',10);
    await api('/api/settings', {method:'PUT', body: JSON.stringify({mastery_threshold, weekly_target_days})});
    msg.textContent='已保存。';
    await loadOverview();
  }catch(e){
    msg.textContent='保存失败：'+e.message;
  }
}

function resetLocal(){
  if(!confirm('确定要重置本机配置吗？（会清空 student_id）')) return;
  clearCfg();
  location.reload();
}

document.getElementById('bootstrapBtn').addEventListener('click', bootstrap);
document.getElementById('refreshBtn').addEventListener('click', loadOverview);
window.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
  document.getElementById('resetBtn').addEventListener('click', resetLocal);
  refreshUI();
});
</script>
</body>
</html>
