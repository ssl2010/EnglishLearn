<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç”Ÿæˆé»˜å†™å•</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;margin:0;background:#f6f7fb;color:#111}
    .wrap{max-width:1280px;margin:0 auto;padding:24px}
    .card{background:#fff;border-radius:14px;padding:20px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.04)}
    label{display:block;margin-top:10px;font-size:14px;color:#333;font-weight:500}
    input[type="number"],input[type="text"]{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px;box-sizing:border-box}
    button{margin-top:14px;padding:12px 24px;border:0;border-radius:8px;background:#111;color:#fff;cursor:pointer;font-weight:500;font-size:14px}
    button:hover{background:#333}
    .muted{color:#666;font-size:13px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start}
    .row > *{flex:1 1 0;min-width:0}
    @media (min-width: 640px) {
      .row > * {
        min-width:180px;
      }
    }

    /* Base item styling */
    .base-item{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:18px;
      margin-bottom:16px;
      transition:all 0.2s ease
    }
    .base-item:hover{
      border-color:#d1d5db;
      box-shadow:0 4px 12px rgba(0,0,0,0.06)
    }

    /* Base header */
    .base-header{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:14px;
      padding-bottom:12px;
      border-bottom:1px solid #f3f4f6
    }
    .base-checkbox{
      cursor:pointer;
      width:18px;
      height:18px;
      margin:0;
      accent-color:#0b5fff
    }
    .base-name{
      font-weight:600;
      font-size:15px;
      flex:1;
      color:#111
    }
    .base-tag{
      font-size:11px;
      font-weight:500;
      color:#6b7280;
      padding:3px 8px;
      background:#f3f4f6;
      border-radius:4px;
      text-transform:uppercase;
      letter-spacing:0.3px
    }
    .base-tag.system{color:#059669;background:#d1fae5}
    .base-tag.custom{color:#0b5fff;background:#dbeafe}
    .base-progress{
      font-size:12px;
      color:#6b7280;
      display:flex;
      align-items:center;
      gap:4px
    }
    .base-progress::before{
      content:"ğŸ“š";
      font-size:14px
    }

    /* Units container - horizontal layout */
    .units-container{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:4px
    }
    .units-container.empty{
      justify-content:center;
      padding:20px
    }

    /* Unit chip/card */
    .unit-chip{
      position:relative;
      display:flex;
      align-items:center;
      gap:6px;
      padding:8px 14px;
      background:#f9fafb;
      border:2px solid #e5e7eb;
      border-radius:8px;
      cursor:pointer;
      transition:all 0.15s ease;
      user-select:none;
      font-size:13px;
      font-weight:500;
      color:#374151
    }
    .unit-chip:hover{
      border-color:#d1d5db;
      background:#f3f4f6;
      transform:translateY(-1px);
      box-shadow:0 2px 4px rgba(0,0,0,0.05)
    }
    .unit-chip input[type="checkbox"]{
      cursor:pointer;
      width:16px;
      height:16px;
      margin:0;
      accent-color:#0b5fff
    }
    .unit-chip.checked{
      background:#dbeafe;
      border-color:#0b5fff;
      color:#0b5fff
    }
    .unit-chip.checked:hover{
      background:#bfdbfe;
      border-color:#0284c7
    }
    .unit-chip.current{
      position:relative
    }
    .unit-chip.current::after{
      content:"";
      position:absolute;
      top:-3px;
      right:-3px;
      width:8px;
      height:8px;
      background:#10b981;
      border:2px solid #fff;
      border-radius:50%;
      box-shadow:0 0 0 1px #10b981
    }
    .unit-chip.current .unit-label::after{
      content:" â€¢";
      color:#10b981;
      margin-left:2px
    }

    /* Select all / deselect all buttons */
    .quick-actions{
      margin-top:8px;
      padding-top:12px;
      border-top:1px solid #f3f4f6;
      display:flex;
      gap:8px;
      align-items:center
    }
    .quick-btn{
      padding:5px 10px;
      font-size:12px;
      background:#fff;
      border:1px solid #d1d5db;
      border-radius:6px;
      cursor:pointer;
      color:#6b7280;
      font-weight:500;
      transition:all 0.15s
    }
    .quick-btn:hover{
      background:#f9fafb;
      border-color:#9ca3af;
      color:#374151
    }
    .selection-summary{
      font-size:12px;
      color:#6b7280;
      margin-left:auto
    }

    /* Page header */
    .page-header{
      margin-bottom:24px
    }
    .page-header h1{
      margin:0 0 8px 0;
      font-size:26px;
      font-weight:700;
      color:#111
    }
    /* Params section - compact collapsible design */
    .params-section{
      background:#f9fafb;
      border-radius:10px;
      padding:16px;
      margin-top:20px
    }
    .params-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:0;
      cursor:pointer;
      user-select:none
    }
    .params-header h3{
      margin:0;
      font-size:14px;
      font-weight:600;
      color:#374151;
      text-transform:uppercase;
      letter-spacing:0.5px
    }
    .params-toggle{
      padding:6px 12px;
      font-size:12px;
      background:#fff;
      border:1px solid #d1d5db;
      border-radius:6px;
      cursor:pointer;
      color:#6b7280;
      font-weight:500;
      transition:all 0.15s
    }
    .params-toggle:hover{
      background:#f9fafb;
      border-color:#9ca3af;
      color:#374151
    }
    .params-summary{
      margin-top:12px;
      padding:12px;
      background:#fff;
      border-radius:8px;
      border:1px solid #e5e7eb;
      font-size:13px;
      color:#374151;
      line-height:1.8
    }
    .params-summary-label{
      color:#6b7280;
      font-weight:500;
      margin-right:8px
    }
    .params-detail{
      display:none;
      margin-top:12px
    }
    .params-detail.active{
      display:block
    }
    .params-section h3{
      margin:0 0 12px 0;
      font-size:14px;
      font-weight:600;
      color:#374151;
      text-transform:uppercase;
      letter-spacing:0.5px
    }
    .param-group{
      background:#fff;
      border-radius:8px;
      padding:14px;
      margin-bottom:12px;
      border:1px solid #e5e7eb
    }
    .param-group-title{
      font-size:13px;
      font-weight:600;
      color:#6b7280;
      margin:0 0 10px 0;
      display:flex;
      align-items:center;
      gap:6px
    }
    .param-group-title::before{
      content:"";
      width:3px;
      height:14px;
      background:#0b5fff;
      border-radius:2px
    }
    .checkbox-group{
      display:flex;
      gap:12px;
      flex-wrap:wrap
    }
    .checkbox-label{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 14px;
      background:#f9fafb;
      border:2px solid #e5e7eb;
      border-radius:8px;
      cursor:pointer;
      transition:all 0.15s ease;
      user-select:none;
      font-size:14px;
      font-weight:500;
      color:#374151
    }
    .checkbox-label:hover{
      border-color:#d1d5db;
      background:#f3f4f6
    }
    .checkbox-label input[type="checkbox"]{
      cursor:pointer;
      width:18px;
      height:18px;
      margin:0;
      accent-color:#0b5fff
    }
    .checkbox-label.checked{
      background:#dbeafe;
      border-color:#0b5fff;
      color:#0b5fff
    }
    .checkbox-label.checked:hover{
      background:#bfdbfe;
      border-color:#0284c7
    }
    /* Preview section */
    .preview-section{
      background:#f9fafb;
      border:1px solid #e5e7eb;
      border-radius:10px;
      padding:20px;
      margin-top:16px;
      display:none
    }
    .preview-section.show{
      display:block
    }
    .preview-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
      padding-bottom:12px;
      border-bottom:2px solid #e5e7eb
    }
    .preview-title{
      font-size:16px;
      font-weight:600;
      color:#111
    }
    .preview-stats{
      font-size:13px;
      color:#6b7280
    }
    .items-grid{
      display:block;
      margin-bottom:16px
    }
    .item-card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:8px;
      padding:12px;
      transition:all 0.15s
    }
    .item-card:hover{
      border-color:#d1d5db;
      box-shadow:0 2px 4px rgba(0,0,0,0.05)
    }
    .item-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px
    }
    .item-position{
      font-size:12px;
      font-weight:600;
      color:#6b7280;
      background:#f3f4f6;
      padding:2px 8px;
      border-radius:4px
    }
    .item-type{
      font-size:11px;
      font-weight:500;
      padding:2px 6px;
      border-radius:4px
    }
    .item-type.WORD{background:#dbeafe;color:#0b5fff}
    .item-type.PHRASE{background:#fef3c7;color:#d97706}
    .item-type.SENTENCE{background:#d1fae5;color:#059669}
    .item-zh{
      font-size:14px;
      color:#111;
      margin-bottom:4px
    }
    .item-en{
      font-size:12px;
      color:#9ca3af;
      font-style:italic
    }
    .preview-actions{
      display:flex;
      gap:12px;
      padding-top:16px;
      border-top:1px solid #e5e7eb
    }
    .preview-actions button{
      flex:1;
      margin:0
    }
    .btn-confirm{
      background:#10b981;
      color:#fff
    }
    .btn-confirm:hover{
      background:#059669
    }
    .btn-regenerate{
      background:#fff;
      color:#111;
      border:1px solid #d1d5db
    }
    .btn-regenerate:hover{
      background:#f9fafb
    }
    .btn-adjust{
      background:#fff;
      color:#0b5fff;
      border:1px solid #0b5fff
    }
    .btn-adjust:hover{
      background:#f0f9ff
    }
    /* Top action buttons (duplicated next to "ç”Ÿæˆç»ƒä¹ å•") */
    #topActions button{
      padding:10px 16px;
      font-size:14px;
      font-weight:500;
      border-radius:8px;
      cursor:pointer;
      transition:all 0.15s;
      white-space:nowrap
    }
    #topActions .btn-confirm{
      background:#10b981;
      color:#fff;
      border:none
    }
    #topActions .btn-confirm:hover{
      background:#059669
    }
    #topActions .btn-regenerate{
      background:#f3f4f6;
      color:#111;
      border:1px solid #d1d5db
    }
    #topActions .btn-regenerate:hover{
      background:#e5e7eb;
      border-color:#9ca3af
    }
    #topActions .btn-adjust{
      background:#f0f9ff;
      color:#0b5fff;
      border:1px solid #0b5fff
    }
    #topActions .btn-adjust:hover{
      background:#dbeafe;
      border-color:#0284c7
    }
    /* Section-based preview (exam format) */
    .section-group{
      margin-bottom:24px;
      page-break-inside:avoid
    }
    .section-header{
      font-size:15px;
      font-weight:700;
      color:#111;
      margin-bottom:12px;
      padding-bottom:8px;
      border-bottom:1px solid #ddd;
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap
    }
    .shortage-warning{
      font-size:13px;
      font-weight:600;
      color:#dc2626;
      background:#fee2e2;
      padding:4px 12px;
      border-radius:6px;
      border:1px solid #fca5a5;
      display:inline-flex;
      align-items:center;
      gap:4px
    }
    .section-items{
      line-height:2.5;
      margin-bottom:8px
    }
    /* å•è¯ï¼š3åˆ—å¸ƒå±€ */
    .section-items-word{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:12px 20px;
      align-items:start
    }
    /* çŸ­è¯­ï¼š2åˆ— */
    .section-items-phrase{
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:12px 20px;
      align-items:start
    }
    /* å¥å­ï¼šæ¯è¡Œä¸€é¢˜ */
    .section-items-sentence{
      display:flex;
      flex-direction:column;
      gap:16px
    }
    .preview-item{
      display:flex;
      gap:8px;
      align-items:baseline;
      padding:8px 0;
      border-bottom:1px dotted #e5e7eb
    }
    /* å¥å­ç±»å‹ï¼šåºå·å’Œè‹±æ–‡åŒä¸€è¡Œï¼Œä¸­æ–‡æç¤ºå¦èµ·ä¸€è¡Œ */
    .section-items-sentence .preview-item{
      display:block;
      border-bottom:1px solid #ddd;
      padding:8px 0;
      line-height:1.8
    }
    .section-items-sentence .item-number{
      display:inline;
      margin-right:6px
    }
    .section-items-sentence .item-answer{
      display:inline
    }
    .section-items-sentence .item-hint{
      display:block;
      padding-left:28px;
      margin-top:2px
    }
    .item-number{
      font-size:14px;
      font-weight:600;
      color:#666;
      flex-shrink:0
    }
    .item-hint{
      font-size:14px;
      color:#888;
      margin-left:6px
    }
    .item-answer{
      font-size:17px;
      color:#111;
      font-weight:500
    }
  </style>
</head>
<body>
  <div class="wrap">

    <div class="card">
      <h3 style="margin:0 0 16px 0;font-size:15px;font-weight:600;color:#374151">é€‰æ‹©å‡ºé¢˜èŒƒå›´</h3>
      <div id="basesContainer">
        <div class="muted">åŠ è½½ä¸­...</div>
      </div>
    </div>

    <div class="card">
      <div class="params-section">
        <div class="params-header" onclick="toggleParams()">
          <h3>ç”Ÿæˆå‚æ•°</h3>
          <button type="button" class="params-toggle" id="paramsToggle">ä¿®æ”¹</button>
        </div>

        <!-- Compact summary view -->
        <div class="params-summary" id="paramsSummary">
          <div><span class="params-summary-label">æ ‡é¢˜:</span><span id="summaryTitle">è‹±è¯­é»˜å†™å•</span></div>
          <div><span class="params-summary-label">é¢˜é‡:</span><span id="summaryMix">å•è¯ 15 | çŸ­è¯­ 8 | å¥å­ 6</span> (æ€»è®¡ <span id="summaryTotal">29</span>)</div>
          <div><span class="params-summary-label">è¦æ±‚:</span><span id="summaryDifficulty">ä¼šå†™ + ä¼šè®¤</span></div>
        </div>

        <!-- Detailed edit view (hidden by default) -->
        <div class="params-detail" id="paramsDetail">
          <!-- åŸºç¡€é…ç½® -->
          <div class="param-group">
            <div class="param-group-title">åŸºç¡€é…ç½®</div>
            <div style="margin-bottom:12px">
              <label style="margin-top:0">æ ‡é¢˜</label>
              <input type="text" id="title" value="è‹±è¯­é»˜å†™å•" onchange="updateParamsSummary()" oninput="updateParamsSummary()" />
            </div>
            <div>
              <label style="margin-top:0">æ€»é¢˜é‡ <span class="muted" style="font-weight:400">(è‡ªåŠ¨è®¡ç®—)</span></label>
              <input type="number" id="total" value="29" min="1" max="100" readonly style="background:#f3f4f6;cursor:not-allowed" />
            </div>
          </div>

          <!-- é¢˜å‹åˆ†å¸ƒ -->
          <div class="param-group">
            <div class="param-group-title">é¢˜å‹åˆ†å¸ƒ</div>
            <div class="row">
              <div>
                <label style="margin-top:0">å•è¯</label>
                <input type="number" id="word" value="15" min="0" max="50" onchange="updateTotal();updateParamsSummary()" oninput="updateTotal();updateParamsSummary()" />
              </div>
              <div>
                <label style="margin-top:0">çŸ­è¯­</label>
                <input type="number" id="phrase" value="8" min="0" max="30" onchange="updateTotal();updateParamsSummary()" oninput="updateTotal();updateParamsSummary()" />
              </div>
              <div>
                <label style="margin-top:0">å¥å­</label>
                <input type="number" id="sentence" value="6" min="0" max="20" onchange="updateTotal();updateParamsSummary()" oninput="updateTotal();updateParamsSummary()" />
              </div>
            </div>
          </div>

          <!-- è¦æ±‚ç­›é€‰ -->
          <div class="param-group">
            <div class="param-group-title">è¦æ±‚ç­›é€‰</div>
            <div class="checkbox-group">
              <label class="checkbox-label" id="writeLabel" onclick="toggleDifficultyCheckbox('write')">
                <input type="checkbox" id="difficultyWrite" checked onchange="updateDifficultyLabels();updateParamsSummary()" onclick="event.stopPropagation()">
                <span>ä¼šå†™</span>
              </label>
              <label class="checkbox-label checked" id="readLabel" onclick="toggleDifficultyCheckbox('read')">
                <input type="checkbox" id="difficultyRead" checked onchange="updateDifficultyLabels();updateParamsSummary()" onclick="event.stopPropagation()">
                <span>ä¼šè®¤</span>
              </label>
            </div>
            <div class="muted" style="margin-top:8px;font-size:12px">æ ¹æ®æ•™æ"è¦æ±‚"æ ‡æ³¨ç­›é€‰å‡ºé¢˜èŒƒå›´ï¼Œè‡³å°‘é€‰æ‹©ä¸€é¡¹</div>
          </div>
        </div>
      </div>

      <!-- Action buttons container -->
      <div style="display:flex;gap:12px;align-items:center;margin-top:16px;flex-wrap:wrap">
        <button id="go">ç”Ÿæˆç»ƒä¹ å•</button>
        <div id="topActions" style="display:none;flex:1;gap:8px;flex-wrap:wrap">
          <button class="btn-confirm" id="confirmBtnTop">âœ“ ç¡®è®¤ç”Ÿæˆ PDF</button>
          <button class="btn-regenerate" id="regenerateBtnTop">â†» é‡æ–°ç”Ÿæˆ</button>
          <button class="btn-adjust" id="adjustBtnTop">â† è°ƒæ•´èŒƒå›´</button>
        </div>
      </div>

      <!-- Preview Section -->
      <div id="previewSection" class="preview-section">
        <div class="preview-header">
          <div class="preview-title">ç»ƒä¹ å•é¢„è§ˆ</div>
          <div class="preview-stats" id="previewStats"></div>
        </div>
        <div id="itemsGrid" class="items-grid"></div>
        <div class="preview-actions">
          <button class="btn-confirm" id="confirmBtn">âœ“ ç¡®è®¤ç”Ÿæˆ PDF</button>
          <button class="btn-regenerate" id="regenerateBtn">â†» é‡æ–°ç”Ÿæˆ</button>
          <button class="btn-adjust" id="adjustBtn">â† è°ƒæ•´èŒƒå›´</button>
        </div>
      </div>

      <!-- Result section (moved below preview for better UX) -->
      <div id="out" style="margin-top:12px"></div>
    </div>
  </div>

<script>
const cfg = JSON.parse(localStorage.getItem('el_cfg')||'null');
if(!cfg){ location.href='/'; }

let learningBases = [];
let currentSessionData = null; // Store current session data for preview

// Toggle params section
function toggleParams(){
  const detail = document.getElementById('paramsDetail');
  const toggle = document.getElementById('paramsToggle');
  const summary = document.getElementById('paramsSummary');

  if(detail.classList.contains('active')){
    // Collapse
    detail.classList.remove('active');
    toggle.textContent = 'ä¿®æ”¹';
    summary.style.display = 'block';
  }else{
    // Expand
    detail.classList.add('active');
    toggle.textContent = 'æ”¶èµ·';
    summary.style.display = 'none';
  }
}

// Update params summary
function updateParamsSummary(){
  const title = document.getElementById('title').value || 'è‹±è¯­é»˜å†™å•';
  const word = parseInt(document.getElementById('word').value || '0', 10);
  const phrase = parseInt(document.getElementById('phrase').value || '0', 10);
  const sentence = parseInt(document.getElementById('sentence').value || '0', 10);
  const total = word + phrase + sentence;

  const writeChecked = document.getElementById('difficultyWrite').checked;
  const readChecked = document.getElementById('difficultyRead').checked;

  let difficultyText = '';
  if(writeChecked && readChecked){
    difficultyText = 'ä¼šå†™ + ä¼šè®¤';
  }else if(writeChecked){
    difficultyText = 'ä¼šå†™';
  }else if(readChecked){
    difficultyText = 'ä¼šè®¤';
  }

  document.getElementById('summaryTitle').textContent = title;
  document.getElementById('summaryMix').textContent = `å•è¯ ${word} | çŸ­è¯­ ${phrase} | å¥å­ ${sentence}`;
  document.getElementById('summaryTotal').textContent = total;
  document.getElementById('summaryDifficulty').textContent = difficultyText;
}

// Auto-calculate total count
function updateTotal(){
  const word = parseInt(document.getElementById('word').value || '0', 10);
  const phrase = parseInt(document.getElementById('phrase').value || '0', 10);
  const sentence = parseInt(document.getElementById('sentence').value || '0', 10);
  const total = word + phrase + sentence;
  document.getElementById('total').value = total;
}

// Toggle difficulty checkbox and update UI
function toggleDifficultyCheckbox(type){
  const checkbox = document.getElementById(`difficulty${type === 'write' ? 'Write' : 'Read'}`);
  checkbox.checked = !checkbox.checked;
  updateDifficultyLabels();
}

// Update difficulty label styles based on checkbox state
function updateDifficultyLabels(){
  const writeCheckbox = document.getElementById('difficultyWrite');
  const readCheckbox = document.getElementById('difficultyRead');
  const writeLabel = document.getElementById('writeLabel');
  const readLabel = document.getElementById('readLabel');

  // Prevent unchecking both (at least one must be selected)
  if(!writeCheckbox.checked && !readCheckbox.checked){
    // Re-check the one that was just unchecked
    if(event && event.target){
      event.target.checked = true;
    }
    return;
  }

  // Update label styles
  if(writeCheckbox.checked){
    writeLabel.classList.add('checked');
  }else{
    writeLabel.classList.remove('checked');
  }

  if(readCheckbox.checked){
    readLabel.classList.add('checked');
  }else{
    readLabel.classList.remove('checked');
  }
}

// Get difficulty filter based on checkbox states
function getDifficultyFilter(){
  const writeChecked = document.getElementById('difficultyWrite').checked;
  const readChecked = document.getElementById('difficultyRead').checked;

  if(writeChecked && readChecked){
    return null; // Both selected = all
  }else if(writeChecked){
    return 'write';
  }else if(readChecked){
    return 'read';
  }
  return null;
}

async function api(path, opts){
  const res = await fetch(path, Object.assign({headers:{'Content-Type':'application/json'}}, opts||{}));

  // Read response body as text first (can only be read once)
  const text = await res.text();

  if(!res.ok){
    let errorMsg;
    try{
      const errorData = JSON.parse(text);
      errorMsg = errorData.detail || errorData.message || JSON.stringify(errorData);
    }catch(e){
      errorMsg = text || res.statusText;
    }
    throw new Error(errorMsg);
  }

  // Parse successful response
  try{
    return JSON.parse(text);
  }catch(e){
    throw new Error('Invalid JSON response');
  }
}

async function loadLearningBases(){
  try{
    const res = await api(`/api/students/${cfg.student_id}/learning-bases?is_active=true`);
    learningBases = res.learning_bases || [];

    if(learningBases.length === 0){
      document.getElementById('basesContainer').innerHTML = '<div class="muted">å­¦ä¹ åº“ä¸ºç©ºï¼Œè¯·å…ˆåœ¨"ç®¡ç†å­¦ä¹ åº“"ä¸­æ·»åŠ èµ„æ–™åº“ã€‚</div>';
      return;
    }

    // Load units and unit metadata for each base
    const basesWithUnits = await Promise.all(learningBases.map(async (b) => {
      try{
        // Fetch unit metadata (already sorted by unit_index from backend)
        const unitsRes = await api(`/api/knowledge-bases/${b.base_id}/units`);
        const unitsMeta = unitsRes.units || [];

        // Use unit_code from metadata in the order provided by backend (sorted by unit_index)
        const units = unitsMeta.map(u => u.unit_code);

        // Create mapping: unit_code -> unit_name
        const unitNames = {};
        unitsMeta.forEach(u => {
          unitNames[u.unit_code] = u.unit_name;
        });

        return {...b, units, unitNames};
      }catch(e){
        return {...b, units: [], unitNames: {}};
      }
    }));

    // Update learningBases to include units
    learningBases = basesWithUnits;

    renderBases(basesWithUnits);
  }catch(e){
    document.getElementById('basesContainer').innerHTML = `<div class="muted" style="color:#d00">åŠ è½½å¤±è´¥: ${e.message}</div>`;
  }
}

function renderBases(basesWithUnits){
  const container = document.getElementById('basesContainer');

  const html = basesWithUnits.map(base => {
    const displayName = base.custom_name || base.base_name;
    const typeTag = base.base_is_system ? 'system' : 'custom';
    const typeLabel = base.base_is_system ? 'ç³»ç»Ÿ' : 'è‡ªå®šä¹‰';
    const progress = base.current_unit || 'æœªè®¾ç½®';
    const baseId = base.base_id;

    // Generate unit chips
    let unitChips = '';
    if(base.units.length > 0){
      unitChips = base.units.map(unit => {
        const isCurrent = unit === base.current_unit;
        const unitName = base.unitNames && base.unitNames[unit] ? base.unitNames[unit] : '';
        const displayText = unitName ? `${unit} - ${unitName}` : unit;
        return `
          <div class="unit-chip ${isCurrent ? 'current' : ''}" id="chip_${baseId}_${unit}" onclick="toggleUnit(${baseId}, '${unit}')">
            <input type="checkbox" id="unit_${baseId}_${unit}" data-base="${baseId}" data-unit="${unit}" onchange="onUnitChange(${baseId})" onclick="event.stopPropagation()">
            <span class="unit-label">${displayText}</span>
          </div>
        `;
      }).join('');
    }else{
      unitChips = '<div class="muted" style="padding:10px 0">è¯¥èµ„æ–™åº“æ²¡æœ‰å•å…ƒåˆ’åˆ†</div>';
    }

    return `
      <div class="base-item" data-base-id="${baseId}">
        <div class="base-header">
          <input type="checkbox" class="base-checkbox" id="base_${baseId}" data-base="${baseId}" onchange="onBaseChange(${baseId})">
          <div class="base-name">${displayName}</div>
          <span class="base-tag ${typeTag}">${typeLabel}</span>
          <span class="base-progress">${progress}</span>
        </div>
        <div class="units-container ${base.units.length === 0 ? 'empty' : ''}" id="units_${baseId}">
          ${unitChips}
        </div>
        ${base.units.length > 0 ? `
          <div class="quick-actions">
            <span class="selection-summary" id="summary_${baseId}"></span>
            <span class="muted" style="font-size:11px;margin-left:auto">æç¤ºï¼šç‚¹å‡»èµ„æ–™åº“å¤é€‰æ¡†å¯åœ¨"å…¨é€‰/å…¨ä¸é€‰/å­¦ä¹ è¿›åº¦"ä¹‹é—´åˆ‡æ¢</span>
          </div>
        ` : ''}
      </div>
    `;
  }).join('');

  container.innerHTML = html;

  // Set default selections and update UI
  basesWithUnits.forEach(base => {
    setDefaultSelection(base);
    updateSelectionSummary(base.base_id);
  });
}

function toggleUnit(baseId, unit){
  const checkbox = document.getElementById(`unit_${baseId}_${unit}`);
  checkbox.checked = !checkbox.checked;
  onUnitChange(baseId);
}

function selectAllUnits(baseId){
  const base = learningBases.find(b => b.base_id === baseId);
  base.units.forEach(unit => {
    const checkbox = document.getElementById(`unit_${baseId}_${unit}`);
    if(checkbox) checkbox.checked = true;
  });
  onUnitChange(baseId);
}

function deselectAllUnits(baseId){
  const base = learningBases.find(b => b.base_id === baseId);
  base.units.forEach(unit => {
    const checkbox = document.getElementById(`unit_${baseId}_${unit}`);
    if(checkbox) checkbox.checked = false;
  });
  onUnitChange(baseId);
}

function setDefaultSelection(base){
  const baseId = base.base_id;
  const currentUnit = base.current_unit;

  if(!currentUnit || currentUnit === '__ALL__'){
    // If no progress or ALL, select all units
    base.units.forEach(unit => {
      const checkbox = document.getElementById(`unit_${baseId}_${unit}`);
      if(checkbox) checkbox.checked = true;
    });
  }else{
    // Select Unit 1 to current_unit
    // Support multiple formats: "Unit 3", "U3", "unit 3", etc.
    const match = currentUnit.match(/(?:Unit|U)\s*(\d+)/i);
    if(match){
      const currentNum = parseInt(match[1], 10);
      base.units.forEach(unit => {
        const unitMatch = unit.match(/(?:Unit|U)\s*(\d+)/i);
        if(unitMatch){
          const unitNum = parseInt(unitMatch[1], 10);
          if(unitNum <= currentNum){
            const checkbox = document.getElementById(`unit_${baseId}_${unit}`);
            if(checkbox) checkbox.checked = true;
          }
        }
      });
    }else{
      // If current_unit format is not recognized, select all units
      base.units.forEach(unit => {
        const checkbox = document.getElementById(`unit_${baseId}_${unit}`);
        if(checkbox) checkbox.checked = true;
      });
    }
  }

  // Update UI
  updateBaseCheckbox(baseId);
  updateUnitChipsUI(baseId);
}

function onBaseChange(baseId){
  const base = learningBases.find(b => b.base_id === baseId);
  if(!base) return;

  // Determine current selection state
  const state = getSelectionState(baseId, base);

  // Cycle through states: all -> none -> progress -> all
  switch(state){
    case 'all':
      // å…¨é€‰ -> å…¨ä¸é€‰
      deselectAllUnits(baseId);
      break;
    case 'none':
      // å…¨ä¸é€‰ -> å½“å‰è¿›åº¦
      selectToProgress(baseId);
      break;
    case 'progress':
    case 'partial':
      // å½“å‰è¿›åº¦/éƒ¨åˆ†é€‰æ‹© -> å…¨é€‰
      selectAllUnits(baseId);
      break;
  }
}

function getSelectionState(baseId, base){
  const allUnits = base.units;
  const selectedUnits = [];

  allUnits.forEach(unit => {
    const cb = document.getElementById(`unit_${baseId}_${unit}`);
    if(cb && cb.checked){
      selectedUnits.push(unit);
    }
  });

  if(selectedUnits.length === 0){
    return 'none';
  } else if(selectedUnits.length === allUnits.length){
    return 'all';
  } else {
    // Check if it matches progress selection
    const progressUnits = getProgressUnits(base);
    if(progressUnits && arraysEqual(selectedUnits, progressUnits)){
      return 'progress';
    } else {
      return 'partial';
    }
  }
}

function getProgressUnits(base){
  const currentUnit = base.current_unit;
  if(!currentUnit || currentUnit === '__ALL__'){
    return base.units; // All units
  }

  // Support multiple unit naming formats: "Unit 3", "U3", "unit 3", etc.
  const match = currentUnit.match(/(?:Unit|U)\s*(\d+)/i);
  if(!match) return null;

  const currentNum = parseInt(match[1], 10);
  const progressUnits = [];

  base.units.forEach(unit => {
    // Support multiple formats for unit comparison
    const unitMatch = unit.match(/(?:Unit|U)\s*(\d+)/i);
    if(unitMatch){
      const unitNum = parseInt(unitMatch[1], 10);
      if(unitNum <= currentNum){
        progressUnits.push(unit);
      }
    }
  });

  return progressUnits.length > 0 ? progressUnits : null;
}

function arraysEqual(arr1, arr2){
  if(arr1.length !== arr2.length) return false;
  const sorted1 = [...arr1].sort();
  const sorted2 = [...arr2].sort();
  return sorted1.every((val, idx) => val === sorted2[idx]);
}

function selectToProgress(baseId){
  const base = learningBases.find(b => b.base_id === baseId);
  if(!base) return;

  const progressUnits = getProgressUnits(base);
  if(!progressUnits) {
    selectAllUnits(baseId);
    return;
  }

  // Deselect all first
  base.units.forEach(unit => {
    const checkbox = document.getElementById(`unit_${baseId}_${unit}`);
    if(checkbox) checkbox.checked = false;
  });

  // Select progress units
  progressUnits.forEach(unit => {
    const checkbox = document.getElementById(`unit_${baseId}_${unit}`);
    if(checkbox) checkbox.checked = true;
  });

  updateBaseCheckbox(baseId);
  updateUnitChipsUI(baseId);
  updateSelectionSummary(baseId);
}

function onUnitChange(baseId){
  updateBaseCheckbox(baseId);
  updateUnitChipsUI(baseId);
  updateSelectionSummary(baseId);
}

function updateBaseCheckbox(baseId){
  const base = learningBases.find(b => b.base_id === baseId);
  const checkedCount = base.units.filter(unit => {
    const cb = document.getElementById(`unit_${baseId}_${unit}`);
    return cb && cb.checked;
  }).length;

  const baseCheckbox = document.getElementById(`base_${baseId}`);

  if(checkedCount === 0){
    baseCheckbox.checked = false;
    baseCheckbox.indeterminate = false;
  }else if(checkedCount === base.units.length){
    baseCheckbox.checked = true;
    baseCheckbox.indeterminate = false;
  }else{
    baseCheckbox.checked = false;
    baseCheckbox.indeterminate = true;
  }
}

function updateUnitChipsUI(baseId){
  const base = learningBases.find(b => b.base_id === baseId);
  base.units.forEach(unit => {
    const checkbox = document.getElementById(`unit_${baseId}_${unit}`);
    const chip = document.getElementById(`chip_${baseId}_${unit}`);
    if(checkbox && chip){
      if(checkbox.checked){
        chip.classList.add('checked');
      }else{
        chip.classList.remove('checked');
      }
    }
  });
}

function updateSelectionSummary(baseId){
  const base = learningBases.find(b => b.base_id === baseId);
  const checkedCount = base.units.filter(unit => {
    const cb = document.getElementById(`unit_${baseId}_${unit}`);
    return cb && cb.checked;
  }).length;

  const summary = document.getElementById(`summary_${baseId}`);
  if(summary){
    const state = getSelectionState(baseId, base);
    let stateText = '';

    switch(state){
      case 'all':
        stateText = 'å…¨é€‰';
        break;
      case 'none':
        stateText = 'å…¨ä¸é€‰';
        break;
      case 'progress':
        stateText = 'å­¦ä¹ è¿›åº¦';
        break;
      case 'partial':
        stateText = 'è‡ªå®šä¹‰';
        break;
    }

    summary.innerHTML = `å·²é€‰ <strong>${checkedCount}</strong> / ${base.units.length} ä¸ªå•å…ƒ <span style="color:#0b5fff">[${stateText}]</span>`;
  }
}

function getSelectedBaseUnits(){
  const result = {};

  learningBases.forEach(base => {
    const baseId = base.base_id;
    const selectedUnits = [];

    base.units.forEach(unit => {
      const checkbox = document.getElementById(`unit_${baseId}_${unit}`);
      if(checkbox && checkbox.checked){
        selectedUnits.push(unit);
      }
    });

    if(selectedUnits.length > 0){
      result[baseId] = selectedUnits;
    }
  });

  return result;
}

document.getElementById('go').onclick = async () => {
  const out = document.getElementById('out');
  const previewSection = document.getElementById('previewSection');
  const topActions = document.getElementById('topActions');

  out.innerHTML = 'ç”Ÿæˆä¸­...';
  previewSection.classList.remove('show');
  topActions.style.display = 'none'; // Hide top action buttons

  const baseUnits = getSelectedBaseUnits();

  if(Object.keys(baseUnits).length === 0){
    out.innerHTML = '<p style="color:#c00">âŒ è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªèµ„æ–™åº“çš„ä¸€ä¸ªå•å…ƒ</p>';
    return;
  }

  const difficultyFilter = getDifficultyFilter();

  try{
    const data = await api('/api/practice-sessions/generate', {
      method: 'POST',
      body: JSON.stringify({
        student_id: cfg.student_id,
        base_units: baseUnits,
        total_count: parseInt(document.getElementById('total').value||'29',10),
        title: document.getElementById('title').value||'è‹±è¯­é»˜å†™å•',
        difficulty_filter: difficultyFilter,
        mix_ratio: {
          WORD: parseInt(document.getElementById('word').value||'15',10),
          PHRASE: parseInt(document.getElementById('phrase').value||'8',10),
          SENTENCE: parseInt(document.getElementById('sentence').value||'6',10)
        }
      })
    });

    // Store session data
    currentSessionData = data;

    // Show preview
    showPreview(data);
    out.innerHTML = '';
  }catch(e){
    out.innerHTML = `<p style="color:#c00">âŒ ç”Ÿæˆå¤±è´¥ï¼š${e.message}</p>`;
  }
};

function showPreview(data){
  const previewSection = document.getElementById('previewSection');
  const itemsGrid = document.getElementById('itemsGrid');
  const stats = document.getElementById('previewStats');

  // Calculate stats
  const items = data.items || [];
  const wordCount = items.filter(it => it.type === 'WORD').length;
  const phraseCount = items.filter(it => it.type === 'PHRASE').length;
  const sentenceCount = items.filter(it => it.type === 'SENTENCE').length;

  stats.innerHTML = `å…± ${items.length} é¢˜ | å•è¯ ${wordCount} | çŸ­è¯­ ${phraseCount} | å¥å­ ${sentenceCount}`;

  // Get expected counts from input fields
  const expectedCounts = {
    'WORD': parseInt(document.getElementById('word').value || '0', 10),
    'PHRASE': parseInt(document.getElementById('phrase').value || '0', 10),
    'SENTENCE': parseInt(document.getElementById('sentence').value || '0', 10)
  };

  // Group items by type
  const sections = {
    'WORD': { title: 'ä¸€ã€å•è¯é»˜å†™', items: [], expected: expectedCounts['WORD'] },
    'PHRASE': { title: 'äºŒã€çŸ­è¯­é»˜å†™', items: [], expected: expectedCounts['PHRASE'] },
    'SENTENCE': { title: 'ä¸‰ã€å¥å­é»˜å†™', items: [], expected: expectedCounts['SENTENCE'] }
  };

  items.forEach(item => {
    if(sections[item.type]){
      sections[item.type].items.push(item);
    }
  });

  // Render sections
  let html = '';
  Object.keys(sections).forEach(type => {
    const section = sections[type];
    if(section.expected > 0){  // Only show sections with expected items
      const actualCount = section.items.length;
      const isShortage = actualCount < section.expected;

      html += `
        <div class="section-group">
          <div class="section-header">
            ${section.title}ï¼ˆ${actualCount}ä¸ªï¼‰
            ${isShortage ? `<span class="shortage-warning">âš ï¸ ä¸è¶³ï¼šä»…æ‰¾åˆ° ${actualCount} ä¸ªï¼Œè®¾ç½®ä¸º ${section.expected} ä¸ª</span>` : ''}
          </div>
          <div class="section-items section-items-${type.toLowerCase()}">
            ${section.items.map((item, idx) => `
              <div class="preview-item">
                <span class="item-number">${idx + 1}.</span>
                <span class="item-answer">${item.en_text}</span>
                <span class="item-hint">${item.zh_hint || '(æ— æç¤º)'}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }
  });

  itemsGrid.innerHTML = html;
  previewSection.classList.add('show');
  topActions.style.display = 'flex'; // Show top action buttons

  // Scroll to put action buttons at top of viewport
  setTimeout(() => {
    const topActionsElement = document.getElementById('topActions');
    topActionsElement.scrollIntoView({behavior: 'smooth', block: 'start'});
  }, 100);
}

// Confirm button - show PDF links
document.getElementById('confirmBtn').onclick = () => {
  const out = document.getElementById('out');
  const data = currentSessionData;

  out.innerHTML = `
    <div style="background:#d1fae5;border:1px solid #10b981;border-radius:8px;padding:16px;margin-top:12px">
      <p style="color:#059669;font-weight:600;margin:0 0 12px 0">âœ… ç»ƒä¹ å•å·²ç”Ÿæˆï¼šSession #${data.session_id}</p>
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <a href="${data.pdf_url}" target="_blank" style="flex:1;min-width:200px;display:inline-block;padding:10px 16px;background:#fff;color:#0b5fff;text-decoration:none;border-radius:6px;font-weight:500;text-align:center;border:1px solid #0b5fff">ğŸ“„ ä¸‹è½½é»˜å†™å• PDF</a>
        <a href="${data.answer_pdf_url}" target="_blank" style="flex:1;min-width:200px;display:inline-block;padding:10px 16px;background:#fff;color:#0b5fff;text-decoration:none;border-radius:6px;font-weight:500;text-align:center;border:1px solid #0b5fff">ğŸ“‹ ä¸‹è½½ç­”æ¡ˆå• PDF</a>
        <a href="/submit.html?session_id=${data.session_id}" style="flex:1;min-width:200px;display:inline-block;padding:10px 16px;background:#10b981;color:#fff;text-decoration:none;border-radius:6px;font-weight:500;text-align:center">â†’ å»æäº¤/æ‰¹æ”¹</a>
      </div>
    </div>
  `;

  // Scroll to result
  setTimeout(() => {
    out.scrollIntoView({behavior: 'smooth', block: 'nearest'});
  }, 100);
};

// Regenerate button
document.getElementById('regenerateBtn').onclick = () => {
  document.getElementById('go').click();
};

// Adjust button
document.getElementById('adjustBtn').onclick = () => {
  const previewSection = document.getElementById('previewSection');
  const topActions = document.getElementById('topActions');
  previewSection.classList.remove('show');
  topActions.style.display = 'none'; // Hide top action buttons
  window.scrollTo({top: 0, behavior: 'smooth'});
};

// Top action buttons (duplicated controls)
document.getElementById('confirmBtnTop').onclick = () => {
  document.getElementById('confirmBtn').click(); // Reuse existing logic
};

document.getElementById('regenerateBtnTop').onclick = () => {
  document.getElementById('regenerateBtn').click(); // Reuse existing logic
};

document.getElementById('adjustBtnTop').onclick = () => {
  document.getElementById('adjustBtn').click(); // Reuse existing logic
};

// Load learning bases on page load
window.addEventListener('DOMContentLoaded', () => {
  loadLearningBases();
  updateTotal(); // Initialize total count
  updateDifficultyLabels(); // Initialize difficulty checkbox styles
  updateParamsSummary(); // Initialize params summary
});
</script>
</body>
</html>
