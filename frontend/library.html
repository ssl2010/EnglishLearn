<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>资料库维护</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <style>
    * { box-sizing: border-box; }
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;margin:0;background:#f6f7fb;color:#1a202c;line-height:1.5}
    .wrap{max-width:1280px;margin:0 auto;padding:32px 24px}
    .card{background:#fff;border-radius:16px;padding:32px;box-shadow:0 1px 3px rgba(0,0,0,.1),0 1px 2px rgba(0,0,0,.06);margin-bottom:24px}
    a{color:#0b5fff;text-decoration:none;transition:color 0.2s}
    a:hover{color:#0847cc}

    button{border:0;border-radius:10px;padding:11px 20px;background:#1a202c;color:#fff;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s;line-height:1.5}
    button:hover{background:#2d3748;transform:translateY(-1px);box-shadow:0 4px 6px rgba(0,0,0,.1)}
    button:active{transform:translateY(0)}
    button.secondary{background:#fff;color:#1a202c;border:1.5px solid #e2e8f0}
    button.secondary:hover{background:#f7fafc;border-color:#cbd5e0}
    button.danger{background:#dc2626;color:#fff}
    button.danger:hover{background:#b91c1c}

    input,select,textarea{
      padding:11px 14px;
      border-radius:10px;
      border:1.5px solid #e2e8f0;
      font-size:14px;
      transition:all 0.2s;
      width:100%;
      font-family:inherit;
      line-height:1.5;
    }
    input:focus,select:focus,textarea:focus{
      outline:none;
      border-color:#0b5fff;
      box-shadow:0 0 0 3px rgba(11,95,255,0.1);
    }
    textarea{min-height:120px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:13px}

    label{
      display:block;
      margin-bottom:8px;
      font-size:13px;
      font-weight:600;
      color:#4a5568;
      letter-spacing:0.01em;
    }

    .muted{color:#718096;font-size:13px}

    .badge{
      display:inline-block;
      padding:3px 10px;
      border-radius:12px;
      font-size:11px;
      font-weight:600;
      letter-spacing:0.02em;
    }
    .badge.system{background:#dbeafe;color:#1e40af}
    .badge.custom{background:#fef3c7;color:#92400e}
    .badge.readonly{background:#f1f5f9;color:#475569}

    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(2px)}
    .modal.active{display:flex}
    .modal-content{background:#fff;border-radius:16px;padding:32px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,.04)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid #e2e8f0}
    .modal-header h3{margin:0;font-size:20px;font-weight:700;color:#1a202c}
    .close-btn{cursor:pointer;font-size:28px;color:#718096;line-height:1;transition:color 0.2s}
    .close-btn:hover{color:#1a202c}

    .page-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:8px;
      flex-wrap:wrap;
      gap:16px;
    }
    .page-header h2{
      margin:0;
      font-size:28px;
      font-weight:700;
      color:#1a202c;
    }

    .section-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:24px;
    }
    .section-header h3{
      margin:0;
      font-size:20px;
      font-weight:700;
      color:#1a202c;
    }
    .section-meta{
      margin-top:6px;
    }

    .btn-group{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }

    .base-item{
      border:1.5px solid #e2e8f0;
      border-radius:12px;
      padding:20px;
      margin-bottom:12px;
      transition:all 0.2s;
    }
    .base-item:hover{
      border-color:#cbd5e0;
      box-shadow:0 4px 6px rgba(0,0,0,.05);
    }
    .base-item-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
    }
    .base-item-title{
      font-weight:600;
      font-size:15px;
      color:#1a202c;
      margin-bottom:6px;
    }
    .base-item-desc{
      color:#718096;
      font-size:13px;
      margin-top:8px;
      line-height:1.5;
    }

    .form-group{margin-bottom:20px}
    .form-hint{
      font-size:12px;
      color:#718096;
      margin-top:6px;
      line-height:1.4;
    }

    .empty-state{
      text-align:center;
      padding:48px 24px;
      color:#718096;
    }
    .hidden{display:none}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="section-header">
      <div>
        <h3>系统资料库列表</h3>
        <div id="systemEditHint" class="muted section-meta hidden">仅管理员可编辑</div>
      </div>
    </div>
    <div id="systemBasesList" class="muted">加载中...</div>
  </div>

  <div class="card">
    <div class="section-header">
      <h3>自定义资料库列表</h3>
    </div>
    <div id="customBasesList" class="muted">加载中...</div>
  </div>
</div>

<!-- Manual Create Base Modal -->
<div id="baseModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>手动创建资料库</h3>
      <span class="close-btn" onclick="closeBaseModal()">&times;</span>
    </div>

    <div class="form-group">
      <label>资料库名称 <span style="color:#dc2626">*</span></label>
      <input id="baseName" type="text" placeholder="例如：四年级上册英语" required maxlength="100" />
      <div class="form-hint">必填，不超过100字符</div>
    </div>

    <div class="form-group">
      <label>类型 <span style="color:#dc2626">*</span></label>
      <select id="baseIsSystem">
        <option value="false">自定义资料库</option>
        <option value="true">系统资料库</option>
      </select>
      <div class="form-hint">系统资料库可供所有学生使用</div>
    </div>

    <div class="form-group">
      <label>封面图片 (可选)</label>
      <input id="baseCoverImage" type="file" accept="image/*" />
      <div class="form-hint">上传教材封面图片，支持 JPG、PNG 等格式</div>
    </div>

    <div class="form-group">
      <label>描述 (可选)</label>
      <textarea id="baseDescription" placeholder="资料库描述" rows="3" maxlength="500"></textarea>
      <div class="form-hint">不超过500字符</div>
    </div>

    <div class="btn-group" style="justify-content:flex-end">
      <button class="secondary" onclick="closeBaseModal()">取消</button>
      <button onclick="saveBase()">创建</button>
    </div>
    <div id="createMsg" class="muted" style="margin-top:12px"></div>
  </div>
</div>

<!-- Import Base from File Modal -->
<div id="importBaseModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>从文件导入资料库</h3>
      <span class="close-btn" onclick="closeImportBaseModal()">&times;</span>
    </div>

    <div class="form-group">
      <label>选择 JSON 文件 <span style="color:#dc2626">*</span></label>
      <input id="importBaseFile" type="file" accept=".json,application/json" required />
      <div class="form-hint">
        <strong>支持的格式：</strong> EL_KB_V1_UNITMETA<br/>
        文件中应包含：<br/>
        • base: 资料库基本信息（名称、教材信息等）<br/>
        • items: 知识点列表<br/>
        • unit_meta: 单元元数据（可选）<br/><br/>
        <strong>提示：</strong>系统将自动从文件中提取所有信息，无需手动填写。
      </div>
    </div>
    <div class="form-group">
      <label>类型 <span style="color:#dc2626">*</span></label>
      <select id="importBaseIsSystem">
        <option value="false">自定义资料库</option>
        <option value="true">系统资料库</option>
      </select>
      <div class="form-hint">仅管理员可导入系统资料库</div>
    </div>

    <div class="btn-group" style="justify-content:flex-end">
      <button class="secondary" onclick="closeImportBaseModal()">取消</button>
      <button onclick="importBase()">导入</button>
    </div>
    <div id="importMsg" class="muted" style="margin-top:12px"></div>
  </div>
</div>

<script>
async function apiJSON(path, opts){
  const res = await fetch(path, Object.assign({headers:{'Content-Type':'application/json'}}, opts||{}));
  if(!res.ok){
    let errorMsg;
    try{
      const text = await res.text();
      try{
        const errorData = JSON.parse(text);
        errorMsg = errorData.detail || errorData.message || JSON.stringify(errorData);
      }catch(e){
        errorMsg = text;
      }
    }catch(e){
      errorMsg = 'Request failed';
    }
    throw new Error(errorMsg);
  }
  return res.json();
}

let isSuperAdmin = false;
let basesCache = [];

async function loadAccount(){
  try{
    const res = await apiJSON('/api/auth/me');
    isSuperAdmin = Boolean(res.account && res.account.is_super_admin);
  }catch(e){
    isSuperAdmin = false;
  }
  const hint = document.getElementById('systemEditHint');
  if(hint){
    hint.classList.toggle('hidden', isSuperAdmin);
  }
  const systemOption = document.querySelector('#baseIsSystem option[value="true"]');
  if(systemOption){
    systemOption.disabled = !isSuperAdmin;
  }
  const importSystemOption = document.querySelector('#importBaseIsSystem option[value="true"]');
  if(importSystemOption){
    importSystemOption.disabled = !isSuperAdmin;
  }
}

function renderBaseItem(b, allowEdit){
  const typeTag = b.is_system ? 'system' : 'custom';
  const typeLabel = b.is_system ? '系统' : '自定义';
  const allowExport = isSuperAdmin || !b.is_system;

  const coverHtml = b.cover_image
    ? `<img src="${b.cover_image}" alt="封面" style="width:60px;height:80px;object-fit:cover;border-radius:8px;margin-right:16px;border:1px solid #e2e8f0" />`
    : `<div style="width:60px;height:80px;background:#f0f0f0;border-radius:8px;margin-right:16px;display:flex;align-items:center;justify-content:center;color:#999;font-size:11px;text-align:center;border:1px solid #e2e8f0">无封面</div>`;

  const metaTags = [];
  if(b.education_stage && b.grade){
    metaTags.push(`${b.education_stage} ${b.grade}`);
  }else if(b.education_stage){
    metaTags.push(b.education_stage);
  }else if(b.grade){
    metaTags.push(b.grade);
  }
  if(b.term) metaTags.push(b.term);
  if(b.version) metaTags.push(b.version);
  if(b.publisher) metaTags.push(b.publisher);
  if(b.editor) metaTags.push(`主编: ${b.editor}`);

  const metaHtml = metaTags.length > 0
    ? `<div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px">
        ${metaTags.map(tag => `<span style="font-size:12px;color:#6b7280;background:#f3f4f6;padding:2px 8px;border-radius:4px">${tag}</span>`).join('')}
      </div>`
    : '';

  const readonlyBadge = !allowEdit && b.is_system
    ? '<span class="badge readonly">只读</span>'
    : '';
  const exportButton = allowExport
    ? `<button class="secondary" onclick="exportBase(${b.id}, this)" style="padding:8px 16px;font-size:13px">导出</button>`
    : '';
  const actions = allowEdit
    ? `<div class="btn-group" style="flex-shrink:0">
         ${exportButton}
         <a href="library-edit.html?base_id=${b.id}" style="padding:8px 16px;font-size:13px;background:#1a202c;color:#fff;border-radius:10px;text-decoration:none;display:inline-block;font-weight:500">编辑</a>
         <button class="danger" onclick="deleteBase(${b.id}, '${b.name}')" style="padding:8px 16px;font-size:13px">删除</button>
       </div>`
    : (allowExport
      ? `<div class="btn-group" style="flex-shrink:0">${exportButton}</div>`
      : `<div class="muted" style="flex-shrink:0">仅查看</div>`);

  return `
    <div class="base-item">
      <div class="base-item-header">
        ${coverHtml}
        <div style="flex:1">
          <div class="base-item-title">
            ${b.name}
            <span class="badge ${typeTag}">${typeLabel}</span>
            ${readonlyBadge}
          </div>
          ${b.description ? `<div class="base-item-desc">${b.description}</div>` : ''}
          ${metaHtml}
        </div>
        ${actions}
      </div>
    </div>
  `;
}

function renderBaseList(listEl, bases, allowEdit, emptyText){
  if(!listEl) return;
  if(!bases.length){
    listEl.innerHTML = `<div class="empty-state">${emptyText}</div>`;
    return;
  }
  listEl.innerHTML = bases.map(b => renderBaseItem(b, allowEdit)).join('');
}

async function loadBases(){
  const systemList = document.getElementById('systemBasesList');
  const customList = document.getElementById('customBasesList');
  try{
    const res = await apiJSON('/api/knowledge-bases');
    const bases = res.bases || [];
    basesCache = bases;
    const systemBases = bases.filter(b => b.is_system);
    const customBases = bases.filter(b => !b.is_system);
    renderBaseList(systemList, systemBases, isSuperAdmin, '暂无系统资料库');
    renderBaseList(customList, customBases, true, '暂无自定义资料库，点击"+ 手动创建"开始');
  }catch(e){
    basesCache = [];
    if(systemList){
      systemList.innerHTML = `<div class="empty-state" style="color:#dc2626">加载失败: ${e.message}</div>`;
    }
    if(customList){
      customList.innerHTML = `<div class="empty-state" style="color:#dc2626">加载失败: ${e.message}</div>`;
    }
  }
}

function openCreateBaseModal(){
  document.getElementById('baseName').value = '';
  const systemSelect = document.getElementById('baseIsSystem');
  if(systemSelect){
    systemSelect.value = 'false';
    systemSelect.disabled = !isSuperAdmin;
  }
  document.getElementById('baseCoverImage').value = '';
  document.getElementById('baseDescription').value = '';
  document.getElementById('createMsg').innerText = '';
  document.getElementById('baseModal').classList.add('active');
}

function closeBaseModal(){
  document.getElementById('baseModal').classList.remove('active');
}

function sanitizeFilename(name){
  const fallback = 'knowledge-base';
  const text = (name || '').toString().trim();
  if(!text) return fallback;
  return text.replace(/[\\/:*?"<>|]/g, '_');
}

function buildBaseExportMeta(base){
  const meta = { name: base.name };
  if(base.grade_code) meta.grade_code = base.grade_code;
  if(base.education_stage) meta.education_stage = base.education_stage;
  if(base.grade) meta.grade = base.grade;
  if(base.term) meta.term = base.term;
  if(base.version) meta.version = base.version;
  if(base.publisher) meta.publisher = base.publisher;
  if(base.editor) meta.editor = base.editor;
  if(base.description) meta.description = base.description;
  if(base.cover_image) meta.cover_image = base.cover_image;
  return meta;
}

function findBaseById(baseId){
  return basesCache.find(b => b.id === baseId);
}

function blobToDataUrl(blob){
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = () => reject(new Error('封面读取失败'));
    reader.readAsDataURL(blob);
  });
}

async function fetchCoverAsset(coverUrl){
  if(!coverUrl) return null;
  const res = await fetch(coverUrl, {cache: 'no-cache'});
  if(!res.ok){
    throw new Error('封面获取失败');
  }
  const blob = await res.blob();
  if(!blob.type || !blob.type.startsWith('image/')){
    throw new Error('封面不是图片格式');
  }
  const dataUrl = await blobToDataUrl(blob);
  return {id: 'cover', content: dataUrl};
}

async function exportBase(baseId, btn){
  const base = findBaseById(baseId);
  if(!base){
    alert('资料库信息不存在，请刷新页面后重试。');
    return;
  }
  if(!isSuperAdmin && base.is_system){
    alert('仅管理员可导出系统资料库。');
    return;
  }

  const originalText = btn ? btn.textContent : '';
  if(btn){
    if(btn.dataset.exporting === '1') return;
    btn.dataset.exporting = '1';
    btn.disabled = true;
    btn.textContent = '导出中...';
  }

  try{
    const [itemsRes, unitsRes] = await Promise.all([
      apiJSON(`/api/knowledge-bases/${baseId}/items`),
      apiJSON(`/api/knowledge-bases/${baseId}/units`)
    ]);

    const items = (itemsRes.items || []).map(item => {
      const mapped = {
        type: (item.item_type || 'WORD').toUpperCase(),
        unit_code: item.unit || '__ALL__',
        en_text: item.en_text || '',
        zh_hint: item.zh_text || ''
      };
      if(item.difficulty_tag){
        mapped.difficulty_tag = item.difficulty_tag;
      }
      return mapped;
    });

    const unitMeta = (unitsRes.units || []).map(unit => {
      const mapped = { unit_code: unit.unit_code };
      if(unit.unit_name) mapped.unit_name = unit.unit_name;
      if(unit.unit_index !== null && unit.unit_index !== undefined) mapped.unit_index = unit.unit_index;
      if(unit.description) mapped.description = unit.description;
      return mapped;
    });

    const payload = {
      format: 'EL_KB_V1_UNITMETA',
      base: buildBaseExportMeta(base),
      items,
      unit_meta: unitMeta
    };

    if(base.cover_image){
      try{
        const coverAsset = await fetchCoverAsset(base.cover_image);
        if(coverAsset){
          payload.assets = [coverAsset];
        }
      }catch(e){
        alert('封面导出失败：' + e.message);
      }
    }

    const jsonText = JSON.stringify(payload, null, 2);
    const blob = new Blob([jsonText], {type: 'application/json;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    const dateTag = new Date().toISOString().slice(0, 10);
    link.href = url;
    link.download = `${sanitizeFilename(base.name)}_${dateTag}.json`;
    document.body.appendChild(link);
    link.click();
    link.remove();
    URL.revokeObjectURL(url);

    if(btn){
      btn.textContent = '已导出';
      setTimeout(() => {
        btn.textContent = originalText || '导出';
        btn.disabled = false;
        btn.dataset.exporting = '0';
      }, 1200);
    }
  }catch(e){
    if(btn){
      btn.textContent = originalText || '导出';
      btn.disabled = false;
      btn.dataset.exporting = '0';
    }
    alert('导出失败：' + e.message);
  }
}

async function saveBase(){
  const name = document.getElementById('baseName').value.trim();
  const isSystem = isSuperAdmin && document.getElementById('baseIsSystem').value === 'true';
  const coverImageFile = document.getElementById('baseCoverImage').files[0];
  const description = document.getElementById('baseDescription').value.trim();
  const msg = document.getElementById('createMsg');

  // 验证名称
  if(!name){
    alert('请输入资料库名称');
    document.getElementById('baseName').focus();
    return;
  }
  if(name.length > 100){
    alert('资料库名称不能超过100个字符');
    document.getElementById('baseName').focus();
    return;
  }
  if(description.length > 500){
    alert('描述不能超过500个字符');
    document.getElementById('baseDescription').focus();
    return;
  }

  // 验证封面图片
  if(coverImageFile){
    if(!coverImageFile.type.startsWith('image/')){
      alert('封面必须是图片文件');
      document.getElementById('baseCoverImage').focus();
      return;
    }
    if(coverImageFile.size > 5 * 1024 * 1024){
      alert('封面图片大小不能超过 5MB');
      document.getElementById('baseCoverImage').focus();
      return;
    }
  }

  try{
    msg.innerText = '创建中...';
    msg.style.color = '#718096';

    // Create new base with basic fields only
    const createPayload = {
      name,
      grade_code: '',  // Deprecated but required
      is_system: isSystem
    };

    // Add optional description
    if(description) createPayload.description = description;

    const createRes = await apiJSON('/api/knowledge-bases', {
      method: 'POST',
      body: JSON.stringify(createPayload)
    });

    const newBaseId = createRes.base_id;

    // Upload cover image if provided
    if(coverImageFile && newBaseId){
      msg.innerText = '上传封面图片...';

      const formData = new FormData();
      formData.append('file', coverImageFile);

      const response = await fetch(`/api/knowledge-bases/${newBaseId}/cover`, {
        method: 'POST',
        body: formData
      });

      if(!response.ok){
        const text = await response.text();
        let errorMsg;
        try{
          const errorData = JSON.parse(text);
          errorMsg = errorData.detail || errorData.message || JSON.stringify(errorData);
        }catch(e){
          errorMsg = text;
        }
        throw new Error('封面上传失败：' + errorMsg);
      }
    }

    msg.innerText = '资料库创建成功！可在编辑页面添加知识点或导入教材信息。';
    msg.style.color = '#166534';

    setTimeout(() => {
      closeBaseModal();
      loadBases();
    }, 1500);
  }catch(e){
    msg.innerText = '失败：' + e.message;
    msg.style.color = '#dc2626';
  }
}

async function deleteBase(baseId, baseName){
  if(!confirm(`确定要删除资料库"${baseName}"吗？\n\n这将删除该资料库及其所有知识点，且无法恢复！`)){
    return;
  }
  try{
    await apiJSON(`/api/knowledge-bases/${baseId}`, {method: 'DELETE'});
    alert('资料库已删除');
    loadBases();
  }catch(e){
    // Display detailed error message
    const errorMsg = e.message || '删除失败';
    alert(errorMsg);
  }
}

// Import Base from File
function openImportBaseModal(){
  document.getElementById('importBaseFile').value = '';
  document.getElementById('importMsg').innerText = '';
  const importType = document.getElementById('importBaseIsSystem');
  if(importType){
    importType.value = 'false';
    importType.disabled = !isSuperAdmin;
  }
  document.getElementById('importBaseModal').classList.add('active');
}

function closeImportBaseModal(){
  document.getElementById('importBaseModal').classList.remove('active');
}

async function importBase(){
  const file = document.getElementById('importBaseFile').files[0];
  const msg = document.getElementById('importMsg');
  const importType = document.getElementById('importBaseIsSystem');
  const isSystem = isSuperAdmin && importType && importType.value === 'true';

  if(!file){
    alert('请选择要导入的文件');
    document.getElementById('importBaseFile').focus();
    return;
  }

  // 验证文件类型
  if(!file.name.endsWith('.json')){
    alert('只支持 .json 文件');
    document.getElementById('importBaseFile').focus();
    return;
  }

  // 验证文件大小（最大 10MB）
  if(file.size > 10 * 1024 * 1024){
    alert('文件大小不能超过 10MB');
    document.getElementById('importBaseFile').focus();
    return;
  }

  try{
    msg.innerText = '读取文件...';
    msg.style.color = '#718096';

    // 使用 FormData 上传文件到 import-file API
    const formData = new FormData();
    formData.append('file', file);
    formData.append('mode', 'skip');
    formData.append('is_system', isSystem ? 'true' : 'false');

    const response = await fetch('/api/knowledge-bases/import-file', {
      method: 'POST',
      body: formData
    });

    if(!response.ok){
      const text = await response.text();
      let errorMsg;
      try{
        const errorData = JSON.parse(text);
        errorMsg = errorData.detail || errorData.message || JSON.stringify(errorData);
      }catch(e){
        errorMsg = text;
      }
      throw new Error(errorMsg);
    }

    const result = await response.json();

    // 构建成功消息
    const itemsMsg = `知识点：${result.inserted || 0} 个`;
    const unitsMsg = result.units && (result.units.inserted + result.units.updated) > 0
      ? `，单元：${result.units.inserted + result.units.updated} 个`
      : '';
    const skippedMsg = result.skipped > 0 ? `，跳过重复：${result.skipped} 个` : '';

    msg.innerText = `导入成功！${itemsMsg}${unitsMsg}${skippedMsg}`;
    msg.style.color = '#166534';

    setTimeout(() => {
      closeImportBaseModal();
      loadBases();
    }, 2000);
  }catch(e){
    msg.innerText = '导入失败：' + e.message;
    msg.style.color = '#dc2626';
  }
}

// Initialize
window.addEventListener('DOMContentLoaded', async () => {
  try{
    if(window.self !== window.top){
      window.parent.postMessage({type: 'appPage', page: 'library.html'}, '*');
    }
  }catch(e){}
  await loadAccount();
  await loadBases();
});

window.addEventListener('message', (event) => {
  if(event.source !== window.parent){
    return;
  }
  if(window.location.origin !== 'null' && event.origin !== window.location.origin){
    return;
  }
  if(event.data && event.data.type === 'openCreateBase'){
    openCreateBaseModal();
  }
  if(event.data && event.data.type === 'openImportBase'){
    openImportBaseModal();
  }
});
</script>
</body>
</html>
