<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>提交与批改 v2.0</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;margin:0;background:#f6f7fb;color:#111}
    .wrap{max-width:1280px;margin:0 auto;padding:24px}
    .card{background:#fff;border-radius:14px;padding:18px;margin-bottom:16px}
    a{color:#0b5fff;text-decoration:none}
    textarea{width:100%;min-height:220px;font-family:ui-monospace,Menlo,Consolas,monospace}
    button{border:0;border-radius:10px;padding:10px 14px;background:#111;color:#fff;cursor:pointer}
    select{padding:8px;border-radius:10px;border:1px solid #ddd}
    input[type=file]{padding:10px;border:1px solid #ddd;border-radius:10px;width:100%}
    .muted{color:#666;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:14px;vertical-align:top}
    tr.row-correct{background:#e8f5e9}
    tr.row-incorrect{background:#ffebee}
    tr.row-uncertain{background:#fff7e6}
    .note-warning{color:#dc2626;font-weight:600}

    /* Alert message boxes */
    .alert{
      padding:14px 16px;
      border-radius:10px;
      margin-top:12px;
      font-size:14px;
      font-weight:500;
      display:none;
      animation:slideIn 0.3s ease
    }
    .alert.show{display:block}
    .alert-success{
      background:#d1fae5;
      color:#059669;
      border:1px solid #10b981
    }
    .alert-error{
      background:#fee2e2;
      color:#dc2626;
      border:1px solid #f87171
    }
    .alert-info{
      background:#dbeafe;
      color:#1d4ed8;
      border:1px solid #60a5fa
    }
    @keyframes slideIn{
      from{opacity:0;transform:translateY(-10px)}
      to{opacity:1;transform:translateY(0)}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h3 style="margin-top:0">上传照片</h3>
    <div class="muted">AI 识别，请先确认照片内容。</div>
    <input type="file" id="photo" accept="image/*" multiple />
    <div style="margin-top:8px;display:flex;gap:10px;flex-wrap:wrap">
      <button id="addBtn">继续添加</button>
      <button id="clearBtn">清空选择</button>
    </div>
    <div id="thumbs" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px"></div>
    <div id="debugBox" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px"></div>
    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
      <button id="analyzeBtn" disabled>开始识别</button>
      <button id="debugBtn" style="background:#f59e0b">模拟运行（调试）</button>
      <button id="confirmBtn" style="display:none">确认并入库</button>
    </div>
    <div id="confirmMsg" class="alert"></div>
    <div id="photoMsg" class="muted" style="margin-top:8px"></div>
    <div id="gradedImages" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px"></div>
    <div id="proposedBox" style="margin-top:10px;display:none"></div>
  </div>

  <!-- 手工兜底流程已移除 -->
</div>

<div id="imgModal" style="display:none;position:fixed;inset:0;background:transparent;z-index:9999;cursor:pointer;user-select:none;-webkit-user-select:none">
  <img id="imgModalPic" src="" alt="preview" style="position:absolute;max-width:90vw;max-height:90vh;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.5);border:3px solid #fff;user-select:none;-webkit-user-select:none;-webkit-user-drag:none;outline:none;cursor:grab" draggable="false" />
</div>

<script src="grading_shared.js"></script>
<script>
function getCfg(){
  const raw = localStorage.getItem('el_cfg');
  return raw ? JSON.parse(raw) : null;
}
function setCfg(cfg){
  localStorage.setItem('el_cfg', JSON.stringify(cfg || {}));
}
async function api(path, opts){
  const res = await fetch(path, Object.assign({headers:{'Content-Type':'application/json'}}, opts||{}));
  if(!res.ok){ throw new Error(await res.text()); }
  return res.json();
}

let isSuperAdmin = false;

async function loadAccount(){
  try{
    const res = await api('/api/auth/me');
    isSuperAdmin = Boolean(res.account && res.account.is_super_admin);
  }catch(e){
    isSuperAdmin = false;
  }
  // Show/hide debug button based on admin status
  const debugBtn = document.getElementById('debugBtn');
  if(debugBtn){
    debugBtn.style.display = isSuperAdmin ? 'inline-block' : 'none';
  }
}

function normalizeAnswer(s){
  if (!s) return '';
  let out = String(s).trim().toLowerCase();
  out = out.replace(/[''`]/g, "'");
  let cleaned = '';
  for (const ch of out) {
    const code = ch.charCodeAt(0);
    if (ch === "'" || /[A-Za-z0-9\s]/.test(ch) || code > 127) {
      cleaned += ch;
    }
  }
  return cleaned.replace(/\s+/g, ' ').trim();
}

function needsReview(it, llmText, refAnswer){
  if (it.is_correct !== true) return false;
  if (it.consistency_ok === false) return true;
  const llmNorm = normalizeAnswer(llmText);
  const refNorm = normalizeAnswer(refAnswer);
  return Boolean(llmNorm && refNorm && llmNorm !== refNorm);
}

function clearNoteWarning(row){
  if (!row) return;
  row.querySelectorAll('.note-warning').forEach(el => {
    el.classList.remove('note-warning');
  });
}

const cfg = getCfg();
if(!cfg){ location.href='/'; }
const {iconYes, iconNo, iconWarn} = ELGrading.getMarkIcons();
const isAllStudents = !cfg.student_id;

function setMissingBaseState(message){
  const info = document.getElementById('photoMsg');
  if(info){
    info.textContent = message || '';
  }
  document.getElementById('analyzeBtn').disabled = true;
  document.getElementById('debugBtn').disabled = true;
  document.getElementById('confirmBtn').style.display = 'none';
}

// Auto-select active base if current base_id is invalid
async function ensureValidBaseId(){
  if(!cfg.student_id){
    return;
  }
  try{
    // Get all active learning bases
    const res = await api(`/api/students/${cfg.student_id}/learning-bases?is_active=true`);
    const activeBases = res.learning_bases || [];

    if(activeBases.length === 0){
      setMissingBaseState('该学生暂无资料库，请先在学习库管理中添加资料库。');
      return;
    }

    // Check if current base_id is valid
    const currentBaseValid = activeBases.some(b => b.base_id === cfg.base_id);

    if(!cfg.base_id || !currentBaseValid){
      // Auto-select first active base
      cfg.base_id = activeBases[0].base_id;
      setCfg(cfg);
      console.log(`Auto-selected base_id=${cfg.base_id} (${activeBases[0].base_name})`);
    }
  }catch(e){
    console.error('Failed to auto-select base_id:', e);
  }
}

// Initialize on page load
Promise.all([loadAccount(), ensureValidBaseId()]).then(() => {
  if(!cfg.base_id && cfg.student_id){
    setMissingBaseState('该学生暂无资料库，请先在学习库管理中添加资料库。');
  }
  if(!cfg.student_id){
    const info = document.getElementById('photoMsg');
    if(info){
      info.textContent = '当前为全部学生，将根据练习单编号匹配学生与资料库。';
    }
  }
});

let selectedFiles = [];
let dragThumbIndex = null;

function renderThumbs(){
  const thumbs = document.getElementById('thumbs');
  thumbs.innerHTML = '';
  selectedFiles.forEach((f, idx)=>{
    const wrap = document.createElement('div');
    wrap.style.position = 'relative';
    wrap.style.width = '120px';
    wrap.style.height = '120px';
    wrap.style.cursor = 'grab';
    wrap.dataset.index = idx;  // Store index for later update
    wrap.draggable = true;
    const img = document.createElement('img');
    img.style.width = '120px';
    img.style.height = '120px';
    img.style.objectFit = 'cover';
    img.style.borderRadius = '8px';
    img.style.border = '1px solid #eee';
    img.className = 'zoomable';
    img.dataset.originalSrc = URL.createObjectURL(f);
    img.src = img.dataset.originalSrc;
    const del = document.createElement('button');
    del.textContent = '×';
    del.style.position = 'absolute';
    del.style.top = '-6px';
    del.style.right = '-6px';
    del.style.width = '22px';
    del.style.height = '22px';
    del.style.borderRadius = '50%';
    del.style.border = '0';
    del.style.background = '#111';
    del.style.color = '#fff';
    del.style.cursor = 'pointer';
    del.addEventListener('click', ()=>{
      selectedFiles.splice(idx, 1);
      renderThumbs();
    });
    wrap.addEventListener('dragstart', (e)=>{
      dragThumbIndex = idx;
      wrap.style.opacity = '0.6';
      wrap.style.cursor = 'grabbing';
      if (e.dataTransfer) {
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', String(idx));
      }
    });
    wrap.addEventListener('dragend', ()=>{
      dragThumbIndex = null;
      wrap.style.opacity = '1';
      wrap.style.cursor = 'grab';
      wrap.style.outline = '';
    });
    wrap.addEventListener('dragover', (e)=>{
      e.preventDefault();
      if (e.dataTransfer) e.dataTransfer.dropEffect = 'move';
      wrap.style.outline = '2px dashed #3b82f6';
    });
    wrap.addEventListener('dragleave', ()=>{
      wrap.style.outline = '';
    });
    wrap.addEventListener('drop', (e)=>{
      e.preventDefault();
      wrap.style.outline = '';
      const from = dragThumbIndex;
      const to = idx;
      if (from === null || from === to) return;
      const moved = selectedFiles.splice(from, 1)[0];
      const insertAt = from < to ? to - 1 : to;
      selectedFiles.splice(insertAt, 0, moved);
      renderThumbs();
    });
    wrap.appendChild(img);
    wrap.appendChild(del);
    thumbs.appendChild(wrap);
  });
  const analyzeBtn = document.getElementById('analyzeBtn');
  analyzeBtn.disabled = selectedFiles.length === 0 || (cfg.student_id && !cfg.base_id);
  document.getElementById('debugBtn').disabled = !cfg.student_id || !cfg.base_id;
}

async function uploadPhoto(){
  const msg = document.getElementById('photoMsg');
  const box = document.getElementById('proposedBox');
  const confirmBtn = document.getElementById('confirmBtn');
  if(!cfg){
    msg.textContent='请先选择学生。';
    return;
  }
  if(cfg.student_id && !cfg.base_id){
    msg.textContent='该学生暂无资料库，请先在学习库管理中添加资料库。';
    return;
  }
  if(!selectedFiles.length){ msg.textContent='请选择照片'; return; }

  // Save uploaded images for crop thumbnail generation
  window._uploadedImages = selectedFiles.slice();

  msg.textContent='上传并识别中（可能需要2-5分钟，请耐心等待）...';
  box.style.display='none';
  confirmBtn.style.display='none';
  document.getElementById('confirmMsg').textContent='';

  const fd = new FormData();
  for(const f of selectedFiles){ fd.append('files', f); }

  // Add timeout handling (5 minutes = 300 seconds)
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 300000);

  try {
    const params = new URLSearchParams();
    if(cfg.student_id) params.append('student_id', String(cfg.student_id));
    if(cfg.base_id) params.append('base_id', String(cfg.base_id));
    const res = await fetch(`/api/ai/grade-photos?${params.toString()}`, {
      method:'POST',
      body: fd,
      signal: controller.signal
    });
    clearTimeout(timeoutId);

    if(!res.ok){
      let errorText = await res.text();
      let detail = errorText || '请求失败';
      try{
        const errJson = JSON.parse(errorText);
        if(errJson && errJson.detail){
          detail = errJson.detail;
        }
      }catch(e){}
      msg.textContent='失败：' + detail;
      return;
    }
    const data = await res.json();

  window._extracted = data.items || [];
  window._gradedImageUrls = data.graded_image_urls || [];
  window._imageUrls = data.image_urls || [];
  window._pageOrder = Array.isArray(data.page_order) ? data.page_order : null;
  if (window._pageOrder && Array.isArray(window._uploadedImages) && window._uploadedImages.length) {
    const reordered = window._pageOrder.map(idx => window._uploadedImages[idx]).filter(Boolean);
    if (reordered.length === window._uploadedImages.length) {
      window._uploadedImages = reordered;
    }
  }
  window._extractedDate = data.extracted_date || null;  // Save extracted date for duplicate checking
  window._worksheetUuid = data.worksheet_uuid || null;  // Save worksheet UUID for duplicate checking
  window._uuidInfo = data.uuid_info || null;  // Save UUID info for display
  window._analysisBundleId = data.bundle_id || null;
  window._resolvedStudentId = data.resolved_student_id || null;
  window._resolvedBaseId = data.resolved_base_id || null;
  window._resolvedStudentName = data.resolved_student_name || null;

  const imgCount = data.image_count ? `；图片 ${data.image_count} 张` : '';
  let dateInfo = '';
  if (data.extracted_date) {
    dateInfo = `；试卷日期：${data.extracted_date}`;
  }

  // Add UUID info
  let uuidInfo = '';
  if (data.worksheet_uuid) {
    uuidInfo = `；试卷编号：${data.worksheet_uuid}`;
  }

  let resolvedInfo = '';
  if(window._resolvedStudentName){
    resolvedInfo = `；学生：${window._resolvedStudentName}`;
  }
  msg.textContent = `识别完成${imgCount}${dateInfo}${uuidInfo}${resolvedInfo}`;

  // Display UUID warning if inconsistent
  if (data.uuid_info && data.uuid_info.warning) {
    msg.innerHTML = msg.textContent + `<br><span style="color:#e5484d;font-weight:500">${data.uuid_info.warning}</span>`;
  }

  if(data.matched_session){
    const ms = data.matched_session;
    const current = msg.innerHTML || msg.textContent;
    msg.innerHTML = current + `；匹配练习单 #${ms.session_id}（${Math.round(ms.match_ratio*100)}%）`;
  }else{
    const current = msg.innerHTML || msg.textContent;
    msg.innerHTML = current + '；未匹配到练习单';
  }
  if(data.debug_overlay_urls && data.debug_overlay_urls.length){
    msg.textContent += `（调试图 ${data.debug_overlay_urls.length} 张）`;
    const debugBox = document.getElementById('debugBox');
    debugBox.innerHTML = '';
    for(const u of data.debug_overlay_urls){
      const img = document.createElement('img');
      img.src = u;
      img.className = 'zoomable';
      img.style.width = '120px';
      img.style.height = '120px';
      img.style.objectFit = 'cover';
      img.style.borderRadius = '8px';
      img.style.border = '1px dashed #888';
      debugBox.appendChild(img);
    }
  }else{
    document.getElementById('debugBox').innerHTML = '';
  }

  // Update thumbnails with graded images (replace original thumbnails)
  if(data.graded_image_urls && data.graded_image_urls.length){
    const thumbs = document.getElementById('thumbs');
    const thumbWraps = thumbs.querySelectorAll('[data-index]');

    data.graded_image_urls.forEach((url, idx) => {
      if(!url || idx >= thumbWraps.length) return;

      const wrap = thumbWraps[idx];
      const img = wrap.querySelector('img');
      if(img){
        // Store graded URL and update thumbnail
        img.dataset.gradedSrc = url;
        img.src = url;
        // Add green border to indicate graded
        img.style.border = '2px solid #07a86c';
      }
    });

    // Clear the separate graded images area
    document.getElementById('gradedImages').innerHTML = '';
  }else{
    document.getElementById('gradedImages').innerHTML = '';
  }

  let html = '<table style="width:100%;border-collapse:collapse">';
  html += '<tr>'+
    '<th>题号</th><th>题目/提示</th><th>识别结果</th><th>是否正确</th><th>参考答案</th><th>入库</th><th>备注</th><th>识别图片</th>'+
    '</tr>';

  for(const it of window._extracted){
    // Insert section header row if this item has section_title
    if (it.section_title && it.section_title.trim()) {
      html += `<tr style="background:#f0f9ff">
        <td colspan="9" style="padding:12px 8px;font-weight:600;font-size:16px;color:#0369a1;border-top:2px solid #0ea5e9">
          ${it.section_title.replace(/</g,'&lt;')}
        </td>
      </tr>`;
    }

    const conf = (it.confidence!=null) ? (Math.round(it.confidence*100)+'%') : '缺失';
    const isCorrectMissing = (it.is_correct === null || it.is_correct === undefined);
    // In "mark only errors" mode, missing/null should default to correct (true)
    const isCorrect = isCorrectMissing ? true : (it.is_correct === true);
    const rawLlmText = it.llm_text || '';
    const rawOcrText = it.ocr_text || '';
    const rawRefAnswer = it.matched_en_text || '';
    const llmText = rawLlmText.replace(/</g,'&lt;');
    const ocrText = rawOcrText.replace(/</g,'&lt;');
    const refAnswer = rawRefAnswer.replace(/</g,'&lt;');

    // Row background color: based on LLM result; warn on OCR mismatch or ref mismatch
    const needsReviewState = needsReview(it, rawLlmText, rawRefAnswer);
    const rowClass = needsReviewState ? 'row-uncertain' : (isCorrect ? 'row-correct' : 'row-incorrect');
    const markState = needsReviewState ? 'warn' : (isCorrect ? 'correct' : 'incorrect');
    const markIcon = needsReviewState ? iconWarn : (isCorrect ? iconYes : iconNo);
    const markAlt = needsReviewState ? '待确认' : (isCorrect ? '正确' : '错误');

    // Format LLM text: highlight spelling errors based on note field + comparison
    const formattedLlmText = ELGrading.formatLlmText(
      rawLlmText,
      rawRefAnswer,
      it.note || '',
      it.section_type || '',
      isCorrect
    );

    // Build note text: combine LLM note + inconsistency warning
    const noteText = ELGrading.buildNoteText(it.note || '', it.consistency_ok);

    // Generate crop thumbnail if bbox available
    let cropThumb = '';
    if (it.crop_url) {
      // Use server-generated crop image (works for both normal and debug mode)
      cropThumb = `<img src="${it.crop_url}" alt="crop" class="zoomable" style="width:80px;height:40px;object-fit:contain;border:1px solid #ddd;border-radius:4px;cursor:pointer" />`;
    } else if (it.handwriting_bbox || it.line_bbox) {
      // Prefer client-side crop in the grading page (works before confirm even if bundle files are disabled).
      const bbox = it.handwriting_bbox || it.line_bbox;
      const pageIdx = it.page_index || 1;
      cropThumb = `<img class="crop-thumb" data-pos="${it.position}" data-page="${pageIdx}" data-bbox="${bbox.join(',')}"
                       src="" alt="crop" style="width:80px;height:40px;object-fit:contain;border:1px solid #ddd;border-radius:4px;cursor:pointer" />`;
    } else if (window._analysisBundleId && (it.position || it.position === 0) && (it.handwriting_bbox || it.line_bbox)) {
      // Fallback: ask server to generate crop dynamically from stored bbox.
      cropThumb = `<img src="/media/crops/on-demand/${encodeURIComponent(window._analysisBundleId)}/${encodeURIComponent(it.position)}.jpg" alt="crop" class="zoomable" style="width:80px;height:40px;object-fit:contain;border:1px solid #ddd;border-radius:4px;cursor:pointer" />`;
    }

    // Add page link only if no crop available (unanswered items)
    let imageCell = cropThumb;
    if (!cropThumb) {
      const pageIdx = it.page_index || 1;
      const pageIdx0 = Math.max(0, pageIdx - 1);
      if (window._gradedImageUrls && window._gradedImageUrls[pageIdx0]) {
        imageCell = `<a href="#" class="page-link" data-page-url="${window._gradedImageUrls[pageIdx0]}"
                        style="color:#0b5fff;text-decoration:none;font-size:13px"
                        title="第${pageIdx}页完整图">查看练习单</a>`;
      }
    }

    html += `<tr class="${rowClass}">
      <td>${it.q || it.position}</td>
      <td>${(it.zh_hint||'').replace(/</g,'&lt;')}</td>
      <td>${formattedLlmText}</td>
      <td>
        <button type="button" class="markBtn" data-pos="${it.position}" data-state="${markState}" style="background:transparent;border:0;cursor:pointer">
          <img src="${markIcon}" alt="${markAlt}" />
        </button>
        ${isCorrectMissing ? '<span class="muted" style="color:#c00;margin-left:6px">缺失</span>' : ''}
      </td>
      <td>${refAnswer}</td>
      <td>
        ${it.matched_item_id
          ? `<input type="checkbox" data-pos="${it.position}" data-role="include" checked />`
          : `<span class="muted" style="color:#999" title="未匹配到知识库，无法入库">—</span>`
        }
      </td>
      <td><span class="muted">${noteText}</span></td>
      <td>${imageCell}</td>
    </tr>`;
  }
  html += '</table>';

  box.innerHTML = html;
  box.style.display='block';
  confirmBtn.style.display='inline-block';

  // Generate crop thumbnails from original images
  generateCropThumbnails();

  document.querySelectorAll('.markBtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const curState = btn.getAttribute('data-state');
      const nextState = (curState === 'warn') ? 'correct' : (curState === 'correct' ? 'incorrect' : 'correct');
      btn.setAttribute('data-state', nextState);
      const img = btn.querySelector('img');
      img.src = nextState === 'correct' ? iconYes : iconNo;
      img.alt = nextState === 'correct' ? '正确' : '错误';
      const row = btn.closest('tr');
      if (row) {
        row.classList.toggle('row-correct', nextState === 'correct');
        row.classList.toggle('row-incorrect', nextState === 'incorrect');
        row.classList.toggle('row-uncertain', nextState === 'warn');
        clearNoteWarning(row);
      }
    });
  });

  } catch(err) {
    clearTimeout(timeoutId);
    msg.textContent = '识别失败：' + (err.name === 'AbortError' ?
      '请求超时（超过5分钟），请检查网络连接或稍后重试' :
      err.message || '未知错误');
    console.error('Upload photo error:', err);
  }
}

function generateCropThumbnails(){
  // Generate crop thumbnails from uploaded images (fallback to server image URLs)
  if (!window._uploadedImages && !window._imageUrls) return;

  document.querySelectorAll('.crop-thumb').forEach(async (thumb) => {
    const pageIdx = parseInt(thumb.getAttribute('data-page') || '1');
    const pageIdx0 = Math.max(0, pageIdx - 1);
    const bboxStr = thumb.getAttribute('data-bbox');
    if (!bboxStr) return;

    const bbox = bboxStr.split(',').map(parseFloat);
    if (bbox.length !== 4) return;

    const imgFile = (window._uploadedImages || [])[pageIdx0];
    const imgUrl = (window._imageUrls || [])[pageIdx0];
    if (!imgFile && !imgUrl) return;

    try {
      const img = await loadImage(imgFile || imgUrl);
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      // bbox is [x1, y1, x2, y2] in normalized coords (0-1)
      const x = bbox[0] * img.width;
      const y = bbox[1] * img.height;
      const w = (bbox[2] - bbox[0]) * img.width;
      const h = (bbox[3] - bbox[1]) * img.height;

      // Add padding
      const padding = 10;
      const cropX = Math.max(0, x - padding);
      const cropY = Math.max(0, y - padding);
      const cropW = Math.min(img.width - cropX, w + padding * 2);
      const cropH = Math.min(img.height - cropY, h + padding * 2);

      canvas.width = cropW;
      canvas.height = cropH;
      ctx.drawImage(img, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

      thumb.src = canvas.toDataURL('image/jpeg', 0.8);
    } catch (err) {
      console.error('Failed to generate crop thumbnail:', err);
    }
  });
}

function loadImage(source) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = reject;
    if (typeof source === 'string') {
      img.crossOrigin = 'anonymous';
      img.src = source;
    } else {
      img.src = URL.createObjectURL(source);
    }
  });
}

async function confirmMarks(forceDuplicate = false, ignoreWarnings = false){
  const msg = document.getElementById('confirmMsg');
  msg.className = 'alert alert-info show';
  msg.textContent='⏳ 提交中...';
  try{
    if(!window._extracted || !window._extracted.length) throw new Error('没有可确认的识别结果。');
    const includeMap = {};
    const correctMap = {};
    const warnPositions = new Set();
    document.querySelectorAll('#proposedBox input[type=checkbox]').forEach(cb=>{
      const pos = cb.getAttribute('data-pos');
      const role = cb.getAttribute('data-role');
      if(role === 'include'){ includeMap[pos] = cb.checked; }
    });
    document.querySelectorAll('#proposedBox .markBtn').forEach(btn=>{
      const pos = btn.getAttribute('data-pos');
      const state = btn.getAttribute('data-state');
      if (state === 'warn') {
        warnPositions.add(pos);
        return;
      }
      correctMap[pos] = state === 'correct';
    });
    if (warnPositions.size > 0 && !ignoreWarnings) {
      msg.className = 'alert alert-error show';
      msg.innerHTML = `
        ⚠️ <strong>还有 ${warnPositions.size} 题待确认</strong><br>
        请先人工判断这些题目的正确与否，或选择忽略它们不入库。<br>
        <div style="margin-top:10px;display:flex;gap:10px">
          <button onclick="confirmMarks(false, true)" style="background:#f59e0b;padding:8px 16px;border-radius:6px">忽略并提交</button>
          <button onclick="document.getElementById('confirmMsg').classList.remove('show')" style="background:#6b7280;padding:8px 16px;border-radius:6px">继续修正</button>
        </div>
      `;
      return;
    }
    const items = window._extracted.map(it=>{
      // Force include=false for items without matched_item_id
      const hasMatch = !!(it.matched_item_id);
      const isWarn = warnPositions.has(String(it.position));
      const shouldInclude = hasMatch && (includeMap[it.position] !== false) && !(ignoreWarnings && isWarn);

      // Use user's manual mark if exists, otherwise use AI's original judgment
      const posKey = String(it.position);
      const userMarked = Object.prototype.hasOwnProperty.call(correctMap, posKey);
      const isCorrect = userMarked ? correctMap[posKey] : (it.is_correct !== false);

      return {
        position: it.position,
        q: it.q,
        zh_hint: it.zh_hint || '',
        student_text: it.llm_text || '',
        llm_text: it.llm_text || '',
        ocr_text: it.ocr_text || '',
        matched_item_id: it.matched_item_id || null,
        include: shouldInclude,  // Only include if has match AND checkbox is checked
        is_correct: isCorrect,  // Use manual mark if exists, otherwise AI judgment
        source: 'llm',
        section_title: it.section_title || '',
        section_type: it.section_type || '',
        note: it.note || '',
        confidence: it.confidence,
        consistency_ok: it.consistency_ok,
        consistency_ratio: it.consistency_ratio,
        page_index: it.page_index,
        handwriting_bbox: it.handwriting_bbox,
        line_bbox: it.line_bbox,
        crop_url: it.crop_url,
        ocr_match_ratio: it.ocr_match_ratio,
        match_method: it.match_method
      };
    });

    // Debug: Show summary before submitting
    const includedItems = items.filter(it => it.include);
    const correctCount = includedItems.filter(it => it.is_correct).length;
    const manualMarkedCount = includedItems.filter(it => Object.prototype.hasOwnProperty.call(correctMap, String(it.position))).length;
    console.log('=== Confirm Summary ===');
    console.log(`Total items: ${items.length}`);
    console.log(`Included items: ${includedItems.length}`);
    console.log(`Correct items: ${correctCount}`);
    console.log(`Manually marked: ${manualMarkedCount}`);
    console.log('Items:', includedItems.map(it => ({
      pos: it.position,
      hint: it.zh_hint?.substring(0, 10),
      correct: it.is_correct,
      manual: Object.prototype.hasOwnProperty.call(correctMap, String(it.position)) ? 'yes' : 'no'
    })));

    const submitStudentId = cfg.student_id || window._resolvedStudentId;
    const submitBaseId = cfg.base_id || window._resolvedBaseId;
    if(!submitStudentId || !submitBaseId){
      throw new Error('未能匹配练习单对应的学生或资料库。');
    }
    const r = await api(`/api/ai/confirm-extracted`, {
      method:'POST',
      body: JSON.stringify({
        student_id: submitStudentId,
        base_id: submitBaseId,
        items: items,
        extracted_date: window._extractedDate,
        worksheet_uuid: window._worksheetUuid,  // Add UUID for duplicate checking
        force_duplicate: forceDuplicate,
        bundle_id: window._analysisBundleId
      })
    });

    // Check for duplicate warning
    if(r.duplicate_warning && !forceDuplicate){
      msg.className = 'alert alert-error show';
      const identifier = r.existing_uuid || r.existing_date || '未知';
      const identifierLabel = r.existing_uuid ? '试卷编号' : '日期';
      const existingAccuracy = r.existing_accuracy?.toFixed(1) || '0.0';
      msg.innerHTML = `
        ⚠️ <strong>检测到重复提交</strong><br>
        ${identifierLabel} ${identifier} 的试卷已经提交过：共 ${r.existing_total} 题，正确 ${r.existing_correct} 题，正确率 ${existingAccuracy}%<br>
        若继续提交，将作为同一练习单下的新增提交记录保存（便于查看多次练习结果）。<br>
        <div style="margin-top:10px;display:flex;gap:10px">
          <button onclick="confirmMarks(true, ${ignoreWarnings ? 'true' : 'false'})" style="background:#10b981;padding:8px 16px;border-radius:6px">继续提交（新增记录）</button>
          <button onclick="document.getElementById('confirmMsg').classList.remove('show')" style="background:#6b7280;padding:8px 16px;border-radius:6px">取消</button>
        </div>
      `;
      return;
    }

    msg.className = 'alert alert-success show';
    msg.textContent = `✅ 已入库：正确 ${r.correct}/${r.total}，正确率 ${(r.accuracy*100).toFixed(1)}%`;
  }catch(e){
    msg.className = 'alert alert-error show';
    msg.textContent='❌ 入库失败：'+e.message;
    console.error('Confirm marks error:', e);
  }
}


// events
document.getElementById('photo').addEventListener('change', (e)=>{
  const files = Array.from(e.target.files || []);
  if(files.length){
    selectedFiles = selectedFiles.concat(files);
    renderThumbs();
  }
  e.target.value = '';
});
document.getElementById('analyzeBtn').addEventListener('click', uploadPhoto);
document.getElementById('debugBtn').addEventListener('click', async ()=>{
  const msg = document.getElementById('photoMsg');
  const box = document.getElementById('proposedBox');
  const confirmBtn = document.getElementById('confirmBtn');
  if(!cfg || !cfg.student_id || !cfg.base_id){
    msg.textContent='该学生暂无资料库，请先在学习库管理中添加资料库。';
    return;
  }

  msg.textContent='加载调试数据中...';
  box.style.display='none';
  confirmBtn.style.display='none';
  document.getElementById('confirmMsg').textContent='';

  try {
    const res = await fetch(`/api/ai/grade-photos-debug?student_id=${cfg.student_id}&base_id=${cfg.base_id}`, {method:'POST'});
    if(!res.ok){ msg.textContent='失败：'+(await res.text()); return; }
    const data = await res.json();

    window._extracted = data.items || [];
    const gradedUrls = (data.graded_image_urls || []).filter(Boolean);
    const imageUrls = (data.image_urls || []).filter(Boolean);
    window._imageUrls = imageUrls;
    window._pageOrder = Array.isArray(data.page_order) ? data.page_order : null;
    window._gradedImageUrls = gradedUrls.length ? gradedUrls : imageUrls;
    window._extractedDate = data.extracted_date || null;  // Save extracted date for duplicate checking
    window._worksheetUuid = data.worksheet_uuid || null;  // Save worksheet UUID for duplicate checking
    window._uuidInfo = data.uuid_info || null;  // Save UUID info for display
    window._analysisBundleId = data.bundle_id || null;
    if (window._pageOrder && Array.isArray(window._uploadedImages) && window._uploadedImages.length) {
      const reordered = window._pageOrder.map(idx => window._uploadedImages[idx]).filter(Boolean);
      if (reordered.length === window._uploadedImages.length) {
        window._uploadedImages = reordered;
      }
    }

    const imgCount = data.image_count ? `；图片 ${data.image_count} 张` : '';
    let dateInfo = '';
    if (data.extracted_date) {
      dateInfo = `；试卷日期：${data.extracted_date}`;
    }

    // Add UUID info
    let uuidInfo = '';
    if (data.worksheet_uuid) {
      uuidInfo = `；试卷编号：${data.worksheet_uuid}`;
    }

    msg.textContent = `调试数据加载完成${imgCount}${dateInfo}${uuidInfo}`;

    // Display UUID warning if inconsistent
    if (data.uuid_info && data.uuid_info.warning) {
      msg.innerHTML = msg.textContent + `<br><span style="color:#e5484d;font-weight:500">${data.uuid_info.warning}</span>`;
    }

    if(data.matched_session){
      const ms = data.matched_session;
      const current = msg.innerHTML || msg.textContent;
      msg.innerHTML = current + `；匹配练习单 #${ms.session_id}（${Math.round(ms.match_ratio*100)}%）`;
    }else{
      msg.textContent += '；未匹配到练习单';
    }

    // Clear debug overlay box in debug mode (we'll show graded images in thumbs instead)
    document.getElementById('debugBox').innerHTML = '';

    // In debug mode, always clear and recreate thumbnails with graded images only
    const thumbUrls = gradedUrls.length ? gradedUrls : imageUrls;
    if(thumbUrls.length){
      const thumbs = document.getElementById('thumbs');

      // Clear all existing thumbnails and files (debug mode should only show graded images)
      thumbs.innerHTML = '';
      selectedFiles = [];

      // Create thumbnails from graded images
      thumbUrls.forEach((url, idx) => {
        if(!url) return;

        const wrap = document.createElement('div');
        wrap.style.position = 'relative';
        wrap.style.width = '120px';
        wrap.style.height = '120px';
        wrap.dataset.index = idx;

        const img = document.createElement('img');
        img.style.width = '120px';
        img.style.height = '120px';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '8px';
        img.style.border = gradedUrls.length ? '2px solid #07a86c' : '1px solid #ddd';
        img.className = 'zoomable';
        img.src = url;
        img.dataset.gradedSrc = url;

        wrap.appendChild(img);
        thumbs.appendChild(wrap);
      });

      // Clear the separate graded images area
      document.getElementById('gradedImages').innerHTML = '';
    }else{
      document.getElementById('gradedImages').innerHTML = '';
    }

    const iconYes = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><circle cx="10" cy="10" r="9" fill="#07a86c"/><path d="M5 10.5l3 3 7-7" stroke="white" stroke-width="2.2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>');
    const iconNo = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><circle cx="10" cy="10" r="9" fill="#e5484d"/><path d="M6.2 6.2l7.6 7.6M13.8 6.2l-7.6 7.6" stroke="white" stroke-width="2.2" fill="none" stroke-linecap="round"/></svg>');
    const iconWarn = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><circle cx="10" cy="10" r="9" fill="#f59e0b"/><path d="M10 5v6" stroke="white" stroke-width="2.2" stroke-linecap="round"/><circle cx="10" cy="15" r="1.4" fill="white"/></svg>');

    // Render table (same as uploadPhoto)
    let html = '<table style="width:100%;border-collapse:collapse">';
    html += '<tr>'+
      '<th>题号</th><th>题目/提示</th><th>识别结果</th><th>是否正确</th><th>参考答案</th><th>入库</th><th>备注</th><th>识别图片</th>'+
      '</tr>';

    for(const it of window._extracted){
      // Same rendering logic as uploadPhoto
      if (it.section_title && it.section_title.trim()) {
        html += `<tr style="background:#f0f9ff">
          <td colspan="9" style="padding:12px 8px;font-weight:600;font-size:16px;color:#0369a1;border-top:2px solid #0ea5e9">
            ${it.section_title.replace(/</g,'&lt;')}
          </td>
        </tr>`;
      }

      const conf = (it.confidence!=null) ? (Math.round(it.confidence*100)+'%') : '缺失';
      const isCorrectMissing = (it.is_correct === null || it.is_correct === undefined);
      // In "mark only errors" mode, missing/null should default to correct (true)
      const isCorrect = isCorrectMissing ? true : (it.is_correct === true);
      const rawLlmText = it.llm_text || '';
      const rawRefAnswer = it.matched_en_text || '';
      const llmText = rawLlmText.replace(/</g,'&lt;');
      const refAnswer = rawRefAnswer.replace(/</g,'&lt;');

      const needsReviewState = needsReview(it, rawLlmText, rawRefAnswer);
      const rowClass = needsReviewState ? 'row-uncertain' : (isCorrect ? 'row-correct' : 'row-incorrect');
      const markState = needsReviewState ? 'warn' : (isCorrect ? 'correct' : 'incorrect');
      const markIcon = needsReviewState ? iconWarn : (isCorrect ? iconYes : iconNo);
      const markAlt = needsReviewState ? '待确认' : (isCorrect ? '正确' : '错误');

      const formattedLlmText = ELGrading.formatLlmText(
        rawLlmText,
        rawRefAnswer,
        it.note || '',
        it.section_type || '',
        isCorrect
      );

      const noteText = ELGrading.buildNoteText(it.note || '', it.consistency_ok);

      let cropThumb = '';
      if (it.crop_url) {
        // Use server-generated crop image (works for both normal and debug mode)
        cropThumb = `<img src="${it.crop_url}" alt="crop" class="zoomable" style="width:80px;height:40px;object-fit:contain;border:1px solid #ddd;border-radius:4px;cursor:pointer" />`;
      } else if (it.handwriting_bbox || it.line_bbox) {
        // Prefer client-side crop in the grading page (works before confirm even if bundle files are disabled).
        const bbox = it.handwriting_bbox || it.line_bbox;
        const pageIdx = it.page_index || 1;
        cropThumb = `<img class="crop-thumb" data-pos="${it.position}" data-page="${pageIdx}" data-bbox="${bbox.join(',')}"
                         src="" alt="crop" style="width:80px;height:40px;object-fit:contain;border:1px solid #ddd;border-radius:4px;cursor:pointer" />`;
      } else if (window._analysisBundleId && (it.position || it.position === 0) && (it.handwriting_bbox || it.line_bbox)) {
        // Fallback: ask server to generate crop dynamically from stored bbox.
        cropThumb = `<img src="/media/crops/on-demand/${encodeURIComponent(window._analysisBundleId)}/${encodeURIComponent(it.position)}.jpg" alt="crop" class="zoomable" style="width:80px;height:40px;object-fit:contain;border:1px solid #ddd;border-radius:4px;cursor:pointer" />`;
      }

      // Add page link only if no crop available (unanswered items)
      let imageCell = cropThumb;
      if (!cropThumb) {
        const pageIdx = it.page_index || 1;
        const pageIdx0 = Math.max(0, pageIdx - 1);
        if (window._gradedImageUrls && window._gradedImageUrls[pageIdx0]) {
          imageCell = `<a href="#" class="page-link" data-page-url="${window._gradedImageUrls[pageIdx0]}"
                          style="color:#0b5fff;text-decoration:none;font-size:13px"
                          title="第${pageIdx}页完整图">查看练习单</a>`;
        }
      }

      html += `<tr class="${rowClass}">
        <td>${it.q || it.position}</td>
        <td>${(it.zh_hint||'').replace(/</g,'&lt;')}</td>
        <td>${formattedLlmText}</td>
        <td>
          <button type="button" class="markBtn" data-pos="${it.position}" data-state="${markState}" style="background:transparent;border:0;cursor:pointer">
            <img src="${markIcon}" alt="${markAlt}" />
          </button>
          ${isCorrectMissing ? '<span class="muted" style="color:#c00;margin-left:6px">缺失</span>' : ''}
        </td>
        <td>${refAnswer}</td>
        <td>
          ${it.matched_item_id
            ? `<input type="checkbox" data-pos="${it.position}" data-role="include" checked />`
            : `<span class="muted" style="color:#999" title="未匹配到知识库，无法入库">—</span>`
          }
        </td>
        <td><span class="muted">${noteText}</span></td>
        <td>${imageCell}</td>
      </tr>`;
    }
    html += '</table>';

    box.innerHTML = html;
    box.style.display='block';
    confirmBtn.style.display='inline-block';

    // Add event handlers
    document.querySelectorAll('.markBtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const curState = btn.getAttribute('data-state');
        const nextState = (curState === 'warn') ? 'correct' : (curState === 'correct' ? 'incorrect' : 'correct');
        btn.setAttribute('data-state', nextState);
        const img = btn.querySelector('img');
        img.src = nextState === 'correct' ? iconYes : iconNo;
        img.alt = nextState === 'correct' ? '正确' : '错误';
        const row = btn.closest('tr');
        if (row) {
          row.classList.toggle('row-correct', nextState === 'correct');
          row.classList.toggle('row-incorrect', nextState === 'incorrect');
          row.classList.toggle('row-uncertain', nextState === 'warn');
          clearNoteWarning(row);
        }
      });
    });

  } catch(e) {
    msg.textContent='调试失败：'+e.message;
  }
});
document.getElementById('addBtn').addEventListener('click', ()=>{
  document.getElementById('photo').click();
});
document.getElementById('clearBtn').addEventListener('click', ()=>{
  selectedFiles = [];
  renderThumbs();
});

ELGrading.initImageModal();
document.getElementById('confirmBtn').addEventListener('click', () => confirmMarks(false));

if(cfg && cfg.student_id && !cfg.base_id){
  setMissingBaseState('该学生暂无资料库，请先在学习库管理中添加资料库。');
}
</script>
</body>
</html>
