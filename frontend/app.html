<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EnglishLearn</title>
  <style>
    * { box-sizing: border-box; }
    body{margin:0;font-family:system-ui,Segoe UI,Arial,sans-serif;background:#f6f7fb;color:#1a202c;height:100vh}
    .app{display:flex;height:100vh}
    .sidebar{width:220px;background:#0f172a;color:#e2e8f0;display:flex;flex-direction:column;padding:20px 16px}
    .brand{font-weight:700;font-size:18px;margin-bottom:20px}
    .menu{display:flex;flex-direction:column;gap:6px}
    .menu button{background:transparent;border:0;color:#cbd5e1;text-align:left;padding:10px 12px;border-radius:10px;font-size:14px;cursor:pointer}
    .menu button.active{background:#1e293b;color:#fff}
    .menu button:hover{background:#1e293b;color:#fff}
    .main{flex:1;display:flex;flex-direction:column}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:#fff;border-bottom:1px solid #e2e8f0;gap:16px}
    .topbar-left{display:flex;align-items:center;gap:18px;flex-wrap:wrap}
    select{min-width:180px;padding:8px 10px;border-radius:10px;border:1px solid #e2e8f0;font-size:13px}
    .top-actions{display:flex;align-items:center;gap:10px}
    .btn{border:1px solid #e2e8f0;background:#fff;color:#0f172a;padding:8px 12px;border-radius:10px;font-size:13px;cursor:pointer}
    .btn.primary{background:#0f172a;color:#fff;border-color:#0f172a}
    .content{flex:1;position:relative}
    iframe{width:100%;height:100%;border:0;background:#fff}
    .hidden{display:none}
    .page-title{font-size:18px;font-weight:700;color:#0f172a}
    .student-picker{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .student-cards{display:flex;gap:10px;flex-wrap:wrap}
    .student-card{display:flex;align-items:center;gap:10px;border:1px solid #e2e8f0;background:#fff;border-radius:999px;padding:6px 12px;cursor:pointer}
    .student-card.active{border-color:#0f172a;box-shadow:0 0 0 2px rgba(15,23,42,.08)}
    .student-avatar{width:44px;height:44px;border-radius:50%;border:1px solid #e2e8f0;background:#fff;display:flex;align-items:center;justify-content:center;font-size:22px;overflow:hidden}
    .student-avatar img{width:100%;height:100%;object-fit:cover}
    .student-text{display:flex;flex-direction:column;align-items:flex-start;line-height:1.1}
    .student-name{font-size:14px;font-weight:600;color:#0f172a}
    .student-grade{font-size:12px;color:#64748b}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">EnglishLearn</div>
      <div id="menu" class="menu"></div>
    </aside>
    <div class="main">
      <div class="topbar">
        <div class="topbar-left">
          <div id="pageTitle" class="page-title hidden"></div>
          <div id="studentPicker" class="student-picker hidden">
            <div id="studentCards" class="student-cards hidden"></div>
          </div>
        </div>
        <div class="top-actions">
          <button id="libraryCreateBtn" class="btn primary hidden">+ æ‰‹åŠ¨åˆ›å»º</button>
          <button id="libraryImportBtn" class="btn hidden">ä»Žæ–‡ä»¶å¯¼å…¥</button>
          <button id="newStudentBtn" class="btn primary hidden">æ–°å»ºå­¦ç”Ÿ</button>
          <button id="logoutBtn" class="btn">é€€å‡ºç™»å½•</button>
        </div>
      </div>
      <div class="content">
        <iframe id="appFrame" title="app-frame"></iframe>
      </div>
    </div>
  </div>

  <script>
    const menuItems = [
      {label: 'æ¦‚è§ˆ', src: 'dashboard.html'},
      {label: 'ç”Ÿæˆç»ƒä¹ å•', src: 'generate.html'},
      {label: 'æäº¤ / æ‰¹æ”¹', src: 'submit.html'},
      {label: 'ç»ƒä¹ å•ç®¡ç†', src: 'practice.html'},
      {label: 'å­¦ä¹ åº“ç®¡ç†', src: 'knowledge.html'},
      {label: 'èµ„æ–™åº“ç»´æŠ¤', src: 'library.html'},
      {label: 'å­¦ç”Ÿç®¡ç†', src: 'profile.html'}
    ];

    const AVATARS = [
      {id: 'rabbit', name: 'å…”å­', emoji: 'ðŸ°'},
      {id: 'fox', name: 'ç‹ç‹¸', emoji: 'ðŸ¦Š'},
      {id: 'lion', name: 'ç‹®å­', emoji: 'ðŸ¦'},
      {id: 'tiger', name: 'è€è™Ž', emoji: 'ðŸ¯'},
      {id: 'panda', name: 'ç†ŠçŒ«', emoji: 'ðŸ¼'},
      {id: 'koala', name: 'è€ƒæ‹‰', emoji: 'ðŸ¨'},
      {id: 'dog', name: 'å°ç‹—', emoji: 'ðŸ¶'},
      {id: 'cat', name: 'å°çŒ«', emoji: 'ðŸ±'}
    ];

    const GRADES = [
      {code: '', label: 'æœªè®¾ç½®'},
      {code: 'K1', label: 'å¹¼å„¿å›­ å°ç­'},
      {code: 'K2', label: 'å¹¼å„¿å›­ ä¸­ç­'},
      {code: 'K3', label: 'å¹¼å„¿å›­ å¤§ç­'},
      {code: 'G1', label: 'å°å­¦ ä¸€å¹´çº§'},
      {code: 'G2', label: 'å°å­¦ äºŒå¹´çº§'},
      {code: 'G3', label: 'å°å­¦ ä¸‰å¹´çº§'},
      {code: 'G4', label: 'å°å­¦ å››å¹´çº§'},
      {code: 'G5', label: 'å°å­¦ äº”å¹´çº§'},
      {code: 'G6', label: 'å°å­¦ å…­å¹´çº§'},
      {code: 'G7', label: 'åˆä¸­ åˆä¸€'},
      {code: 'G8', label: 'åˆä¸­ åˆäºŒ'},
      {code: 'G9', label: 'åˆä¸­ åˆä¸‰'},
      {code: 'G10', label: 'é«˜ä¸­ é«˜ä¸€'},
      {code: 'G11', label: 'é«˜ä¸­ é«˜äºŒ'},
      {code: 'G12', label: 'é«˜ä¸­ é«˜ä¸‰'}
    ];

    const AVATAR_MAP = Object.fromEntries(AVATARS.map(a => [a.id, a]));
    const GRADE_MAP = Object.fromEntries(GRADES.map(g => [g.code, g.label]));

    const pageMeta = {
      'dashboard.html': {title: 'å®¶é•¿çœ‹æ¿'},
      'generate.html': {title: 'ç”Ÿæˆé»˜å†™å•'},
      'submit.html': {title: 'æäº¤ä¸Žæ‰¹æ”¹'},
      'practice.html': {title: 'ç»ƒä¹ å•ç®¡ç†'},
      'knowledge.html': {title: 'å­¦ä¹ åº“ç®¡ç†'},
      'library.html': {title: 'èµ„æ–™åº“ç»´æŠ¤'},
      'profile.html': {title: 'å­¦ç”Ÿç®¡ç†'}
    };

    const state = {
      students: [],
      bases: [],
      currentStudentId: null,
      currentBaseId: null,
      currentPage: 'dashboard.html'
    };

    function apiJSON(path, opts){
      return fetch(path, Object.assign({headers:{'Content-Type':'application/json'}}, opts || {}))
        .then(async res => {
          if(!res.ok){
            const data = await res.json().catch(() => ({}));
            throw new Error(data.detail || 'è¯·æ±‚å¤±è´¥');
          }
          return res.json();
        });
    }

    function getGradeLabel(code){
      if(!code) return 'æœªè®¾ç½®';
      return GRADE_MAP[code] || code;
    }

    function isCustomAvatar(value){
      return value && !AVATAR_MAP[value];
    }

    function getAvatarUrl(value){
      if(!value) return '';
      if(value.startsWith('http') || value.startsWith('/media/')){
        return value;
      }
      return `/media/${value}`;
    }

    function getBaseLabel(base){
      return base.custom_name || base.base_name || `èµ„æ–™åº“#${base.base_id || base.id}`;
    }

    function writeCfg(student, base){
      if(!student){
        localStorage.setItem('el_cfg', JSON.stringify({student_id: null}));
        return;
      }
      const cfg = {
        student_id: student.id,
        student_name: student.name,
        base_id: base ? base.base_id : null,
        base_name: base ? getBaseLabel(base) : '',
        grade_code: student.grade || ''
      };
      localStorage.setItem('el_cfg', JSON.stringify(cfg));
    }

    function renderMenu(){
      const menu = document.getElementById('menu');
      menu.innerHTML = '';
      const current = localStorage.getItem('el_app_page') || 'dashboard.html';
      menuItems.forEach(item => {
        const btn = document.createElement('button');
        btn.textContent = item.label;
        if(item.src === current){
          btn.classList.add('active');
        }
        btn.addEventListener('click', () => setPage(item.src));
        menu.appendChild(btn);
      });
      setPage(current, true);
    }

    function normalizePage(src){
      if(!src) return 'dashboard.html';
      const trimmed = src.split('?')[0].split('#')[0];
      const parts = trimmed.split('/');
      return parts[parts.length - 1] || 'dashboard.html';
    }

    function isLibraryPage(page){
      return page === 'library.html' || page === 'library-edit.html' || page === 'library-items.html';
    }

    function getCurrentPage(){
      const frame = document.getElementById('appFrame');
      try{
        if(frame && frame.contentWindow){
          return normalizePage(frame.contentWindow.location.pathname);
        }
      }catch(e){}
      return state.currentPage || normalizePage(localStorage.getItem('el_app_page') || 'dashboard.html');
    }

    function pageRequiresStudent(page){
      return page === 'generate.html' || page === 'knowledge.html';
    }

    function pageSupportsAll(page){
      return page === 'dashboard.html' || page === 'submit.html' || page === 'practice.html';
    }

    function updateTopbarForPage(src){
      const page = normalizePage(src);
      state.currentPage = page;
      const meta = pageMeta[page];
      const pageTitle = document.getElementById('pageTitle');
      const studentPicker = document.getElementById('studentPicker');
      const isProfile = page === 'profile.html';
      const isLibrary = page === 'library.html';
      if(pageTitle && meta){
        pageTitle.textContent = meta.title || '';
        pageTitle.classList.remove('hidden');
      }else if(pageTitle){
        pageTitle.classList.add('hidden');
      }
      if(studentPicker){
        const hidePicker = isProfile || isLibraryPage(page) || state.students.length === 0;
        studentPicker.classList.toggle('hidden', hidePicker);
        if(hidePicker){
          const cards = document.getElementById('studentCards');
          if(cards){
            cards.classList.add('hidden');
            cards.innerHTML = '';
          }
        }
      }
      const libraryCreateBtn = document.getElementById('libraryCreateBtn');
      const libraryImportBtn = document.getElementById('libraryImportBtn');
      if(libraryCreateBtn && libraryImportBtn){
        const showLibraryActions = isLibrary;
        libraryCreateBtn.classList.toggle('hidden', !showLibraryActions);
        libraryImportBtn.classList.toggle('hidden', !showLibraryActions);
      }
      const newBtn = document.getElementById('newStudentBtn');
      if(newBtn){
        newBtn.classList.toggle('hidden', !isProfile);
      }
    }

    function setPage(src, skipStore){
      const targetPage = normalizePage(src);
      if(pageRequiresStudent(targetPage) && state.currentStudentId === null){
        if((targetPage === 'generate.html' || targetPage === 'knowledge.html') && state.students.length){
          selectStudent(state.students[0].id, targetPage);
          return;
        }
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå­¦ç”Ÿ');
        return;
      }
      if(targetPage === 'dashboard.html'){
        if(state.currentStudentId === null){
          sessionStorage.setItem('dashboard_view', 'overview');
          sessionStorage.removeItem('dashboard_student_id');
        }else{
          sessionStorage.setItem('dashboard_view', 'student');
          sessionStorage.setItem('dashboard_student_id', String(state.currentStudentId));
        }
      }
      const frame = document.getElementById('appFrame');
      frame.src = src;
      updateTopbarForPage(src);
      if(!skipStore){
        localStorage.setItem('el_app_page', src);
      }
      document.querySelectorAll('.menu button').forEach(btn => {
        btn.classList.toggle('active', btn.textContent === menuItems.find(m => m.src === src)?.label);
      });
    }

    function notifyDashboardSelection(payload){
      const frame = document.getElementById('appFrame');
      if(!frame || !frame.contentWindow){
        return;
      }
      let page = '';
      try{
        page = normalizePage(frame.contentWindow.location.pathname);
      }catch(e){
        page = state.currentPage;
      }
      if(page !== 'dashboard.html'){
        return;
      }
      frame.contentWindow.postMessage(payload, '*');
    }

    async function loadStudents(){
      const res = await apiJSON('/api/students');
      state.students = res.students || [];
    }

    async function loadBases(studentId){
      const res = await apiJSON(`/api/students/${studentId}/learning-bases?is_active=true`);
      state.bases = res.learning_bases || [];
    }

    function setContextHint(message, showButton){
      const hint = document.getElementById('contextHint');
      if(!hint) return;
      if(!message){
        hint.textContent = '';
        return;
      }
      hint.innerHTML = '';
      const text = document.createElement('span');
      text.textContent = message;
      hint.appendChild(text);
      if(showButton){
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.style.marginLeft = '8px';
        btn.textContent = 'åŽ»æ·»åŠ èµ„æ–™åº“';
        btn.addEventListener('click', () => setPage('library.html'));
        hint.appendChild(btn);
      }
    }

    function renderStudentCards(){
      const cards = document.getElementById('studentCards');
      if(!cards) return;
      cards.innerHTML = '';
      const page = getCurrentPage();
      if(pageSupportsAll(page)){
        const allBtn = document.createElement('button');
        allBtn.type = 'button';
        allBtn.className = 'student-card';
        allBtn.dataset.id = 'all';
        if(state.currentStudentId === null){
          allBtn.classList.add('active');
        }
        const allAvatar = document.createElement('span');
        allAvatar.className = 'student-avatar';
        allAvatar.textContent = 'ALL';
        const allText = document.createElement('span');
        allText.className = 'student-text';
        const allName = document.createElement('span');
        allName.className = 'student-name';
        allName.textContent = 'å…¨éƒ¨å­¦ç”Ÿ';
        const allMeta = document.createElement('span');
        allMeta.className = 'student-grade';
        allMeta.textContent = 'æ¦‚è§ˆ';
        allText.appendChild(allName);
        allText.appendChild(allMeta);
        allBtn.appendChild(allAvatar);
        allBtn.appendChild(allText);
        allBtn.addEventListener('click', () => selectAllStudents());
        cards.appendChild(allBtn);
      }

      state.students.forEach(student => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'student-card';
        btn.dataset.id = String(student.id);
        if(student.id === state.currentStudentId){
          btn.classList.add('active');
        }

        const avatar = document.createElement('span');
        avatar.className = 'student-avatar';
        const avatarValue = student.avatar || 'rabbit';
        if(isCustomAvatar(avatarValue)){
          const img = document.createElement('img');
          img.src = getAvatarUrl(avatarValue);
          img.alt = student.name || 'å­¦ç”Ÿ';
          avatar.appendChild(img);
        }else{
          const meta = AVATAR_MAP[avatarValue] || AVATAR_MAP.rabbit;
          avatar.textContent = meta ? meta.emoji : 'ðŸ™‚';
        }

        const text = document.createElement('span');
        text.className = 'student-text';
        const name = document.createElement('span');
        name.className = 'student-name';
        name.textContent = student.name || 'å­¦ç”Ÿ';
        const grade = document.createElement('span');
        grade.className = 'student-grade';
        grade.textContent = getGradeLabel(student.grade || '');
        text.appendChild(name);
        text.appendChild(grade);

        btn.appendChild(avatar);
        btn.appendChild(text);
        btn.addEventListener('click', () => selectStudent(student.id));
        cards.appendChild(btn);
      });
    }

    function syncStudentPicker(){
      document.querySelectorAll('.student-card').forEach(card => {
        const rawId = card.dataset.id || '';
        if(rawId === 'all'){
          card.classList.toggle('active', state.currentStudentId === null);
          return;
        }
        const id = parseInt(rawId, 10);
        card.classList.toggle('active', id === state.currentStudentId);
      });
    }

    function renderStudentPicker(){
      const picker = document.getElementById('studentPicker');
      if(!picker) return;
      const page = state.currentPage || getCurrentPage();
      const hidePicker = page === 'profile.html' || isLibraryPage(page) || state.students.length === 0;
      picker.classList.toggle('hidden', hidePicker);
      if(hidePicker){
        return;
      }
      const cards = document.getElementById('studentCards');
      if(cards){
        cards.classList.remove('hidden');
      }
      renderStudentCards();
      syncStudentPicker();
    }

    async function selectStudent(studentId, targetPage){
      if(!studentId || studentId === state.currentStudentId){
        syncStudentPicker();
        return;
      }
      state.currentStudentId = studentId;
      sessionStorage.setItem('dashboard_view', 'student');
      sessionStorage.setItem('dashboard_student_id', String(studentId));
      notifyDashboardSelection({type: 'selectStudent', student_id: studentId});
      syncStudentPicker();
      await loadBases(state.currentStudentId);
      const student = state.students.find(s => s.id === state.currentStudentId);
      if(!student){
        return;
      }
      if(state.bases.length === 0){
        setContextHint('è¯¥å­¦ç”Ÿæš‚æ— èµ„æ–™åº“ï¼Œè¯·å…ˆæ·»åŠ èµ„æ–™åº“ã€‚', true);
        state.currentBaseId = null;
        writeCfg(student, null);
        setPage(targetPage || state.currentPage, !targetPage);
        return;
      }
      state.currentBaseId = state.bases[0].base_id;
      const base = state.bases.find(b => b.base_id === state.currentBaseId);
      writeCfg(student, base);
      setContextHint('');
      setPage(targetPage || state.currentPage, !targetPage);
    }

    function setAllStudentsState(){
      state.currentStudentId = null;
      state.currentBaseId = null;
      state.bases = [];
      writeCfg(null, null);
      setContextHint('');
      syncStudentPicker();
    }

    function selectAllStudents(){
      setAllStudentsState();
      sessionStorage.setItem('dashboard_view', 'overview');
      sessionStorage.removeItem('dashboard_student_id');
      notifyDashboardSelection({type: 'selectAllStudents'});
      const current = state.currentPage || getCurrentPage();
      if(pageSupportsAll(current)){
        setPage(current, true);
      }else{
        setPage('dashboard.html');
      }
    }

    async function init(){
      try{
        await apiJSON('/api/auth/me');
      }catch(e){
        window.location.href = '/login.html';
        return;
      }

      localStorage.setItem('el_app_page', 'dashboard.html');
      renderMenu();
      await loadStudents();

      if(state.students.length === 0){
        setContextHint('æš‚æ— å­¦ç”Ÿï¼Œè¯·å…ˆåœ¨å¼•å¯¼é¡µåˆ›å»ºã€‚', true);
        setPage('index.html');
        renderStudentPicker();
        return;
      }

      setAllStudentsState();
      renderStudentPicker();
    }

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch('/api/auth/logout', {method: 'POST'});
      window.location.href = '/login.html';
    });

    document.getElementById('newStudentBtn').addEventListener('click', () => {
      const frame = document.getElementById('appFrame');
      if(frame && frame.contentWindow){
        frame.contentWindow.postMessage({type: 'openCreateStudent'}, '*');
      }
    });

    document.getElementById('libraryCreateBtn').addEventListener('click', () => {
      const frame = document.getElementById('appFrame');
      if(frame && frame.contentWindow){
        frame.contentWindow.postMessage({type: 'openCreateBase'}, '*');
      }
    });

    document.getElementById('libraryImportBtn').addEventListener('click', () => {
      const frame = document.getElementById('appFrame');
      if(frame && frame.contentWindow){
        frame.contentWindow.postMessage({type: 'openImportBase'}, '*');
      }
    });

    document.getElementById('appFrame').addEventListener('load', () => {
      const frame = document.getElementById('appFrame');
      try{
        if(frame && frame.contentWindow){
          updateTopbarForPage(frame.contentWindow.location.pathname);
          renderStudentPicker();
        }
      }catch(e){}
    });

    window.addEventListener('message', (event) => {
      if(event.source !== document.getElementById('appFrame')?.contentWindow){
        return;
      }
      if(window.location.origin !== 'null' && event.origin !== window.location.origin){
        return;
      }
      const data = event.data || {};
      if(data.type === 'appPage' && data.page){
        updateTopbarForPage(data.page);
        renderStudentPicker();
        return;
      }
      if(data.type === 'selectStudent' && data.student_id){
        selectStudent(Number(data.student_id));
        return;
      }
      if(data.type === 'selectAllStudents'){
        selectAllStudents();
      }
    });

    init();
  </script>
</body>
</html>
