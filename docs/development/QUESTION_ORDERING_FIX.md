# 题目排序逻辑修复

## 问题背景

练习单通常包含两页内容，用户上传照片时可能：
1. 先上传第2页，再上传第1页（顺序乱）
2. 大题标题（"一、单词默写"）只出现在第一页
3. 题目编号跨页连续（第1页：1-15，第2页：16-24）

## 之前的问题

**旧代码逻辑**：
```python
# 按照 (page_index, position) 排序
items.sort(key=lambda x: (int(x.get("page_index") or 0), int(x.get("position") or 0)))
# 重新编号为 1, 2, 3...
for idx, it in enumerate(items, start=1):
    it["position"] = idx
```

**问题示例**：
- 用户先上传第2页（page_index=0，题号16-24）
- 再上传第1页（page_index=1，题号1-15）
- 排序后：第2页的题目排在前面
- 重新编号后：题号16→1，题号17→2，...，题号1→17

**结果**：题目顺序完全错乱，与练习单不符。

## 修复方案

### 核心思路
**只按题号排序，忽略上传顺序，保留原始编号**

### 代码修改

**1. 题号获取** (services.py:744)
```python
# 使用 LLM 识别的题号，如果缺失则用大数字排到最后
position = int(it.get("q") or 9000 + idx)
```

**2. 排序逻辑** (services.py:763)
```python
# 只按题号排序（忽略上传顺序）
# 这样即使用户乱序上传图片，题目也会按正确顺序排列
items.sort(key=lambda x: int(x.get("position") or 999))
```

**3. 移除重新编号**
不再执行 `it["position"] = idx`，保留 LLM 识别的原始题号。

## 工作原理

1. **LLM 识别题号**：从图片中读取题目前的数字（"1.尾巴"→q=1）
2. **独立处理每页**：每页的题目独立识别，携带原始题号
3. **全局排序**：合并所有页面的题目后，按题号排序
4. **保留原始编号**：不重新编号，允许题号不连续（学生跳题）

## 示例场景

### 场景1：乱序上传
**上传**：
- 图片1（page_index=0）：题号16-24（第2页）
- 图片2（page_index=1）：题号1-15（第1页）

**处理**：
1. LLM 识别：保留题号16-24和1-15
2. 排序：按题号排序 → 1, 2, ..., 15, 16, ..., 24
3. 显示：题目按正确顺序显示

### 场景2：学生跳题
**练习单**：题号1-20
**学生作答**：跳过了题号5和12

**处理**：
1. LLM 识别：1, 2, 3, 4, 6, 7, ..., 11, 13, ..., 20
2. 保留原始题号：显示为 1, 2, 3, 4, 6, 7, ...
3. 家长可以看到学生跳过了哪些题

### 场景3：多页大题
**第1页**：
- 一、单词默写（1-15）

**第2页**：
- 继续单词默写（16-20）
- 二、短语默写（21-28）

**处理**：
1. 识别section_title：题号1显示"一、单词默写"，题号21显示"二、短语默写"
2. 排序后：大题标题在正确位置显示
3. 即使乱序上传，结构也正确

## 技术要点

### 信任 LLM 的题号识别
- LLM 会读取题目前的数字（1. 2. 3. ...）
- 这个题号是全局的，不受分页影响
- 比图片上传顺序更可靠

### 允许题号不连续
- 学生可能跳过某些题目
- 题号不连续是正常现象
- 保留原始题号更能反映实际情况

### 容错处理
- 如果 LLM 未返回题号，使用 9000+idx 作为默认值
- 这样未识别的题目会排到最后，不影响正常题目

## 测试建议

### 测试用例1：正序上传
1. 上传第1页，再上传第2页
2. 验证题目顺序正确（1, 2, ..., 24）

### 测试用例2：倒序上传
1. 上传第2页，再上传第1页
2. 验证题目顺序仍正确（1, 2, ..., 24）

### 测试用例3：交叉上传
1. 上传第2页、第1页、第3页（如果有）
2. 验证题目按题号排序，不受上传顺序影响

### 测试用例4：跳题情况
1. 学生跳过了某些题目（如5、12）
2. 验证显示的题号与练习单一致（不会重新编号）

## 文件位置

**修改文件**：`backend/app/services.py`

**修改行号**：
- Line 744: 题号获取逻辑
- Line 763: 排序逻辑（移除重新编号）

## 兼容性

### 对前端的影响
- 无影响，前端仍然使用 `position` 字段显示题号
- 题号可能不连续（1, 2, 3, 6, 7...），这是预期行为

### 对数据库的影响
- `exercise_items.position` 字段保存原始题号
- `practice_results` 使用 `exercise_item_id` 关联，不受影响

## 总结

这个修复确保了：
✅ 题目顺序与练习单一致，不受上传顺序影响
✅ 跨页题目正确排序
✅ 大题标题在正确位置显示
✅ 学生跳题时保留原始题号
✅ LLM 识别失败时有容错机制

重启服务器后立即生效，无需额外配置。
